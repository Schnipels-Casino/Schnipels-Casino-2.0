<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>Friends Bank ‚Äì Mobile v3.9.7 (Login fast + Slots + Job 20√ó5)</title>
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#f6f8fc; --card:#ffffff; --muted:#566074; --text:#0f1624;
      --accent:#2dd36f; --accent2:#2563eb; --danger:#e11d48; --warn:#f59e0b;
      --outline:#e4e8f1; --pill:#eff3f9; --win:#16a34a; --loss:#dc2626;
      --shadow:0 8px 28px rgba(15,22,36,.08);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:17px;line-height:1.5;letter-spacing:.2px;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    .hidden{display:none!important}
    .row{display:flex;gap:.8rem;align-items:center}
    .col{display:flex;flex-direction:column;gap:.2rem}
    .between{justify-content:space-between}
    .center{justify-content:center;align-items:center}
    .container{max-width:880px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .btn{background:var(--pill);border:1px solid var(--outline);padding:1rem 1.15rem;border-radius:14px;min-width:48px;min-height:48px;font-weight:800;color:var(--text);cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.primary{background:var(--accent);color:#052010;border-color:#129454}
    .btn.warn{background:var(--warn);color:#231a00;border-color:#b07404}
    .btn.danger{background:#f43f5e;color:#2b0d0d;border-color:#d11a44}
    .btn.small{min-height:40px;padding:.5rem .8rem;border-radius:12px;font-weight:900}
    input,select{width:100%;background:#f2f5fb;color:var(--text);border:1px solid var(--outline);border-radius:12px;padding:1rem 1rem;font-size:18px}
    label{font-size:1rem;color:#24324a;font-weight:800}
    small{color:var(--muted);font-size:.98rem}
    ::placeholder{color:#6b7280;opacity:.9}

    /* TOPBAR */
    .topbar{position:sticky;top:0;z-index:50;background:#ffffffee;border-bottom:1px solid var(--outline);padding:.6rem .9rem;backdrop-filter:saturate(1.3) blur(6px);box-shadow:0 6px 18px rgba(15,22,36,.06)}
    .top-grid{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
    .left-wrap{display:flex;align-items:center;gap:.7rem;min-height:52px}
    .bank-name{font-weight:1000;font-size:1.05rem;line-height:1.1}
    .acct-line{font-weight:800;color:#0f172a}
    .circle{width:44px;height:44px;border-radius:999px;background:var(--pill);border:1px solid var(--outline);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;cursor:pointer}
    .icon-row{display:flex;gap:.5rem;align-items:center;justify-content:flex-end}
    .cash-amount{font-weight:900}
    #screen{padding:14px;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}

    .tabs{display:flex;gap:.6rem}
    .tab{flex:1;padding:.9rem;border:1px solid var(--outline);background:var(--pill);border-radius:12px;text-align:center;font-weight:900;cursor:pointer}
    .tab.active{background:var(--accent2);color:#fff;border-color:#1e4fd5}
    .section-title{font-size:1.2rem;font-weight:1000}
    .strip{display:flex;gap:.6rem;overflow:auto;padding-bottom:.2rem}
    .grid2{display:grid;grid-template-columns:1fr;gap:.8rem}
    .grid3{display:grid;grid-template-columns:1fr;gap:.8rem}
    .gridAuto{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.8rem}
    @media (min-width:720px){.grid2{grid-template-columns:1fr 1fr}.grid3{grid-template-columns:repeat(3,1fr)}}
    .toast{position:fixed;bottom:14px;left:0;right:0;margin:auto;max-width:560px;padding:1rem 1.1rem;border-radius:12px;background:#0f1624;color:#fff;border:1px solid #1f2a40;box-shadow:0 10px 30px rgba(15,22,36,.25);text-align:center;z-index:1200}

    footer.nav{position:fixed;left:0;right:0;bottom:0;padding:.6rem;background:#ffffffee;border-top:1px solid var(--outline);display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem;backdrop-filter:saturate(1.2) blur(6px);z-index:60}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(15,22,36,.12);backdrop-filter:blur(2px) saturate(1.1);z-index:1000}
    .sheet{width:100%;max-width:880px;background:var(--card);border:1px solid var(--outline);border-radius:18px;box-shadow:var(--shadow);margin:72px 12px 18px;overflow:hidden}
    .handle{width:46px;height:5px;background:#e5e7eb;border-radius:999px;margin:10px auto}

    .chat-bubble{padding:.6rem .8rem;border:1px solid var(--outline);border-radius:12px;background:var(--pill);margin-bottom:.6rem}
    .chat-bubble.mine{background:#e8f7ff;border-color:#3b82f6}

    /* JOB (20x5 = 100 Felder) */
    .job-grid{display:grid;grid-template-columns:repeat(20,34px);justify-content:center;gap:6px}
    .job-cell{width:34px;height:34px;border:2px solid var(--outline);border-radius:10px;background:#f3f4f6;box-shadow:var(--shadow);cursor:pointer;transition:transform .08s}
    .job-cell:active{transform:scale(0.98)}
    .job-cell.target{background:#d1fae5;border-color:#10b981}
    @keyframes burst{0%{opacity:1;transform:scale(1)}60%{opacity:.2;transform:scale(.7)}100%{opacity:0;transform:scale(.6)}}
    .job-cell.burst{animation:burst .18s ease-out}

    /* SLOTS */
    .slot-grid{display:grid;grid-template-columns:repeat(3,64px);grid-auto-rows:64px;gap:10px;justify-content:center;align-content:center}
    .slot-cell{display:flex;align-items:center;justify-content:center;border:2px solid var(--outline);border-radius:12px;background:#f2f6ff;font-size:28px;transition:transform .12s;box-shadow:var(--shadow)}
    .slot-cell.spin{transform:scale(1.05)}

    /* SHOP layout refinements */
    #toolList.gridAuto{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    #toolList .card{padding:14px}
    #toolList .tool-right{align-items:flex-end;width:140px}
    #toolList .tool-right .btn{width:100%;min-height:40px;padding:.5rem .8rem;border-radius:12px;font-size:14px}
  .modal.hidden{display:none!important;pointer-events:none!important}
</style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="top-grid">
        <div class="left-wrap">
          <button id="btnLogout" class="btn danger small">Logout</button>
          <div class="col">
            <div class="bank-name" id="bankLabel">‚Äî</div>
            <div class="acct-line money" id="acctBalance">‚Äî</div>
          </div>
        </div>
        <div class="icon-row">
          <div id="btnJob" class="circle" title="Job">üë∑</div>
          <div id="btnSlots" class="circle" title="Slots">üé∞</div>
          <div id="btnHouse" class="circle" title="H√§user">üè†</div>
          <div id="btnChat" class="circle" title="Chat">üí¨</div>
          <div id="btnShop" class="circle" title="Shop">üíµ</div>
          <div class="row" style="gap:.5rem">
            <div class="small" style="opacity:.9">üíµ</div>
            <div id="cashLabel" class="money cash-amount">‚Ç¨0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="screen" class="container">
    <div id="welcome" class="card">
      <div class="section-title">Willkommen üëã</div>
      <p>Tippe oben auf <b>üí∂</b>, w√§hle deine Bank & logge dich mit <b>Name + Passwort</b> ein.</p>
      <div class="grid2">
        <div class="card">
          <div class="section-title">T√§gliches Bonusgeld</div>
          <p>Jede Bank zahlt <b>‚Ç¨500 / Tag</b>. Startguthaben: <b>‚Ç¨1.500</b>.</p>
          <button id="btnClaimDaily" class="btn primary">‚Ç¨500 jetzt abholen</button>
        </div>
        <div class="card">
          <div class="section-title">Leihen & Kredit</div>
          <ul style="margin:.2rem 0 .2rem 1rem">
            <li>Leihen: <b>‚Ç¨1.000/Tag</b>, max. <b>‚Ç¨10.000</b>, <b>10% Geb√ºhr</b>.</li>
            <li>Kredit: bis <b>‚Ç¨100.000</b>, R√ºckzahlung in 1.000er-Schritten.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- BANK -->
    <div id="bankArea" class="card">
      <div class="section-title">Dein Konto</div>
      <div class="grid2">
        <div class="card">
          <div class="row between"><div>Kontostand</div><div class="money" id="bankBalance">‚Ç¨0</div></div>
          <div class="row between"><div>Leihe offen</div><div class="money" id="loanOutstanding">‚Ç¨0</div></div>
          <div class="row between"><div>Kredit offen</div><div class="money" id="creditOutstanding">‚Ç¨0</div></div>
        </div>
        <div class="card">
          <div class="row between"><div>Aktienkurs <span id="stockBankName" class="small"></span></div><div class="ticker" id="stockPrice">‚Äî</div></div>
          <div class="row between"><div>Deine Anteile</div><div id="userShares">0</div></div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <div class="section-title">Ein-/Auszahlen</div>
          <label>Betrag (‚Ç¨)</label>
          <input id="ioAmount" type="number" inputmode="numeric" min="1" placeholder="z.B. 50">
          <div class="row strip">
            <button class="btn" data-quick="20">+20</button>
            <button class="btn" data-quick="50">+50</button>
            <button class="btn" data-quick="100">+100</button>
            <button class="btn" data-quick="500">+500</button>
          </div>
          <div class="row grid2">
            <button id="btnDeposit" class="btn primary">Einzahlen ‚ûú</button>
            <button id="btnWithdraw" class="btn">‚¨Ö Auszahlen</button>
          </div>
          <small>Bargeld (üíµ) wird oben rechts angezeigt.</small>
        </div>
        <div class="card">
          <div class="section-title">Leihen & Kredit</div>
          <div class="row grid2">
            <button id="btnBorrow1000" class="btn">Leihen ‚Ç¨1.000</button>
            <button id="btnRepayLoan1000" class="btn">Leih-R√ºckzahlung ‚Ç¨1.000</button>
          </div>
          <div class="row grid2" style="margin-top:.4rem">
            <button id="btnTakeCredit" class="btn warn">Kredit nehmen</button>
            <button id="btnRepayCredit1000" class="btn">Kredit -‚Ç¨1.000</button>
          </div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <div class="section-title">Aktien handeln</div>
          <label>Menge (St√ºck)</label>
          <input id="sharesQty" type="number" min="1" step="1" placeholder="z.B. 10">
          <div class="row grid2">
            <button id="btnBuyShares" class="btn primary">Kaufen</button>
            <button id="btnSellShares" class="btn">Verkaufen</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Bank-Fonds</div>
          <div class="row between"><div>Bankverm√∂gen</div><div id="bankFunds" class="money">‚Äî</div></div>
          <small>Start: ‚Ç¨1.000.000.000. Eins√§tze erh√∂hen, Auszahlungen senken es.</small>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Verlauf</div>
        <div id="feed" class="mono" style="max-height:38vh;overflow:auto;white-space:pre-line"></div>
      </div>
    </div>

    <!-- SLOTS -->
    <div id="slotsArea" class="card hidden">
      <div class="section-title">Slots üé∞</div>
      <small>Eins√§tze: 5 / 10 / 30 / 50 / 80 / 100 ‚Ç¨ (vom Bargeld)</small>

      <div class="card">
        <div class="row between"><div class="section-title">High or Lower</div><div id="hlStatus"></div></div>
        <div class="grid3 center" style="gap:10px">
          <div class="card center" style="height:96px"><div id="hlDealer" class="section-title">üÇ†</div></div>
          <div class="card center" style="height:96px"><div id="hlYou" class="section-title">?</div></div>
          <div class="col">
            <select id="stakeHL"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
            <div class="row">
              <button id="btnHigher" class="btn" style="flex:1">H√∂her</button>
              <button id="btnLower"  class="btn" style="flex:1">Niedriger</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row between"><div class="section-title">Kopf oder Zahl</div><div id="cfStatus"></div></div>
        <div class="grid3 center" style="gap:10px">
          <div class="card center" style="height:96px"><div id="cfResult" class="section-title">ü™ô</div></div>
          <div class="col">
            <select id="stakeCF"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
            <select id="cfPick"><option value="kopf">Kopf</option><option value="zahl">Zahl</option></select>
          </div>
          <button id="btnCF" class="btn">Spielen</button>
        </div>
      </div>

      <div class="card">
        <div class="row between"><div class="section-title">Triple Chance</div><div id="tcStatus"></div></div>
        <div class="center" style="margin:.4rem 0">
          <div class="slot-grid" id="slotGrid">
            <div class="slot-cell">üçã</div><div class="slot-cell">üçí</div><div class="slot-cell">üçá</div>
            <div class="slot-cell">üçÄ</div><div class="slot-cell">‚≠ê</div><div class="slot-cell">üîî</div>
            <div class="slot-cell">7Ô∏è‚É£</div><div class="slot-cell">üçâ</div><div class="slot-cell">üçã</div>
          </div>
        </div>
        <div class="row center" style="gap:.6rem">
          <select id="stakeTC"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
          <button id="btnSpin" class="btn">Spin</button>
          <button id="btnAuto10" class="btn">Auto x10</button>
        </div>
      </div>

      <div class="card">
        <div class="row between"><div class="section-title">CS:GO-Kiste</div><div id="caseStatus"></div></div>
        <div class="row between"><small>ID:</small><code id="caseId">case_csg_001</code></div>
        <div class="row" style="gap:.6rem">
          <select id="stakeCASE"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
          <button id="btnBuyCase" class="btn">Kiste kaufen</button>
          <button id="btnOpenCase" class="btn primary" disabled>Kiste √∂ffnen</button>
        </div>
        <small>Der Einsatz geht in die Bankfonds. Gewinne werden aus den Bankfonds bezahlt.</small>
        <div id="casePrize" class="section-title" style="margin-top:.4rem"></div>
      </div>
    </div>

    <!-- JOB -->
    <div id="jobArea" class="card hidden">
      <div class="section-title">Job üë∑</div>
      <small>Triff das gr√ºn markierte Feld. Du hast <b>1:00</b> Minuten. Maximal 100 Treffer. <b>20‚Ç¨</b> Basislohn pro Treffer (+ Tool-Bonus). Einmal t√§glich.</small>
      <div class="row between" style="margin:.4rem 0">
        <div><b>Treffer:</b> <span id="jobHits">0</span> / 100</div>
        <div><b>Verdienst:</b> <span id="jobEarn">‚Ç¨0,00</span></div>
        <div><b>Zeit:</b> <span id="jobTime">01:00</span></div>
      </div>
      <div id="jobGrid" class="job-grid" style="margin:.4rem 0"></div>
      <div class="row" style="gap:.6rem">
        <button id="btnStartJob" class="btn primary">Job starten</button>
        <button id="btnEndJob" class="btn danger" disabled>Beenden</button>
      </div>
      <small id="jobHint"></small>
    </div>

    <!-- SHOP -->
    <div id="shopArea" class="card hidden">
      <div class="section-title">Shop ‚õèÔ∏è</div>
      <small>Kaufe Spitzhacken mit <b>Bargeld (üíµ)</b>. Der Betrag geht in die Bankfonds. Aktuelles Werkzeug wirkt auf den <b>Lohn pro Treffer</b>.</small>
      <div class="row" style="margin-top:.4rem;justify-content:flex-end"><div><b>Lohn/Schlag:</b> <span id="shopRate">‚Ç¨20</span></div></div>
      <div id="toolList" class="gridAuto" style="margin-top:.6rem"></div>
    </div>

    <!-- H√ÑUSER -->
    <div id="houseArea" class="card hidden">
      <div class="section-title">H√§user & Mieten üè†</div>
      <div class="gridAuto" id="houseList"></div>
      <div class="row between">
        <button id="btnCollectRent" class="btn primary" disabled>Tagesmieten einsammeln (Demo)</button>
        <small id="rentInfo"></small>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chatArea" class="card hidden">
      <div class="row tabs">
        <div id="tabGlobal" class="tab active">Global</div>
        <div id="tabPrivate" class="tab">Privat</div>
      </div>
      <div id="chatGlobal" class="col">
        <div id="globalList" style="max-height:38vh;overflow:auto"></div>
        <div class="row"><input id="globalMsg" placeholder="Nachricht an alle‚Ä¶"><button id="sendGlobal" class="btn primary">Senden</button></div>
      </div>
      <div id="chatPrivate" class="col hidden">
        <div class="row" style="gap:.6rem">
          <input id="pmTo" placeholder="Empf√§nger (Name)">
          <button id="btnFindUser" class="btn small" title="Spieler suchen">üîé</button>
        </div>
        <small id="pmFindHint"></small>
        <div id="privateList" style="max-height:38vh;overflow:auto"></div>
        <div class="row"><input id="privateMsg" placeholder="Deine private Nachricht‚Ä¶"><button id="sendPrivate" class="btn primary">Senden</button></div>
      </div>
    </div>
  </main>

  <footer class="nav">
    <div class="container" style="display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem">
      <button id="navBank"  class="btn">üí∂ Bank</button>
      <button id="navSlots" class="btn">üé∞ Slots</button>
      <button id="navHouse" class="btn">üè† H√§user</button>
      <button id="navChat"  class="btn">üí¨ Chat</button>
    </div>
  </footer>

  <!-- Bank Sheet -->
  <div id="sheetBank" class="modal" style="display:flex;align-items:flex-start">
    <div class="sheet">
      <div class="handle"></div>
      <div class="container" style="padding:10px 12px 18px">
        <div class="card bank-choice">
          <div class="section-title">Bank w√§hlen</div>
          <p>W√§hle genau <b>eine</b> Bank f√ºr dein Konto. Pro Name ist nur eine Bank erlaubt.</p>
          <div class="grid2">
            <button class="btn" data-bank="VR-Bank">VR-Bank</button>
            <button class="btn" data-bank="Deutsche Bank">Deutsche Bank</button>
            <button class="btn" data-bank="Sparkasse">Sparkasse</button>
            <button class="btn" data-bank="Postbank">Postbank</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Login / Registrierung</div>
          <label>Name</label><input id="loginName" placeholder="z.B. Julian">
          <label>Passwort</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          <div class="row between" style="gap:.6rem">
            <button id="btnLogin" class="btn primary" style="flex:1">Einloggen / Konto anlegen</button>
          </div>
          <small id="loginHint">Startguthaben: ‚Ç¨1.500. T√§glicher Bonus: ‚Ç¨500.</small>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  
<script>
(function(){
  const $ = s => document.querySelector(s);
  function openSheet(){ const m=$("#sheetBank"); if(!m) return; m.style.display="flex"; m.classList.remove("hidden"); }
  function closeSheet(){ const m=$("#sheetBank"); if(!m) return; m.style.display="none"; m.classList.add("hidden"); }
  function wire(){ const b=$("#btnBank"), c=$("#closeBank"); if(b) b.onclick=openSheet; if(c) c.onclick=closeSheet; }
  if(document.readyState==="loading"){ document.addEventListener("DOMContentLoaded", wire); } else { wire(); }
  window._openSheet=openSheet; window._closeSheet=closeSheet;
})();
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, orderBy, limit, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ---- Firebase ----
    const firebaseConfig = { apiKey: "AIzaSyArqwFEi1afYtkPTbGuA0PiwJsHmBuJhos", authDomain: "schnipels-casino.firebaseapp.com", projectId: "schnipels-casino", storageBucket: "schnipels-casino.firebasestorage.app", messagingSenderId: "233562090178", appId: "1:233562090178:web:520c0e28b295308527e95b" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- Helpers / State ----
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const EUR = n => "‚Ç¨" + (Math.round(n*100)/100).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const todayDE = () => new Date().toLocaleDateString("de-DE",{ timeZone:"Europe/Berlin" });
    const hash = async (s)=>{ const enc = new TextEncoder().encode(s); const buf = await crypto.subtle.digest("SHA-256", enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); };
    const showToast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"), 2200); };
    const logFeed = async (txt)=>{ $("#feed").prepend("‚Ä¢ "+txt+"\\n"); if (state.userDoc) await addDoc(collection(db, "users", state.userDoc.id, "feed"), { txt, at: serverTimestamp() }); };
    const state = { bank:null, user:null, userDoc:null, bankDoc:null, listeners:[], authed:false };

    // ---------- AUTH (fast with fallback) ----------
    const auth = getAuth(app);
    let authUser = null;
    async function ensureAuth(){
      if (state.authed && auth.currentUser) return authUser;
      if (ensureAuth._p) return ensureAuth._p;
      ensureAuth._p = new Promise(async (resolve)=>{
        let unsub=null, resolved=false;
        function finish(u){
          if (resolved) return;
          resolved=true;
          authUser = u;
          state.authed = !!u;
          if (unsub) try{unsub();}catch{}
          resolve(u);
        }
        try{
          await setPersistence(auth, browserLocalPersistence);
          unsub = onAuthStateChanged(auth, (u)=> finish(u));
          if (!auth.currentUser){
            try{ await signInAnonymously(auth); }catch(e){ console.warn("signInAnonymously", e?.message||e); }
          }
          setTimeout(()=> finish(auth.currentUser||null), 3000);
        }catch(e){
          console.error(e);
          showToast("Auth-Fehler: "+(e?.message||""));
          finish(null);
        }finally{
          ensureAuth._p = null;
        }
      });
      return ensureAuth._p;
    }
    ensureAuth();

    // ---------- UI refs ----------
    const bankSheet = $("#sheetBank"), bankLabel=$("#bankLabel"), bankBalance=$("#bankBalance"), cashLabel=$("#cashLabel"), acctBalance=$("#acctBalance"), stockPriceEl=$("#stockPrice"), stockBankName=$("#stockBankName"), bankFundsEl=$("#bankFunds"), userSharesEl=$("#userShares");
    const openSheet = ()=> bankSheet.style.display = "flex";
    const closeSheet = ()=> bankSheet.style.display = "none";
    setTimeout(()=>showToast("Tipp: W√§hle deine Bank & logge dich ein."), 600);

    // Logout
    $("#btnLogout").onclick = ()=>{ state.listeners.forEach(u=>u()); state.listeners=[]; state.user=null; state.userDoc=null; openSheet(); };

    // Bank choice
    $$("#sheetBank [data-bank]").forEach(btn=>{
      btn.onclick = async ()=>{
        $$("#sheetBank [data-bank]").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        state.bank = btn.dataset.bank;
        bankLabel.textContent = state.bank;
        stockBankName.textContent = "("+state.bank+")";
        $("#loginHint").textContent = "Ausgew√§hlt: "+state.bank+" ‚Äì Startguthaben: ‚Ç¨1.500, Bonus: ‚Ç¨500/Tag.";
        await ensureAuth();
        await ensureBankDoc();
        await ensureTicker();
      };
    });

    // Login
    $("#btnLogin").onclick = async ()=>{
      const name = $("#loginName").value.trim();
      const pass = $("#loginPass").value;
      if (!state.bank){ showToast("Bitte zuerst eine Bank w√§hlen."); return; }
      if (name.length<2 || pass.length<3){ showToast("Name/Passwort zu kurz."); return; }

      const btn = $("#btnLogin"); btn.disabled = true; const oldTxt = btn.textContent; btn.textContent = "Bitte warten‚Ä¶";
      const _guard = setTimeout(()=>{ try{ btn.disabled=false; btn.textContent=oldTxt; }catch{} showToast("Login dauert zu lange ‚Äì bitte Verbindung pr√ºfen und erneut versuchen."); }, 8000);
      try{
        await ensureAuth();
        const uname = name.toLowerCase();
        const passHash = await hash(pass);

        const idxRef = doc(db, "users_index", uname);
        const idxSnap = await getDoc(idxRef);
        if (idxSnap.exists() && idxSnap.data().bank !== state.bank){
          showToast(`Name bereits in ${idxSnap.data().bank} registriert.`);
          return;
        }

        const userId = `${state.bank.replaceAll(" ","")}_${uname}`;
        const userRef = doc(db, "users", userId);
        const snap = await getDoc(userRef);

        if (!snap.exists()){
          const init = { bank: state.bank, name, passHash, createdAt: serverTimestamp(), bankBalance: 1500, cash: 0, lastDaily: "", lastBorrow: "", loanOutstanding: 0, creditOutstanding: 0, lastRent: "", shares: 0, jobTool: 0, lastJob: "" };
          await setDoc(userRef, init);
          /* users_index write entfernt */
          showToast("Konto erstellt. Willkommen!");
        }else{
          const data = snap.data();
          if (data.passHash !== passHash){ showToast("Falsches Passwort."); return; }
          try{ if (!data.owner) await updateDoc(userRef, { owner: authUser?.uid || null }); }catch(_e){}
        }
        await attachUser(userRef);
        closeSheet();
        await logFeed("Angemeldet bei "+state.bank+".");
      }catch(err){ console.error(err); showToast("Login-Fehler: "+(err?.message||"Unbekannt")); }
      finally{ try{ clearTimeout(_guard); }catch{} btn.disabled = false; btn.textContent = oldTxt; }
    };

    async function attachUser(userRef){
      state.listeners.forEach(u=>u()); state.listeners=[];
      state.userDoc = userRef;
      const unsub = onSnapshot(userRef, (d)=>{
        const u = d.data(); if (!u) return;
        state.user = { id:d.id, ...u };
        bankBalance.textContent = EUR(u.bankBalance||0);
        acctBalance.textContent = EUR(u.bankBalance||0);
        cashLabel.textContent = EUR(u.cash||0);
        $("#loanOutstanding").textContent = EUR(u.loanOutstanding||0);
        $("#creditOutstanding").textContent = EUR(u.creditOutstanding||0);
        userSharesEl.textContent = (u.shares||0);
        $("#rentInfo").textContent = u.lastRent ? ("Letzte Miete: "+u.lastRent) : "Noch keine Miete kassiert";
        renderHouses(u); renderShop(u);
        const t=todayDE();
        if (btnStartJob) btnStartJob.disabled = (u.lastJob||"")===t;
        jobHint.textContent = btnStartJob.disabled ? "Heute erledigt ‚Äì ab 00:00 wieder verf√ºgbar." : "";
        state.user.jobToolBonus = toolById(u.jobTool||0).bonus||0;
      });
      state.listeners.push(unsub);
      await ensureBankDoc(); await ensureTicker(); await loadFeed(); attachChat();
    }

    async function ensureBankDoc(){
      if (!state.bank) return;
      await ensureAuth();
      const id = state.bank.replaceAll(" ","");
      const bRef = doc(db, "banks", id);
      const snap = await getDoc(bRef);
      if (!snap.exists()){
        await setDoc(bRef, { name: state.bank, funds: 1_000_000_000, stockPrice: 100, lastStockUpdate: Date.now() });
      }
      state.bankDoc = bRef;
      const unsub = onSnapshot(bRef, (d)=>{
        const b = d.data(); if (!b) return;
        bankFundsEl.textContent = EUR(b.funds||0);
        stockPriceEl.textContent = EUR(b.stockPrice||0);
      });
      state.listeners.push(unsub);
    }
    async function ensureTicker(){
      if (!state.bankDoc) return;
      await ensureAuth();
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(state.bankDoc);
          const b = snap.data(); if (!b) return;
          const now = Date.now();
          if ((now - (b.lastStockUpdate||0)) < 12000) return;
          const dir = Math.random()<.5?-1:1;
          const pct = (0.004 + Math.random()*0.008) * dir;
          const next = Math.max(5, Math.round(b.stockPrice * (1+pct)*100)/100);
          tx.update(state.bankDoc, { stockPrice: next, lastStockUpdate: now });
        });
      }catch(e){}
    }
    setInterval(ensureTicker, 12_500);

    async function loadFeed(){
      if (!state.userDoc) return;
      const q = query(collection(db, "users", state.userDoc.id, "feed"), orderBy("at","desc"), limit(50));
      onSnapshot(q, (qs)=>{ const el = $("#feed"); el.textContent = ""; qs.forEach(doc=> el.append("‚Ä¢ "+doc.data().txt+"\\n") ); });
    }

    $$("#ioAmount ~ .strip .btn").forEach(b=> b.onclick = ()=>{ const v = Number($("#ioAmount").value||0) + Number(b.dataset.quick||0); $("#ioAmount").value = v; });

    async function txUpdate(cb){ await ensureAuth(); return await runTransaction(db, cb); }

    // Ein-/Auszahlen
    $("#btnDeposit").onclick = async ()=>{
      try{
        if (!state.userDoc) return openSheet();
        const amount = Number($("#ioAmount").value||0); if (amount<=0) return;
        await txUpdate(async(tx)=>{
          const u = await tx.get(state.userDoc); const ud = u.data();
          if ((ud.cash||0) < amount) throw new Error("Zu wenig Bargeld.");
          tx.update(state.userDoc, { cash: (ud.cash||0)-amount, bankBalance: (ud.bankBalance||0)+amount });
        });
        showToast("Einzahlung: "+EUR(amount)); await logFeed("Einzahlung "+EUR(amount)); $("#ioAmount").value="";
      }catch(e){ showToast(e.message||"Fehler"); }
    };
    $("#btnWithdraw").onclick = async ()=>{
      try{
        if (!state.userDoc) return openSheet();
        const amount = Number($("#ioAmount").value||0); if (amount<=0) return;
        await txUpdate(async(tx)=>{
          const u = await tx.get(state.userDoc); const ud = u.data();
          if ((ud.bankBalance||0) < amount) throw new Error("Zu wenig Guthaben.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-amount, cash:(ud.cash||0)+amount });
        });
        showToast("Auszahlung: "+EUR(amount)); await logFeed("Auszahlung "+EUR(amount)+" (Bargeld erh√∂ht)"); $("#ioAmount").value="";
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    // Bonus / Leihe / Kredit
    $("#btnClaimDaily").onclick = async ()=>{
      if (!state.userDoc){ openSheet(); return; }
      try{
        await ensureAuth();
        const today = todayDE();
        const uSnap = await getDoc(state.userDoc);
        const u = uSnap.data();
        if (u.lastDaily === today){ showToast("Heute schon abgeholt."); return; }
        await updateDoc(state.userDoc, { bankBalance: (u.bankBalance||0)+500, lastDaily: today });
        await logFeed("Tagesbonus +‚Ç¨500"); showToast("Tagesbonus +‚Ç¨500");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnBorrow1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const today = todayDE();
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if (ud.lastBorrow === today) throw new Error("Heute schon geliehen.");
          if ((ud.loanOutstanding||0) >= 10_000) throw new Error("Leih-Limit erreicht (10.000‚Ç¨).");
          const fee = 100;
          const newLoan = (ud.loanOutstanding||0) + 1000 + fee;
          tx.update(state.userDoc, { loanOutstanding: newLoan, bankBalance: (ud.bankBalance||0) + 1000, lastBorrow: today });
          tx.update(state.bankDoc, { funds: (bd.funds||0) + fee });
        });
        await logFeed("Leihe +‚Ç¨1.000 (10% Geb√ºhr)"); showToast("Leihe +‚Ç¨1.000 (Geb√ºhr ‚Ç¨100)");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnRepayLoan1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.loanOutstanding||0) <= 0) throw new Error("Keine Leihe offen.");
          if ((ud.bankBalance||0) < 1000) throw new Error("Zu wenig Guthaben.");
          const repay = Math.min(1000, ud.loanOutstanding);
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0) - repay, loanOutstanding:(ud.loanOutstanding||0) - repay });
          tx.update(state.bankDoc, { funds:(bd.funds||0) + repay });
        });
        await logFeed("Leih-R√ºckzahlung -‚Ç¨1.000"); showToast("Leih-R√ºckzahlung -‚Ç¨1.000");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnTakeCredit").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const amt = Number(prompt("Kredit-Betrag (max. 100.000‚Ç¨):","10000")||0);
      if (!amt || amt<=0) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.creditOutstanding||0) + amt > 100_000) throw new Error("Kredit-Limit 100.000‚Ç¨.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+amt, creditOutstanding:(ud.creditOutstanding||0)+amt });
          tx.update(state.bankDoc, { funds:(bd.funds||0) - amt });
        });
        await logFeed("Kredit aufgenommen: "+EUR(amt)); showToast("Kredit aufgenommen: "+EUR(amt));
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnRepayCredit1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.creditOutstanding||0)<=0) throw new Error("Kein Kredit offen.");
          if ((ud.bankBalance||0) < 1000) throw new Error("Zu wenig Guthaben.");
          const pay = Math.min(1000, ud.creditOutstanding);
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-pay, creditOutstanding:(ud.creditOutstanding||0)-pay });
          tx.update(state.bankDoc, { funds:(bd.funds||0) + pay });
        });
        await logFeed("Kredit-R√ºckzahlung -‚Ç¨1.000"); showToast("Kredit-R√ºckzahlung -‚Ç¨1.000");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    // Aktien
    $("#btnBuyShares").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const qty = Math.trunc(Number($("#sharesQty").value||0));
      if (!Number.isFinite(qty) || qty<=0){ showToast("Bitte g√ºltige St√ºckzahl eingeben."); return; }
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc);
          const b = await tx.get(state.bankDoc);
          const ud = u.data();
          const bd = b.data();
          const price = (bd.stockPrice||100);
          const cost = Math.round(price*qty*100)/100;
          if ((ud.bankBalance||0) < cost) throw new Error("Zu wenig Guthaben.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-cost, shares:(ud.shares||0)+qty });
          tx.update(state.bankDoc,  { funds:(bd.funds||0)+cost });
        });
        await logFeed("Aktienkauf: +"+qty+" Stk."); showToast("Gekauft: "+qty+" Stk.");
      }catch(e){ showToast(e.message||"Fehler"); }
    };
    $("#btnSellShares").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const qty = Math.trunc(Number($("#sharesQty").value||0));
      if (!Number.isFinite(qty) || qty<=0){ showToast("Bitte g√ºltige St√ºckzahl eingeben."); return; }
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc);
          const b = await tx.get(state.bankDoc);
          const ud = u.data();
          const bd = b.data();
          const price = (bd.stockPrice||100);
          if ((ud.shares||0) < qty) throw new Error("Nicht genug Anteile.");
          const proceeds = Math.round(price*qty*100)/100;
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+proceeds, shares:(ud.shares||0)-qty });
          tx.update(state.bankDoc,  { funds:(bd.funds||0)-proceeds });
        });
        await logFeed("Aktienverkauf: -"+qty+" Stk."); showToast("Verkauft: "+qty+" Stk.");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    // H√§user (Demo)
    const HOUSES = [
      { id:"h1", name:"Klein Familien Haus", price:50_000, rent:2_500 },
      { id:"h2", name:"Mittel Familien Haus", price:75_000, rent:4_000 },
      { id:"h3", name:"Gro√ü Familien Haus", price:100_000, rent:6_000 },
      { id:"h4", name:"Dubai Villa", price:450_000, rent:15_000 },
      { id:"h5", name:"Luxus Villa", price:1_000_000, rent:50_000 }
    ];
    function renderHouses(u){ const wrap=$("#houseList"); wrap.innerHTML=""; HOUSES.forEach(h=>{ const owned=(u && u["own_"+h.id])||0; const el=document.createElement("div"); el.className="card"; el.innerHTML=`<div class="section-title">${h.name}</div><div class="row between"><small>Preis</small><b>${EUR(h.price)}</b></div><div class="row between"><small>Miete/Tag</small><b>${EUR(h.rent)}</b></div><div class="row between"><small>Besitz</small><b>${owned}</b></div><div class="row grid2" style="margin-top:.4rem"><button class="btn" data-buy="${h.id}">Kaufen</button><button class="btn" data-sell="${h.id}" ${owned?"":"disabled"}>Verkaufen</button></div>`; wrap.appendChild(el); }); $$("#houseList [data-buy]").forEach(b=> b.onclick = ()=> buyHouse(b.dataset.buy)); $$("#houseList [data-sell]").forEach(b=> b.onclick = ()=> sellHouse(b.dataset.sell)); }
    async function buyHouse(hid){ if (!state.userDoc) return openSheet(); const h=HOUSES.find(x=>x.id===hid); if(!h) return; try{ await txUpdate(async(tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud.bankBalance||0)<h.price) throw new Error("Zu wenig Guthaben."); const patch={}; patch["own_"+hid]=(ud["own_"+hid]||0)+1; tx.update(state.userDoc, Object.assign(patch,{bankBalance:(ud.bankBalance||0)-h.price})); tx.update(state.bankDoc,{funds:(bd.funds||0)+h.price}); }); await logFeed("Gekauft: "+h.name+" f√ºr "+EUR(h.price)); showToast("Gekauft: "+h.name);}catch(e){ showToast(e.message||"Fehler"); }}
    async function sellHouse(hid){ if (!state.userDoc) return openSheet(); const h=HOUSES.find(x=>x.id===hid); if(!h) return; try{ await txUpdate(async(tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud["own_"+hid]||0)<=0) throw new Error("Kein Besitz."); const patch={}; patch["own_"+hid]=(ud["own_"+hid]||0)-1; const refund=Math.round(h.price*0.8); tx.update(state.userDoc, Object.assign(patch,{bankBalance:(ud.bankBalance||0)+refund})); tx.update(state.bankDoc,{funds:(bd.funds||0)-refund}); }); await logFeed("Verkauft: "+h.name+" f√ºr "+EUR(h.price*0.8)); showToast("Verkauft: "+h.name);}catch(e){ showToast(e.message||"Fehler"); }}

    // ---- Chat ----
    function attachChat(){
      const qg = query(collection(db,"messages"), orderBy("at","desc"), limit(100));
      onSnapshot(qg, (qs)=>{
        const box = $("#globalList"); box.innerHTML="";
        qs.forEach(d=>{ const m=d.data(); if(m.bank===state.bank && m.type==="global"){ const div=document.createElement("div"); div.className="chat-bubble "+(m.from===state.user?.name?"mine":""); div.innerHTML=`<b>${m.from}</b><br>${m.text||""}`; box.appendChild(div);} });
      });
      if (state.user){
        const qp = query(collection(db,"messages"), orderBy("at","desc"), limit(200));
        onSnapshot(qp, (qs)=>{
          const box = $("#privateList"); box.innerHTML="";
          qs.forEach(d=>{ const m=d.data(); if (m.bank===state.bank && m.type==="private" && (m.from===state.user?.name || m.to===state.user?.name)){ const div=document.createElement("div"); div.className="chat-bubble "+(m.from===state.user?.name?"mine":""); div.innerHTML=`<b>${m.from} ‚ûú ${m.to}</b><br>${m.text||""}`; box.appendChild(div); } });
        });
      }
    }
    $("#sendGlobal").onclick = async ()=>{ const text=$("#globalMsg").value.trim(); if (!text) return; try{ if (!state.userDoc) return openSheet(); await ensureAuth(); await addDoc(collection(db,"messages"), { bank: state.bank, type:"global", text, from: state.user?.name||"?", at: serverTimestamp() }); $("#globalMsg").value=""; }catch(e){ showToast(e.message||"Fehler"); } };
    $("#sendPrivate").onclick = async ()=>{ const to=$("#pmTo").value.trim(); const text=$("#privateMsg").value.trim(); if (!to||!text) return; try{ if (!state.userDoc) return openSheet(); await ensureAuth(); await addDoc(collection(db,"messages"), { bank: state.bank, type:"private", to, text, from: state.user?.name||"?", at: serverTimestamp() }); $("#privateMsg").value=""; }catch(e){ showToast(e.message||"Fehler"); } };

    $("#tabGlobal").onclick = ()=>{ $("#tabGlobal").classList.add("active"); $("#tabPrivate").classList.remove("active"); $("#chatGlobal").classList.remove("hidden"); $("#chatPrivate").classList.add("hidden"); };
    $("#tabPrivate").onclick = ()=>{ $("#tabPrivate").classList.add("active"); $("#tabGlobal").classList.remove("active"); $("#chatPrivate").classList.remove("hidden"); $("#chatGlobal").classList.add("hidden"); };

    // User search
    async function findUserByName(nameLower){ try{ const userId = `${state.bank.replaceAll(" ","")}_${nameLower}`; const ref = doc(db,"users",userId); const s = await getDoc(ref); return s.exists()?s.data():null; }catch(e){ return null; } }
    const pmFindHint = $("#pmFindHint");
    const btnFind = $("#btnFindUser");
    if (btnFind){ btnFind.onclick = async ()=>{ const input=$("#pmTo"); const nameRaw=(input.value||"").trim(); const name=nameRaw.toLowerCase(); if (!name){ showToast("Bitte einen Namen eingeben."); return; } try{ await ensureAuth(); const data=await findUserByName(name); pmFindHint.textContent = data ? `‚úÖ Spieler gefunden in ${data.bank}` : `‚ùå Kein Spieler "${nameRaw}" gefunden.`; }catch(e){ pmFindHint.textContent = "Suche fehlgeschlagen."; } }; }

    // ----------- Bereich Navigation -----------
    function showArea(id){
      ["bankArea","slotsArea","houseArea","chatArea","jobArea","shopArea"].forEach(x=> { const el=$("#"+x); if(el) el.classList.add("hidden"); });
      const target=$("#"+id); if (target) target.classList.remove("hidden");
    }
    function requireLoginThen(areaId){
      if (!state.userDoc){ openSheet(); showToast("Bitte zuerst einloggen."); return; }
      showArea(areaId);
    }
    $("#navBank").onclick  = ()=> showArea("bankArea");
    $("#navSlots").onclick = ()=> requireLoginThen("slotsArea");
    $("#navHouse").onclick = ()=> requireLoginThen("houseArea");
    $("#navChat").onclick  = ()=> requireLoginThen("chatArea");
    $("#btnSlots").onclick = ()=> requireLoginThen("slotsArea");
    $("#btnHouse").onclick = ()=> requireLoginThen("houseArea");
    $("#btnChat").onclick  = ()=> requireLoginThen("chatArea");
    $("#btnJob").onclick   = ()=> requireLoginThen("jobArea");
    $("#btnShop").onclick  = ()=> requireLoginThen("shopArea");

    // ------- Slots helpers & games -------
    const SYMBOLS = ["üçã","üçí","üçá","üçÄ","‚≠ê","üîî","7Ô∏è‚É£","üçâ"];
    const stakes = [5,10,30,50,80,100];
    const SLOT_MIN_INTERVAL = 2000;
    let lastSlotAction = 0;
    function parseStake(selId){ return stakes.includes(Number($(selId).value)) ? Number($(selId).value) : 5; }
    function slotGuard() {
      const now = Date.now();
      const diff = now - lastSlotAction;
      if (diff < SLOT_MIN_INTERVAL) {
        const wait = Math.ceil((SLOT_MIN_INTERVAL - diff) / 1000);
        showToast(`Bitte noch ${wait}s warten‚Ä¶`);
        return false;
      }
      lastSlotAction = now;
      return true;
    }
    function setSlotsDisabled(disabled) {
      ["#btnHigher","#btnLower","#btnCF","#btnSpin","#btnAuto10","#btnBuyCase","#btnOpenCase"]
        .forEach(sel => { const el = document.querySelector(sel); if (el) el.disabled = disabled; });
    }
    function quickStatus(el, text) { if (el) { el.textContent = text; setTimeout(()=>{ if (el.textContent===text) el.textContent=""; }, 1200); } }
    async function spendCash(amount){ if (!state.userDoc) return openSheet(); await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud.cash||0)<amount) throw new Error("Zu wenig Bargeld. Bitte auszahlen."); tx.update(state.userDoc,{cash:(ud.cash||0)-amount}); tx.update(state.bankDoc,{funds:(bd.funds||0)+amount}); }); }
    async function payoutCash(amount){ if (!state.userDoc) return openSheet(); await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); tx.update(state.userDoc,{cash:(ud.cash||0)+amount}); tx.update(state.bankDoc,{funds:(bd.funds||0)-amount}); }); }

    // High/Lower
    let hlBusy=false;
    $("#btnHigher") && ($("#btnHigher").onclick = ()=> { if (!slotGuard()) return; playHL("higher"); });
    $("#btnLower")  && ($("#btnLower").onclick  = ()=> { if (!slotGuard()) return; playHL("lower");  });
    async function playHL(choice){
      if (hlBusy || !state.userDoc) { if (!state.userDoc) openSheet(); return; }
      hlBusy = true;
      setSlotsDisabled(true);
      quickStatus($("#hlStatus"), "‚Ä¶ wird gepr√ºft");
      const stake = parseStake("#stakeHL");
      try{
        await spendCash(stake);
        const dealer = 1+Math.floor(Math.random()*13);
        const you    = 1+Math.floor(Math.random()*13);
        $("#hlDealer").textContent = cardEmoji(dealer);
        $("#hlYou").textContent = cardEmoji(you);
        const win = choice==="higher" ? you>dealer : you<dealer;
        if (win){ await payoutCash(stake*2); $("#hlStatus").innerHTML = `<span style="color:var(--win)">Gewinn ${EUR(stake*2)}</span>`; await logFeed(`High/Lower Gewinn: ${EUR(stake)}`); }
        else    { $("#hlStatus").innerHTML = `<span style="color:var(--loss)">Verlust ${EUR(stake)}</span>`; await logFeed(`High/Lower Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#hlStatus").textContent="", 1500);
      }catch(e){ showToast(e.message||"Fehler"); }
      hlBusy=false;
      setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL);
    }
    function cardEmoji(v){ const faces = {1:"A",11:"J",12:"Q",13:"K"}; return "üÇ†"+(faces[v]||String(v)); }

    // Coinflip
    let cfBusy=false;
    $("#btnCF") && ($("#btnCF").onclick = async ()=>{
      if (!slotGuard()) return;
      if (cfBusy){ return; }
      if (!state.userDoc){ openSheet(); return; }
      cfBusy=true;
      quickStatus($("#cfStatus"), "‚Ä¶ wird geworfen");
      setSlotsDisabled(true);
      const stake = parseStake("#stakeCF");
      try{
        await spendCash(stake);
        const pick = $("#cfPick").value;
        const res = Math.random()<.5?"kopf":"zahl";
        $("#cfResult").textContent = res==="kopf"?"üôÇ":"ü™ô";
        if (pick===res){ await payoutCash(stake*2); $("#cfStatus").innerHTML = `<span style="color:var(--win)">Gewinn ${EUR(stake*2)}</span>`; await logFeed(`Kopf/Zahl Gewinn: ${EUR(stake)}`); }
        else            { $("#cfStatus").innerHTML = `<span style="color:var(--loss)">Verlust ${EUR(stake)}</span>`; await logFeed(`Kopf/Zahl Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#cfStatus").textContent="", 1500);
      }catch(e){ showToast(e.message||"Fehler"); }
      cfBusy=false;
      setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL);
    });

    // Triple Chance
    $("#btnSpin") && ($("#btnSpin").onclick = ()=>{
      if (!slotGuard()) return;
      quickStatus($("#tcStatus"), "‚Ä¶ dreht");
      setSlotsDisabled(true);
      spinOnce().finally(()=> setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL));
    });
    $("#btnAuto10") && ($("#btnAuto10").onclick = async ()=>{
      if (!slotGuard()) return;
      if (!state.userDoc){ openSheet(); return; }
      setSlotsDisabled(true);
      for (let i=0;i<10;i++){ await spinOnce(true); await sleep(160); }
      setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL);
    });
    async function spinOnce(fromAuto=false){
      if (!state.userDoc){ openSheet(); return; }
      const stake = parseStake("#stakeTC");
      try{
        if (!fromAuto) quickStatus($("#tcStatus"), "‚Ä¶ dreht");
        await spendCash(stake);
        const grid = $("#slotGrid").children;
        const picks=[];
        for (let i=0;i<9;i++){ const sym = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]; picks.push(sym); }
        for (let i=0;i<9;i++){ grid[i].classList.add("spin"); grid[i].textContent = picks[i]; await sleep(45); grid[i].classList.remove("spin"); }
        const lines=[[0,1,2],[3,4,5],[6,7,8],[0,4,8],[6,4,2]];
        let wins=0; lines.forEach(L=>{ if (picks[L[0]]===picks[L[1]] && picks[L[1]]===picks[L[2]]) wins++; });
        if (wins>0){ const payout = stake*3*wins; await payoutCash(payout); $("#tcStatus").textContent = `Gewinn ${EUR(payout)} (${wins} Linie${wins>1?"n":""})`; await logFeed(`TripleChance Gewinn: ${EUR(payout)} (${wins} Linien)`); }
        else { $("#tcStatus").textContent = `Verlust ${EUR(stake)}`; await logFeed(`TripleChance Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#tcStatus").textContent="", 1400);
      }catch(e){ showToast(e.message||"Fehler"); }
    }

    // CS:GO CASE (must buy before open)
    const CASE_ID = "case_csg_001";
    $("#caseId") && ($("#caseId").textContent = CASE_ID);
    const CASE_LOOT = [
      { name:"Graues Item",  weight:62, multiplier:0.0 },
      { name:"Blaues Item",  weight:28, multiplier:1.2 },
      { name:"Lila Item",    weight:7.5, multiplier:2.5 },
      { name:"Pink Item",    weight:2.0, multiplier:5.0 },
      { name:"Rotes Item",   weight:0.45, multiplier:12.0 },
      { name:"Gold (Knife)", weight:0.05, multiplier:48.0 },
    ];
    function stakeCase(){ return parseStake("#stakeCASE"); }
    function pickWeighted(){
      const total = CASE_LOOT.reduce((s,x)=>s+x.weight,0);
      let r = Math.random()*total;
      for(const it of CASE_LOOT){ if((r-=it.weight)<=0) return it; }
      return CASE_LOOT[0];
    }
    let hasCase = false;
    async function buyCase(){
      if (!state.userDoc) return openSheet();
      const stake = stakeCase();
      try{
        await spendCash(stake);
        hasCase = true;
        const openBtn = $("#btnOpenCase"); if (openBtn) openBtn.disabled = false;
        $("#caseStatus").textContent = "Kiste gekauft.";
        await logFeed(`CS:GO-Kiste (${CASE_ID}) gekauft: Einsatz ${EUR(stake)}`);
      }catch(e){ showToast(e.message||"Fehler"); }
    }
    async function openCase(){
      if (!state.userDoc) return openSheet();
      if (!hasCase){ showToast("Bitte zuerst eine Kiste kaufen."); return; }
      const stake = stakeCase();
      try{
        const drop = pickWeighted();
        const win  = Math.round(stake * drop.multiplier);
        $("#casePrize").textContent = `Drop: ${drop.name} (${drop.multiplier}√ó) ‚Ä¢ Gewinn ${EUR(win)}`;
        if (win>0) await payoutCash(win);
        hasCase = false;
        const openBtn = $("#btnOpenCase"); if (openBtn) openBtn.disabled = true;
        await logFeed(`CS:GO-Kiste ge√∂ffnet (${CASE_ID}): ${drop.name}, Gewinn ${EUR(win)}`);
      }catch(e){ showToast(e.message||"Fehler"); }
    }
    const btnBuyCase = $("#btnBuyCase");
    const btnOpenCase = $("#btnOpenCase");
    if (btnBuyCase)  btnBuyCase.onclick  = ()=> { if (!slotGuard()) return; setSlotsDisabled(true); buyCase().finally(()=> setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL)); };
    if (btnOpenCase) btnOpenCase.onclick = ()=> { if (!slotGuard()) return; setSlotsDisabled(true); openCase().finally(()=> setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL)); };

    // ---- Job (daily) ----
    const JOB_MAX_HITS = 100;
    const JOB_TIME_MS = 60*1000; // 1 minute
    const JOB_PAY_PER_HIT = 20;
    let jobRunning=false, jobTarget=-1, jobHits=0, jobTimerId=null, jobTickId=null, jobEndsAt=0, jobAccrued=0;

    function buildJobGrid(){
      const grid = $("#jobGrid"); if (!grid) return;
      grid.innerHTML = "";
      for (let i=0;i<100;i++){ // 20 x 5
        const cell = document.createElement("div");
        cell.className = "job-cell";
        cell.dataset.idx = i;
        cell.onclick = ()=> handleJobClick(i);
        grid.appendChild(cell);
      }
    }
    buildJobGrid();

    function formatTime(ms){ const s=Math.max(0, Math.ceil(ms/1000)); const mm=String(Math.floor(s/60)).padStart(2,"0"); const ss=String(s%60).padStart(2,"0"); return mm+":"+ss; }
    function resetJobUI(){ jobHits=0; jobTarget=-1; jobAccrued=0; $("#jobHits").textContent="0"; $("#jobEarn").textContent="‚Ç¨0,00"; $("#jobTime").textContent="01:00"; [...$("#jobGrid").children].forEach(c=> c.classList.remove("target")); $("#btnStartJob").disabled=false; $("#btnEndJob").disabled=true; }
    async function canStartJobToday(){ if (!state.userDoc) return false; const snap = await getDoc(state.userDoc); const u = snap.data()||{}; const today = todayDE(); return (u.lastJob||"") !== today; }
    function spawnTarget(){ const cells=[...$("#jobGrid").children]; cells.forEach(c=> c.classList.remove("target")); jobTarget=Math.floor(Math.random()*cells.length); cells[jobTarget].classList.add("target"); }
    async function startJob(){ if (!state.userDoc){ openSheet(); return; } if(jobRunning) return; if(!(await canStartJobToday())){ showToast("Job schon erledigt ‚Äì morgen wieder ab 00:00."); return; } jobRunning=true; jobAccrued=0; $("#btnStartJob").disabled=true; $("#btnEndJob").disabled=false; jobEndsAt=Date.now()+JOB_TIME_MS; spawnTarget(); jobTimerId=setTimeout(()=> endJob(), JOB_TIME_MS); jobTickId=setInterval(()=>{ const left=jobEndsAt-Date.now(); $("#jobTime").textContent=formatTime(left); },250); }
    async function endJob(){ if(!jobRunning) return; jobRunning=false; clearTimeout(jobTimerId); jobTimerId=null; clearInterval(jobTickId); jobTickId=null; [...$("#jobGrid").children].forEach(c=> c.classList.remove("target")); const maxEarn=JOB_MAX_HITS*(JOB_PAY_PER_HIT+(state.user?.jobToolBonus||0)); const earnings=Math.min(jobAccrued, maxEarn); try{ await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const ud=u.data(); const today=todayDE(); if ((ud.lastJob||"")===today) throw new Error("Job heute bereits abgerechnet."); tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+earnings, lastJob: today }); }); $("#jobEarn").textContent = EUR(earnings); await logFeed(`Job erledigt: +${EUR(earnings)} (${jobHits} Treffer)`); showToast(`Job beendet: ${EUR(earnings)}`); }catch(e){ showToast(e.message||"Fehler"); } resetJobUI(); }
    function handleJobClick(idx){ if(!jobRunning) return; if(idx===jobTarget){ const cells=[...$("#jobGrid").children]; const cell=cells[jobTarget]; if(cell){ cell.classList.add("burst"); setTimeout(()=> cell.classList.remove("burst"), 200); } jobHits++; const rate = JOB_PAY_PER_HIT + (state.user?.jobToolBonus||0); jobAccrued += rate; $("#jobHits").textContent=String(jobHits); $("#jobEarn").textContent=EUR(jobAccrued); if(jobHits>=JOB_MAX_HITS){ endJob(); return; } setTimeout(()=> spawnTarget(), 120); } }
    $("#btnStartJob").onclick = startJob;
    $("#btnEndJob").onclick = endJob;

    // ---- Job tools (pickaxes) ----
    const JOB_TOOLS = [
      { id:0, key:"hand",      name:"Hand",           cost:0,       bonus:0,    color:"#e5e7eb" },
      { id:1, key:"wood",      name:"Holz Spitzhacke",cost:10000,   bonus:10,   color:"#b45309" },
      { id:2, key:"iron",      name:"Eisen Spitzhacke",cost:25000,  bonus:30,   color:"#4b5563" },
      { id:3, key:"diamond",   name:"Diamant Spitzhacke",cost:50000,bonus:50,   color:"#06b6d4" },
      { id:4, key:"netherite", name:"Netherrite Spitzhacke",cost:100000,bonus:200,color:"#4c1d95" },
      { id:5, key:"ultra",     name:"Ultra Spitzhacke",cost:1000000,bonus:1000, color:"#ca8a04" },
    ];
    function toolById(id){ return JOB_TOOLS.find(t=>t.id===id)||JOB_TOOLS[0]; }

    function renderShop(u){
      const wrap = $("#toolList"); if (!wrap) return;
      wrap.innerHTML="";
      const cashNow = (u.cash||0);
      const rateNow = 20 + (toolById(u.jobTool||0).bonus||0);
      const shopRate = $("#shopRate"); if (shopRate) shopRate.textContent = EUR(rateNow);
      JOB_TOOLS.filter(t=>t.id>0).forEach(t=>{
        const owned = (u.jobTool||0) === t.id;
        const afford = cashNow >= t.cost;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row between">
            <div class="row" style="gap:.6rem">
              <div style="width:42px;height:42px;border-radius:10px;background:${t.color}22;border:2px solid ${t.color};display:flex;align-items:center;justify-content:center;font-size:22px">‚õèÔ∏è</div>
              <div class="col">
                <div class="section-title" style="margin:0">${t.name}</div>
                <small>+${EUR(t.bonus)} pro Treffer</small>
              </div>
            </div>
            <div class="col tool-right" style="align-items:flex-end">
              <b>${EUR(t.cost)}</b>
              <button class="btn ${owned?'':'primary'}" data-buy="${t.id}" ${owned||!afford?'disabled':''} title="${owned?'Bereits aktiv':(afford?'Kaufen':'Zu wenig Bargeld (üíµ)')}">${owned?'Aktiv':(afford?'Kaufen':'Zu wenig üíµ')}</button>
            </div>
          </div>`;
        wrap.appendChild(card);
      });
      $$("#toolList [data-buy]").forEach(b=> b.onclick = ()=> buyTool(Number(b.dataset.buy)));
    }

    async function buyTool(id){
      if (!state.userDoc) return openSheet();
      const tool = toolById(id); if (!tool) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.cash||0) < tool.cost) throw new Error("Zu wenig Bargeld.");
          tx.update(state.userDoc, { cash:(ud.cash||0)-tool.cost, jobTool: tool.id });
          tx.update(state.bankDoc, { funds:(bd.funds||0)+tool.cost });
        });
        await logFeed(`Gekauft: ${tool.name} (${EUR(tool.cost)})`);
        showToast(`${tool.name} aktiviert!`);
      }catch(e){ showToast(e.message||"Fehler"); }
    }

  </script>
</body>
</html>
