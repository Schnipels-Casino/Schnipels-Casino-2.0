<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>Friends Bank ‚Äì Mobile v3.9.7 (Login fast + Slots + Job 20√ó5)</title>
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#f6f8fc; --card:#ffffff; --muted:#566074; --text:#0f1624;
      --accent:#2dd36f; --accent2:#2563eb; --danger:#e11d48; --warn:#f59e0b;
      --outline:#e4e8f1; --pill:#eff3f9; --win:#16a34a; --loss:#dc2626;
      --shadow:0 8px 28px rgba(15,22,36,.08);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:17px;line-height:1.5;letter-spacing:.2px;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    .hidden{display:none!important}
    .row{display:flex;gap:.8rem;align-items:center}
    .col{display:flex;flex-direction:column;gap:.2rem}
    .between{justify-content:space-between}
    .center{justify-content:center;align-items:center}
    .container{max-width:880px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .btn{background:var(--pill);border:1px solid var(--outline);padding:1rem 1.15rem;border-radius:14px;min-width:48px;min-height:48px;font-weight:800;color:var(--text);cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.primary{background:var(--accent);color:#052010;border-color:#129454}
    .btn.warn{background:var(--warn);color:#231a00;border-color:#b07404}
    .btn.danger{background:#f43f5e;color:#2b0d0d;border-color:#d11a44}
    .btn.small{min-height:40px;padding:.5rem .8rem;border-radius:12px;font-weight:900}
    input,select{width:100%;background:#f2f5fb;color:var(--text);border:1px solid var(--outline);border-radius:12px;padding:1rem 1rem;font-size:18px}
    label{font-size:1rem;color:#24324a;font-weight:800}
    small{color:var(--muted);font-size:.98rem}
    ::placeholder{color:#6b7280;opacity:.9}

    /* TOPBAR */
    .topbar{position:sticky;top:0;z-index:50;background:#ffffffee;border-bottom:1px solid var(--outline);padding:.6rem .9rem;backdrop-filter:saturate(1.3) blur(6px);box-shadow:0 6px 18px rgba(15,22,36,.06)}
    .top-grid{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center}
    .left-wrap{display:flex;align-items:center;gap:.7rem;min-height:52px}
    .bank-name{font-weight:1000;font-size:1.05rem;line-height:1.1}
    .acct-line{font-weight:800;color:#0f172a}
    .circle{width:44px;height:44px;border-radius:999px;background:var(--pill);border:1px solid var(--outline);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;cursor:pointer}
    .icon-row{display:flex;gap:.5rem;align-items:center;justify-content:flex-end}
    .cash-amount{font-weight:900}
    #screen{padding:14px;display:flex;flex-direction:column;gap:14px;padding-bottom:120px}

    .tabs{display:flex;gap:.6rem}
    .tab{flex:1;padding:.9rem;border:1px solid var(--outline);background:var(--pill);border-radius:12px;text-align:center;font-weight:900;cursor:pointer}
    .tab.active{background:var(--accent2);color:#fff;border-color:#1e4fd5}
    .section-title{font-size:1.2rem;font-weight:1000}
    .strip{display:flex;gap:.6rem;overflow:auto;padding-bottom:.2rem}
    .grid2{display:grid;grid-template-columns:1fr;gap:.8rem}
    .grid3{display:grid;grid-template-columns:1fr;gap:.8rem}
    .gridAuto{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.8rem}
    @media (min-width:720px){.grid2{grid-template-columns:1fr 1fr}.grid3{grid-template-columns:repeat(3,1fr)}}
    .toast{position:fixed;bottom:14px;left:0;right:0;margin:auto;max-width:560px;padding:1rem 1.1rem;border-radius:12px;background:#0f1624;color:#fff;border:1px solid #1f2a40;box-shadow:0 10px 30px rgba(15,22,36,.25);text-align:center;z-index:1200}

    footer.nav{position:fixed;left:0;right:0;bottom:0;padding:.6rem;background:#ffffffee;border-top:1px solid var(--outline);display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem;backdrop-filter:saturate(1.2) blur(6px);z-index:60}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(15,22,36,.12);backdrop-filter:blur(2px) saturate(1.1);z-index:1000}
    .sheet{width:100%;max-width:880px;background:var(--card);border:1px solid var(--outline);border-radius:18px;box-shadow:var(--shadow);margin:72px 12px 18px;overflow:hidden}
    .handle{width:46px;height:5px;background:#e5e7eb;border-radius:999px;margin:10px auto}

    .chat-bubble{padding:.6rem .8rem;border:1px solid var(--outline);border-radius:12px;background:var(--pill);margin-bottom:.6rem}
    .chat-bubble.mine{background:#e8f7ff;border-color:#3b82f6}

    /* JOB (20x5 = 100 Felder) */
    .job-grid{display:grid;grid-template-columns:repeat(20,34px);justify-content:center;gap:6px}
    .job-cell{width:34px;height:34px;border:2px solid var(--outline);border-radius:10px;background:#f3f4f6;box-shadow:var(--shadow);cursor:pointer;transition:transform .08s}
    .job-cell:active{transform:scale(0.98)}
    .job-cell.target{background:#d1fae5;border-color:#10b981}
    @keyframes burst{0%{opacity:1;transform:scale(1)}60%{opacity:.2;transform:scale(.7)}100%{opacity:0;transform:scale(.6)}}
    .job-cell.burst{animation:burst .18s ease-out}

    /* SLOTS */
    .slot-grid{display:grid;grid-template-columns:repeat(3,64px);grid-auto-rows:64px;gap:10px;justify-content:center;align-content:center}
    .slot-cell{display:flex;align-items:center;justify-content:center;border:2px solid var(--outline);border-radius:12px;background:#f2f6ff;font-size:28px;transition:transform .12s;box-shadow:var(--shadow)}
    .slot-cell.spin{transform:scale(1.05)}

    /* SHOP layout refinements */
    #toolList.gridAuto{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    #toolList .card{padding:14px}
    #toolList .tool-right{align-items:flex-end;width:140px}
    #toolList .tool-right .btn{width:100%;min-height:40px;padding:.5rem .8rem;border-radius:12px;font-size:14px}
  </style>










<style id="sticky-topbar">
  .topbar{
    position: sticky;
    top: 0;
    z-index: 1000;
    backdrop-filter: blur(10px);
    background: rgba(12,16,34,0.9);
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  /* Blue banknote circle */
  #btnBank.circle{
    background: #1d4ed8;
    color: #ffffff;
    box-shadow: 0 4px 12px rgba(29,78,216,.35);
  }
  #btnBank.circle:hover{ filter: brightness(1.1); }
</style>


<style id="topbar-click-fix">
  .topbar{ position: sticky; top:0; z-index: 5000; }
  #jackpotBadgeFixed{ pointer-events: none; } /* never block clicks */
</style>


<style id="btnbank-style">
  #btnBank.circle{
    background:#ffffff !important;
    color:#1d4ed8 !important; /* emoji/text blue */
    border:1px solid rgba(0,0,0,.1);
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
  }
</style>


<style id="slot-visibility-scope">
  .slot-grid{ display:none !important; position: static !important; z-index: auto !important; }
  #slotsArea .slot-grid{ display:grid !important; }
  #slotsArea .slot-grid .slot-cell{
    background:#ffffff; border:2px solid #e4e8f1; border-radius:12px; box-shadow:var(--shadow);
    width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-size:28px;
  }
</style>


<style id="worker-scroll">
  #workerList{ max-height: 300px; overflow: auto; padding-right: 4px; }
</style>


<style id="mobile-bottom-nav">
  /* Desktop (>=721px): show top icons, hide mobile footer + extra cash line */
  @media (min-width: 721px){
    #mobileNav{ display:none !important; }
    .icon-row{ display:flex !important; }
    #cashLabelTop{ display:none !important; }
  }
  /* Mobile (<=720px): hide top icon-row, show bottom nav, show cash top-line */
  @media (max-width: 720px){
    .icon-row{ display:none !important; }
    #mobileNav{ display:grid !important; grid-template-columns:repeat(7,1fr); }
    #cashLabelTop{ display:block !important; }
    body{ padding-bottom:92px; } /* space so content not hidden by bottom nav */
  }
</style>

</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="top-grid">
        <div class="left-wrap">
          <button id="btnLogout" class="btn danger small">Logout</button>
          <div class="col">
            <div class="bank-name" id="bankLabel">‚Äî</div>
            <div class="acct-line money" id="acctBalance">‚Äî</div>
            <div class="acct-line money hidden" id="cashLabelTop">‚Ç¨0</div>
          </div>
        </div>
        <div class="icon-row">
          <div id="btnBank" class="circle" title="Bank">üí∂</div>
          <div id="btnJob" class="circle" title="Job">üë∑</div>
          <div id="btnFirm" class="circle" title="Firma">üë®‚Äçüíº</div>
          <div id="btnSlots" class="circle" title="Slots">üé∞</div>
          <div id="btnHouse" class="circle" title="H√§user">üè†</div>
          <div id="btnChat" class="circle" title="Chat">üí¨</div>
          <div id="btnShop" class="circle" title="Shop">üíµ</div>
          <div class="row" style="gap:.5rem">
            <div class="small" style="opacity:.9">üíµ</div>
            <div id="cashLabel" class="money cash-amount">‚Ç¨0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="screen" class="container">
    <div id="welcome" class="card">
      <div class="section-title">Willkommen üëã</div>
      <p>Tippe oben auf <b>üí∂</b>, w√§hle deine Bank & logge dich mit <b>Name + Passwort</b> ein.</p>
      <div class="grid2">
        <div class="card">
          <div class="section-title">T√§gliches Bonusgeld</div>
          <p>Jede Bank zahlt <b>‚Ç¨500 / Tag</b>. Startguthaben: <b>‚Ç¨1.500</b>.</p>
          <button id="btnClaimDaily" class="btn primary">‚Ç¨500 jetzt abholen</button>
        </div>
        <div class="card">
          <div class="section-title">Leihen & Kredit</div>
          <ul style="margin:.2rem 0 .2rem 1rem">
            <li>Leihen: <b>‚Ç¨1.000/Tag</b>, max. <b>‚Ç¨10.000</b>, <b>10% Geb√ºhr</b>.</li>
            <li>Kredit: bis <b>‚Ç¨100.000</b>, R√ºckzahlung in 1.000er-Schritten.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- BANK -->
    <div id="bankArea" class="card">
      <div class="section-title">Dein Konto</div>
      <div class="grid2">
        <div class="card">
          <div class="row between"><div>Kontostand</div><div class="money" id="bankBalance">‚Ç¨0</div></div>
          <div class="row between"><div>Leihe offen</div><div class="money" id="loanOutstanding">‚Ç¨0</div></div>
          <div class="row between"><div>Kredit offen</div><div class="money" id="creditOutstanding">‚Ç¨0</div></div>
        </div>
        <div class="card">
          <div class="row between"><div>Aktienkurs <span id="stockBankName" class="small"></span></div><div class="ticker" id="stockPrice">‚Äî</div></div>
          <div class="row between"><div>Deine Anteile</div><div id="userShares">0</div></div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <div class="section-title">Ein-/Auszahlen</div>
          <label>Betrag (‚Ç¨)</label>
          <input id="ioAmount" type="number" inputmode="numeric" min="1" placeholder="z.B. 50">
          <div class="row strip">
            <button class="btn" data-quick="20">+20</button>
            <button class="btn" data-quick="50">+50</button>
            <button class="btn" data-quick="100">+100</button>
            <button class="btn" data-quick="500">+500</button>
          </div>
          <div class="row grid2">
            <button id="btnDeposit" class="btn primary">Einzahlen ‚ûú</button>
            <button id="btnWithdraw" class="btn">‚¨Ö Auszahlen</button>
          </div>
          <small>Bargeld (üíµ) wird oben rechts angezeigt.</small>
        </div>
        <div class="card">
          <div class="section-title">Leihen & Kredit</div>
          <div class="row grid2">
            <button id="btnBorrow1000" class="btn">Leihen ‚Ç¨1.000</button>
            <button id="btnRepayLoan1000" class="btn">Leih-R√ºckzahlung ‚Ç¨1.000</button>
          </div>
          <div class="row grid2" style="margin-top:.4rem">
            <button id="btnTakeCredit" class="btn warn">Kredit nehmen</button>
            <button id="btnRepayCredit1000" class="btn">Kredit -‚Ç¨1.000</button>
          </div>
        </div>
      </div>
      <div class="grid2">
        <div class="card">
          <div class="section-title">Aktien handeln</div>
          <label>Menge (St√ºck)</label>
          <input id="sharesQty" type="number" min="1" step="1" placeholder="z.B. 10">
          <div class="row grid2">
            <button id="btnBuyShares" class="btn primary">Kaufen</button>
            <button id="btnSellShares" class="btn">Verkaufen</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Bank-Fonds</div>
          <div class="row between"><div>Bankverm√∂gen</div><div id="bankFunds" class="money">‚Äî</div></div>
          <small>Start: ‚Ç¨1.000.000.000. Eins√§tze erh√∂hen, Auszahlungen senken es.</small>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Verlauf</div>
        <div id="feed" class="mono" style="max-height:38vh;overflow:auto;white-space:pre-line"></div>
      </div>
    </div>

    <!-- SLOTS -->
    <div id="slotsArea" class="card hidden">
      <div class="section-title">Slots üé∞</div>
      <small>Eins√§tze: 5 / 10 / 30 / 50 / 80 / 100 ‚Ç¨ (vom Bargeld)</small>

      <div class="card">
        <div class="row between"><div class="section-title">High or Lower</div><div id="hlStatus"></div></div>
        <div class="grid3 center" style="gap:10px">
          <div class="card center" style="height:96px"><div id="hlDealer" class="section-title">üÇ†</div></div>
          <div class="card center" style="height:96px"><div id="hlYou" class="section-title">?</div></div>
          <div class="col">
            <select id="stakeHL"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
            <div class="row">
              <button id="btnHigher" class="btn" style="flex:1">H√∂her</button>
              <button id="btnLower"  class="btn" style="flex:1">Niedriger</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row between"><div class="section-title">Kopf oder Zahl</div><div id="cfStatus"></div></div>
        <div class="grid3 center" style="gap:10px">
          <div class="card center" style="height:96px"><div id="cfResult" class="section-title">ü™ô</div></div>
          <div class="col">
            <select id="stakeCF"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
            <select id="cfPick"><option value="kopf">Kopf</option><option value="zahl">Zahl</option></select>
          </div>
          <button id="btnCF" class="btn">Spielen</button>
        </div>
      </div>

      <div class="card">
        <div class="row between"><div class="section-title">Triple Chance</div><div class="row" style="gap:.35rem;align-items:center"><span class="small">Jackpot</span><span id="tcJackpot" class="money">‚Ç¨0</span></div></div></div>
        <div class="center" style="margin:.4rem 0">
          <div class="slot-grid" id="slotGrid">
            <div class="slot-cell">üçã</div><div class="slot-cell">üçí</div><div class="slot-cell">üçá</div>
            <div class="slot-cell">üçÄ</div><div class="slot-cell">‚≠ê</div><div class="slot-cell">üîî</div>
            <div class="slot-cell">7Ô∏è‚É£</div><div class="slot-cell">üçâ</div><div class="slot-cell">üçã</div>
          </div>
        </div>
        <div class="row center" style="gap:.6rem">
          <select id="stakeTC"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
          <button id="btnSpin" class="btn">Spin</button>
          <button id="btnAuto10" class="btn">Auto x10</button>
        </div>
      </div>
      </div>
      </div>
    </div>

    <!-- JOB -->
    <div id="jobArea" class="card hidden">
      <div class="section-title">Job üë∑</div>
      <small>Triff das gr√ºn markierte Feld. Du hast <b>1:00</b> Minuten. Maximal 100 Treffer. <b>20‚Ç¨</b> Basislohn pro Treffer (+ Tool-Bonus). Einmal t√§glich.</small>
      <div class="row between" style="margin:.4rem 0">
        <div><b>Treffer:</b> <span id="jobHits">0</span> / 100</div>
        <div><b>Verdienst:</b> <span id="jobEarn">‚Ç¨0,00</span></div>
        <div><b>Zeit:</b> <span id="jobTime">01:00</span></div>
      </div>
      <div id="jobGrid" class="job-grid" style="margin:.4rem 0"></div>
      <div class="row" style="gap:.6rem">
        <button id="btnStartJob" class="btn primary">Job starten</button>
        <button id="btnEndJob" class="btn danger" disabled>Beenden</button>
      </div>
      <small id="jobHint"></small>
    
    <!-- FIRMA -->
    <div id="firmArea" class="card hidden">
      <div class="section-title">Eigene Firma üë®‚Äçüíº</div>
      <div id="firmWizard" class="col">
        <p><b>Willkommen!</b> W√§hlen Sie, wie Sie starten m√∂chten.</p>
        <div class="grid2">
          <div class="card">
            <div class="section-title">Legales Unternehmen</div>
            <button id="btnBuyLegal" class="btn primary">Legales Unternehmen kaufen ‚Äì ‚Ç¨100.000</button>
            <div id="legalKinds" class="row strip hidden" style="margin-top:.6rem">
              <button class="btn" data-kind="Autohandel">Autohandel</button>
              <button class="btn" data-kind="Bauunternehmen">Bauunternehmen</button>
              <button class="btn" data-kind="Serviceunternehmen">Serviceunternehmen</button>
              <button class="btn" data-kind="Immobilienmakler">Immobilienmakler</button>
            </div>
          </div>
          <div class="card">
            <div class="section-title">Illegales Unternehmen</div>
            <button id="btnBuyIllegal" class="btn danger">Illegales Unternehmen kaufen ‚Äì ‚Ç¨100.000</button>
            <div id="illegalKinds" class="row strip hidden" style="margin-top:.6rem">
              <button class="btn" data-kind="Drogen Business">Drogen Business</button>
              <button class="btn" data-kind="Waffen Handel">Waffen Handel</button>
              <button class="btn" data-kind="Motorrad Club">Motorrad Club</button>
              <button class="btn" data-kind="Hacking Service">Hacking Service</button>
            </div>
          </div>
        </div>
      </div>

      <div id="firmDash" class="col hidden">
        <div class="row between">
          <div class="col">
            <div class="section-title" id="firmName">‚Äî</div>
            <small id="firmBusiness">‚Äî</small>
          </div>
          <div class="col" style="align-items:flex-end">
            <small>Firmenkonto</small>
            <div class="money" id="firmFunds">‚Ç¨0</div>
          </div>
        </div>

        <div class="grid2" style="margin-top:.6rem">
          <div class="card">
            <div class="section-title">Tagesabschluss</div>
            <small id="firmDailyHint"></small>
            <div class="row" style="margin-top:.4rem">
              <button id="btnDoDaily" class="btn primary">Heute abrechnen</button>
            </div>
          </div>
          <div class="card">
            <div class="section-title">Finanzen</div>
            <div class="row between"><div>Offener Kredit</div><div id="firmLoan" class="money">‚Ç¨0</div></div>
            <div class="row" style="gap:.6rem;margin-top:.4rem">
              <button id="btnFirmCredit" class="btn">Kredit +‚Ç¨5.000</button>
              <button id="btnFirmRepay" class="btn">Kredit -‚Ç¨1.000</button>
            </div>
            <div class="row" style="gap:.6rem;margin-top:.4rem">
              <input id="firmSalaryAmt" type="number" min="1" placeholder="Lohn auszahlen (max 1.000.000)"> 
              <button id="btnFirmPayout" class="btn warn">Lohn auszahlen</button>
            </div>
            <small id="firmCreditHint"></small>
          </div>
        </div>

        <div class="grid2" style="margin-top:.6rem">
          <div class="card">
            <div class="row between">
              <div class="section-title">Mitarbeiter</div>
              <button id="btnAddWorker" class="btn small">üë∑ Mitarbeiter kaufen (‚Ç¨3.500)</button>
            </div>
            <small>Lohn: ‚Ç¨200 pro Tag pro Mitarbeiter. Level steigt t√§glich (+1 XP). Bei 5 XP ‚ûú n√§chstes Level (max 5). Ab Level 5 kann man f√ºr ‚Ç¨1.000.000 Prestige erh√∂hen (max P5).</small>
            <div id="workerList" class="col" style="margin-top:.6rem"></div>
          </div>
          <div class="card">
            <div class="section-title">Waren & Produktion</div>
            <div class="row between"><div>Rohware</div><div id="stockRaw">0</div></div>
            <div class="row between"><div>Verarbeitet</div><div id="stockProc">0</div></div>
            <div class="row between"><div>Gelagert</div><div id="stockStore">0</div></div>
            <div class="row between"><div>Gepr√ºft</div><div id="stockCheck">0</div></div>
            <div class="row" style="gap:.6rem;margin-top:.4rem">
              <input id="buyQty" type="number" min="1" placeholder="Anzahl">
              <button id="btnBuyGoods" class="btn">Rohware kaufen (‚Ç¨1.000/Stk)</button>
            </div>
            <div class="row" style="gap:.6rem;margin-top:.4rem">
              <input id="procQty" type="number" min="1" placeholder="Anzahl">
              <button id="btnProcess" class="btn">Verarbeiten (2s/Stk)</button>
            </div>
            <div class="row" style="gap:.6rem;margin-top:.4rem">
              <input id="storeQty" type="number" min="1" placeholder="Anzahl">
              <button id="btnStore" class="btn">Lagern (3s/Stk)</button>
            </div>
            <div class="row" style="gap:.6rem;margin-top:.4rem">
              <input id="checkQty" type="number" min="1" placeholder="Anzahl">
              <button id="btnCheck" class="btn">Ware pr√ºfen (2s/Stk)</button>
            </div>
            <div class="row" style="gap:.6rem;margin-top:.4rem">
              <input id="sellQty" type="number" min="1" placeholder="Anzahl">
              <button id="btnSell" class="btn primary">Verkaufen (‚Ç¨1.500/Stk)</button>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

    <!-- SHOP -->
    <div id="shopArea" class="card hidden">
      <div class="section-title">Shop ‚õèÔ∏è</div>
      <small>Kaufe Spitzhacken mit <b>Bargeld (üíµ)</b>. Der Betrag geht in die Bankfonds. Aktuelles Werkzeug wirkt auf den <b>Lohn pro Treffer</b>.</small>
      <div class="row" style="margin-top:.4rem;justify-content:flex-end"><div><b>Lohn/Schlag:</b> <span id="shopRate">‚Ç¨20</span></div></div>
      <div id="toolList" class="gridAuto" style="margin-top:.6rem"></div>
    </div>

    <!-- H√ÑUSER -->
    <div id="houseArea" class="card hidden">
      <div class="section-title">H√§user & Mieten üè†</div>
      <div class="gridAuto" id="houseList"></div>
      <div class="row between">
        <button id="btnCollectRent" class="btn primary" disabled>Tagesmieten einsammeln (Demo)</button>
        <small id="rentInfo"></small>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chatArea" class="card hidden">
      <div class="row tabs">
        <div id="tabGlobal" class="tab active">Global</div>
        <div id="tabPrivate" class="tab">Privat</div>
      </div>
      <div id="chatGlobal" class="col">
        <div id="globalList" style="max-height:38vh;overflow:auto"></div>
        <div class="row"><input id="globalMsg" placeholder="Nachricht an alle‚Ä¶"><button id="sendGlobal" class="btn primary">Senden</button></div>
      </div>
      <div id="chatPrivate" class="col hidden">
        <div class="row" style="gap:.6rem">
          <input id="pmTo" placeholder="Empf√§nger (Name)">
          <button id="btnFindUser" class="btn small" title="Spieler suchen">üîé</button>
        </div>
        <small id="pmFindHint"></small>
        <div id="privateList" style="max-height:38vh;overflow:auto"></div>
        <div class="row"><input id="privateMsg" placeholder="Deine private Nachricht‚Ä¶"><button id="sendPrivate" class="btn primary">Senden</button></div>
      </div>
    </div>
  </main>

  <!-- Bank Sheet -->
  <div id="sheetBank" class="modal" style="display:flex;align-items:flex-start">
    <div class="sheet">
      <div class="handle"></div>
      <div class="container" style="padding:10px 12px 18px">
        <div class="card bank-choice">
          <div class="section-title">Bank w√§hlen</div>
          <p>W√§hle genau <b>eine</b> Bank f√ºr dein Konto. Pro Name ist nur eine Bank erlaubt.</p>
          <div class="grid2">
            <button class="btn" data-bank="VR-Bank">VR-Bank</button>
            <button class="btn" data-bank="Deutsche Bank">Deutsche Bank</button>
            <button class="btn" data-bank="Sparkasse">Sparkasse</button>
            <button class="btn" data-bank="Postbank">Postbank</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Login / Registrierung</div>
          <label>Name</label><input id="loginName" placeholder="z.B. Julian">
          <label>Passwort</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          <div class="row between" style="gap:.6rem">
            <button id="btnLogin" class="btn primary" style="flex:1">Einloggen / Konto anlegen</button>
          </div>
          <small id="loginHint">Startguthaben: ‚Ç¨1.500. T√§glicher Bonus: ‚Ç¨500.</small>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, orderBy, limit, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // ---- Firebase ----
    const firebaseConfig = {
  apiKey: "AIzaSyArqwFEi1afYtkPTbGuA0PiwJsHmBuJhos",
  authDomain: "schnipels-casino.firebaseapp.com",
  projectId: "schnipels-casino",
  storageBucket: "schnipels-casino.firebasestorage.app",
  messagingSenderId: "233562090178",
  appId: "1:233562090178:web:520c0e28b295308527e95b",
  measurementId: "G-EJPHEFBSDX"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- Helpers / State ----
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const EUR = n => "‚Ç¨" + (Math.round(n*100)/100).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const todayDE = () => new Date().toLocaleDateString("de-DE",{ timeZone:"Europe/Berlin" });
    const hash = async (s)=>{ const enc = new TextEncoder().encode(s); const buf = await crypto.subtle.digest("SHA-256", enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); };
    const showToast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"), 2200); };
    const logFeed = async (txt)=>{ $("#feed").prepend("‚Ä¢ "+txt+"\\n"); if (state.userDoc) await addDoc(collection(db, "users", state.userDoc.id, "feed"), { txt, at: serverTimestamp() }); };
    const state = { bank:null, user:null, userDoc:null, bankDoc:null, listeners:[], authed:false };

    // ---------- AUTH (fast with fallback) ----------
    const auth = getAuth(app);
    let authUser = null;
    async function ensureAuth(){
      if (state.authed && auth.currentUser) return authUser;
      if (ensureAuth._p) return ensureAuth._p;
      ensureAuth._p = new Promise(async (resolve)=>{
        let unsub=null, resolved=false;
        function finish(u){
          if (resolved) return;
          resolved=true;
          authUser = u;
          state.authed = !!u;
          if (unsub) try{unsub();}catch{}
          resolve(u);
        }
        try{
          await setPersistence(auth, browserLocalPersistence);
          unsub = onAuthStateChanged(auth, (u)=> finish(u));
          if (!auth.currentUser){
            try{ await signInAnonymously(auth); }catch(e){ console.warn("signInAnonymously", e?.message||e); }
          }
          setTimeout(()=> finish(auth.currentUser||null), 3000);
        }catch(e){
          console.error(e);
          showToast("Auth-Fehler: "+(e?.message||""));
          finish(null);
        }finally{
          ensureAuth._p = null;
        }
      });
      return ensureAuth._p;
    }
    ensureAuth();

    // ---------- UI refs ----------
    const bankSheet = $("#sheetBank"), bankLabel=$("#bankLabel"), bankBalance=$("#bankBalance"), cashLabel=$("#cashLabel"), acctBalance=$("#acctBalance"), stockPriceEl=$("#stockPrice"), stockBankName=$("#stockBankName"), bankFundsEl=$("#bankFunds"), userSharesEl=$("#userShares");
    const openSheet = ()=> bankSheet.style.display = "flex";
    const closeSheet = ()=> bankSheet.style.display = "none";
    setTimeout(()=>showToast("Tipp: W√§hle deine Bank & logge dich ein."), 600);

    // Logout
    $("#btnLogout").onclick = ()=>{ state.listeners.forEach(u=>u()); state.listeners=[]; state.user=null; state.userDoc=null; openSheet(); };

    // Bank choice
    $$("#sheetBank [data-bank]").forEach(btn=>{
      btn.onclick = async ()=>{
        $$("#sheetBank [data-bank]").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        state.bank = btn.dataset.bank;
        bankLabel.textContent = state.bank;
        stockBankName.textContent = "("+state.bank+")";
        $("#loginHint").textContent = "Ausgew√§hlt: "+state.bank+" ‚Äì Startguthaben: ‚Ç¨1.500, Bonus: ‚Ç¨500/Tag.";
        await ensureAuth();
        await ensureBankDoc();
        await ensureTicker();
      };
    });

    // Login
    $("#btnLogin").onclick = async ()=>{
      const name = $("#loginName").value.trim();
      const pass = $("#loginPass").value;
      if (!state.bank){ showToast("Bitte zuerst eine Bank w√§hlen."); return; }
      if (name.length<2 || pass.length<3){ showToast("Name/Passwort zu kurz."); return; }

      const btn = $("#btnLogin"); btn.disabled = true; const oldTxt = btn.textContent; btn.textContent = "Bitte warten‚Ä¶";
      const _guard = setTimeout(()=>{ try{ btn.disabled=false; btn.textContent=oldTxt; }catch{} showToast("Login dauert zu lange ‚Äì bitte Verbindung pr√ºfen und erneut versuchen."); }, 8000);
      try{
        await ensureAuth();
        const uname = name.toLowerCase();
        const passHash = await hash(pass);

        const idxRef = doc(db, "users_index", uname);
        const idxSnap = await getDoc(idxRef);
        if (idxSnap.exists() && idxSnap.data().bank !== state.bank){
          showToast(`Name bereits in ${idxSnap.data().bank} registriert.`);
          return;
        }

        const userId = `${state.bank.replaceAll(" ","")}_${uname}`;
        const userRef = doc(db, "users", userId);
        const snap = await getDoc(userRef);

        if (!snap.exists()){
          const init = { bank: state.bank, name, passHash, createdAt: serverTimestamp(), bankBalance: 1500, cash: 0, lastDaily: "", lastBorrow: "", loanOutstanding: 0, creditOutstanding: 0, lastRent: "", shares: 0, jobTool: 0, lastJob: "" };
          await setDoc(userRef, init);
          await setDoc(idxRef, { bank: state.bank, uid: userId });
          showToast("Konto erstellt. Willkommen!");
        }else{
          const data = snap.data();
          if (data.passHash !== passHash){ showToast("Falsches Passwort."); return; }
        }
        await attachUser(userRef);
        closeSheet();
        await logFeed("Angemeldet bei "+state.bank+".");
      }catch(err){ console.error(err); showToast("Login-Fehler: "+(err?.message||"Unbekannt")); }
      finally{ try{ clearTimeout(_guard); }catch{} btn.disabled = false; btn.textContent = oldTxt; }
    };

    async function attachUser(userRef){
      state.listeners.forEach(u=>u()); state.listeners=[];
      state.userDoc = userRef;
      const unsub = onSnapshot(userRef, (d)=>{
        const u = d.data(); if (!u) return;
        state.user = { id:d.id, ...u };
        bankBalance.textContent = EUR(u.bankBalance||0);
        acctBalance.textContent = EUR(u.bankBalance||0);
        cashLabel.textContent = EUR(u.cash||0);
        $("#loanOutstanding").textContent = EUR(u.loanOutstanding||0);
        $("#creditOutstanding").textContent = EUR(u.creditOutstanding||0);
        userSharesEl.textContent = (u.shares||0);
        $("#rentInfo").textContent = u.lastRent ? ("Letzte Miete: "+u.lastRent) : "Noch keine Miete kassiert";
        renderHouses(u); renderShop(u);
        const t=todayDE();
        if (btnStartJob) btnStartJob.disabled = (u.lastJob||"")===t;
        jobHint.textContent = btnStartJob.disabled ? "Heute erledigt ‚Äì ab 00:00 wieder verf√ºgbar." : "";
        state.user.jobToolBonus = toolById(u.jobTool||0).bonus||0;
      });
      state.listeners.push(unsub);
      await ensureBankDoc(); await ensureTicker(); await loadFeed(); attachChat();
    }

    async function ensureBankDoc(){
      if (!state.bank) return;
      await ensureAuth();
      const id = state.bank.replaceAll(" ","");
      const bRef = doc(db, "banks", id);
      const snap = await getDoc(bRef);
      if (!snap.exists()){
        await setDoc(bRef, { name: state.bank, funds: 1_000_000_000, stockPrice: 100, lastStockUpdate: Date.now() });
      }
      state.bankDoc = bRef;
      const unsub = onSnapshot(bRef, (d)=>{
        const b = d.data(); if (!b) return;
        bankFundsEl.textContent = EUR(b.funds||0);
        stockPriceEl.textContent = EUR(b.stockPrice||0);
      });
      state.listeners.push(unsub);
    }
    async function ensureTicker(){
      if (!state.bankDoc) return;
      await ensureAuth();
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(state.bankDoc);
          const b = snap.data(); if (!b) return;
          const now = Date.now();
          if ((now - (b.lastStockUpdate||0)) < 12000) return;
          const dir = Math.random()<.5?-1:1;
          const pct = (0.004 + Math.random()*0.008) * dir;
          const next = Math.max(5, Math.round(b.stockPrice * (1+pct)*100)/100);
          tx.update(state.bankDoc, { stockPrice: next, lastStockUpdate: now });
        });
      }catch(e){}
    }
    setInterval(ensureTicker, 12_500);

    async function loadFeed(){
      if (!state.userDoc) return;
      const q = query(collection(db, "users", state.userDoc.id, "feed"), orderBy("at","desc"), limit(50));
      onSnapshot(q, (qs)=>{ const el = $("#feed"); el.textContent = ""; qs.forEach(doc=> el.append("‚Ä¢ "+doc.data().txt+"\\n") ); });
    }

    $$("#ioAmount ~ .strip .btn").forEach(b=> b.onclick = ()=>{ const v = Number($("#ioAmount").value||0) + Number(b.dataset.quick||0); $("#ioAmount").value = v; });

    async function txUpdate(cb){ await ensureAuth(); return await runTransaction(db, cb); }

    // Ein-/Auszahlen
    $("#btnDeposit").onclick = async ()=>{
      try{
        if (!state.userDoc) return openSheet();
        const amount = Number($("#ioAmount").value||0); if (amount<=0) return;
        await txUpdate(async(tx)=>{
          const u = await tx.get(state.userDoc); const ud = u.data();
          if ((ud.cash||0) < amount) throw new Error("Zu wenig Bargeld.");
          tx.update(state.userDoc, { cash: (ud.cash||0)-amount, bankBalance: (ud.bankBalance||0)+amount });
        });
        showToast("Einzahlung: "+EUR(amount)); await logFeed("Einzahlung "+EUR(amount)); $("#ioAmount").value="";
      }catch(e){ showToast(e.message||"Fehler"); }
    };
    $("#btnWithdraw").onclick = async ()=>{
      try{
        if (!state.userDoc) return openSheet();
        const amount = Number($("#ioAmount").value||0); if (amount<=0) return;
        await txUpdate(async(tx)=>{
          const u = await tx.get(state.userDoc); const ud = u.data();
          if ((ud.bankBalance||0) < amount) throw new Error("Zu wenig Guthaben.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-amount, cash:(ud.cash||0)+amount });
        });
        showToast("Auszahlung: "+EUR(amount)); await logFeed("Auszahlung "+EUR(amount)+" (Bargeld erh√∂ht)"); $("#ioAmount").value="";
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    // Bonus / Leihe / Kredit
    $("#btnClaimDaily").onclick = async ()=>{
      if (!state.userDoc){ openSheet(); return; }
      try{
        await ensureAuth();
        const today = todayDE();
        const uSnap = await getDoc(state.userDoc);
        const u = uSnap.data();
        if (u.lastDaily === today){ showToast("Heute schon abgeholt."); return; }
        await updateDoc(state.userDoc, { bankBalance: (u.bankBalance||0)+500, lastDaily: today });
        await logFeed("Tagesbonus +‚Ç¨500"); showToast("Tagesbonus +‚Ç¨500");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnBorrow1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const today = todayDE();
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if (ud.lastBorrow === today) throw new Error("Heute schon geliehen.");
          if ((ud.loanOutstanding||0) >= 10_000) throw new Error("Leih-Limit erreicht (10.000‚Ç¨).");
          const fee = 100;
          const newLoan = (ud.loanOutstanding||0) + 1000 + fee;
          tx.update(state.userDoc, { loanOutstanding: newLoan, bankBalance: (ud.bankBalance||0) + 1000, lastBorrow: today });
          tx.update(state.bankDoc, { funds: (bd.funds||0) + fee });
        });
        await logFeed("Leihe +‚Ç¨1.000 (10% Geb√ºhr)"); showToast("Leihe +‚Ç¨1.000 (Geb√ºhr ‚Ç¨100)");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnRepayLoan1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.loanOutstanding||0) <= 0) throw new Error("Keine Leihe offen.");
          if ((ud.bankBalance||0) < 1000) throw new Error("Zu wenig Guthaben.");
          const repay = Math.min(1000, ud.loanOutstanding);
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0) - repay, loanOutstanding:(ud.loanOutstanding||0) - repay });
          tx.update(state.bankDoc, { funds:(bd.funds||0) + repay });
        });
        await logFeed("Leih-R√ºckzahlung -‚Ç¨1.000"); showToast("Leih-R√ºckzahlung -‚Ç¨1.000");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnTakeCredit").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const amt = Number(prompt("Kredit-Betrag (max. 100.000‚Ç¨):","10000")||0);
      if (!amt || amt<=0) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.creditOutstanding||0) + amt > 100_000) throw new Error("Kredit-Limit 100.000‚Ç¨.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+amt, creditOutstanding:(ud.creditOutstanding||0)+amt });
          tx.update(state.bankDoc, { funds:(bd.funds||0) - amt });
        });
        await logFeed("Kredit aufgenommen: "+EUR(amt)); showToast("Kredit aufgenommen: "+EUR(amt));
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnRepayCredit1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.creditOutstanding||0)<=0) throw new Error("Kein Kredit offen.");
          if ((ud.bankBalance||0) < 1000) throw new Error("Zu wenig Guthaben.");
          const pay = Math.min(1000, ud.creditOutstanding);
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-pay, creditOutstanding:(ud.creditOutstanding||0)-pay });
          tx.update(state.bankDoc, { funds:(bd.funds||0) + pay });
        });
        await logFeed("Kredit-R√ºckzahlung -‚Ç¨1.000"); showToast("Kredit-R√ºckzahlung -‚Ç¨1.000");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    // Aktien
    $("#btnBuyShares").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const qty = Math.trunc(Number($("#sharesQty").value||0));
      if (!Number.isFinite(qty) || qty<=0){ showToast("Bitte g√ºltige St√ºckzahl eingeben."); return; }
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc);
          const b = await tx.get(state.bankDoc);
          const ud = u.data();
          const bd = b.data();
          const price = (bd.stockPrice||100);
          const cost = Math.round(price*qty*100)/100;
          if ((ud.bankBalance||0) < cost) throw new Error("Zu wenig Guthaben.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-cost, shares:(ud.shares||0)+qty });
          tx.update(state.bankDoc,  { funds:(bd.funds||0)+cost });
        });
        await logFeed("Aktienkauf: +"+qty+" Stk."); showToast("Gekauft: "+qty+" Stk.");
      }catch(e){ showToast(e.message||"Fehler"); }
    };
    $("#btnSellShares").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const qty = Math.trunc(Number($("#sharesQty").value||0));
      if (!Number.isFinite(qty) || qty<=0){ showToast("Bitte g√ºltige St√ºckzahl eingeben."); return; }
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc);
          const b = await tx.get(state.bankDoc);
          const ud = u.data();
          const bd = b.data();
          const price = (bd.stockPrice||100);
          if ((ud.shares||0) < qty) throw new Error("Nicht genug Anteile.");
          const proceeds = Math.round(price*qty*100)/100;
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+proceeds, shares:(ud.shares||0)-qty });
          tx.update(state.bankDoc,  { funds:(bd.funds||0)-proceeds });
        });
        await logFeed("Aktienverkauf: -"+qty+" Stk."); showToast("Verkauft: "+qty+" Stk.");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    // H√§user (Demo)
    const HOUSES = [
      { id:"h1", name:"Klein Familien Haus", price:50_000, rent:2_500 },
      { id:"h2", name:"Mittel Familien Haus", price:75_000, rent:4_000 },
      { id:"h3", name:"Gro√ü Familien Haus", price:100_000, rent:6_000 },
      { id:"h4", name:"Dubai Villa", price:450_000, rent:15_000 },
      { id:"h5", name:"Luxus Villa", price:1_000_000, rent:50_000 }
    ];
    function renderHouses(u){ const wrap=$("#houseList"); wrap.innerHTML=""; HOUSES.forEach(h=>{ const owned=(u && u["own_"+h.id])||0; const el=document.createElement("div"); el.className="card"; el.innerHTML=`<div class="section-title">${h.name}</div><div class="row between"><small>Preis</small><b>${EUR(h.price)}</b></div><div class="row between"><small>Miete/Tag</small><b>${EUR(h.rent)}</b></div><div class="row between"><small>Besitz</small><b>${owned}</b></div><div class="row grid2" style="margin-top:.4rem"><button class="btn" data-buy="${h.id}">Kaufen</button><button class="btn" data-sell="${h.id}" ${owned?"":"disabled"}>Verkaufen</button></div>`; wrap.appendChild(el); }); $$("#houseList [data-buy]").forEach(b=> b.onclick = ()=> buyHouse(b.dataset.buy)); $$("#houseList [data-sell]").forEach(b=> b.onclick = ()=> sellHouse(b.dataset.sell)); }
    async function buyHouse(hid){ if (!state.userDoc) return openSheet(); const h=HOUSES.find(x=>x.id===hid); if(!h) return; try{ await txUpdate(async(tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud.bankBalance||0)<h.price) throw new Error("Zu wenig Guthaben."); const patch={}; patch["own_"+hid]=(ud["own_"+hid]||0)+1; tx.update(state.userDoc, Object.assign(patch,{bankBalance:(ud.bankBalance||0)-h.price})); tx.update(state.bankDoc,{funds:(bd.funds||0)+h.price}); }); await logFeed("Gekauft: "+h.name+" f√ºr "+EUR(h.price)); showToast("Gekauft: "+h.name);}catch(e){ showToast(e.message||"Fehler"); }}
    async function sellHouse(hid){ if (!state.userDoc) return openSheet(); const h=HOUSES.find(x=>x.id===hid); if(!h) return; try{ await txUpdate(async(tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud["own_"+hid]||0)<=0) throw new Error("Kein Besitz."); const patch={}; patch["own_"+hid]=(ud["own_"+hid]||0)-1; const refund=Math.round(h.price*0.8); tx.update(state.userDoc, Object.assign(patch,{bankBalance:(ud.bankBalance||0)+refund})); tx.update(state.bankDoc,{funds:(bd.funds||0)-refund}); }); await logFeed("Verkauft: "+h.name+" f√ºr "+EUR(h.price*0.8)); showToast("Verkauft: "+h.name);}catch(e){ showToast(e.message||"Fehler"); }}

    // ---- Chat ----
    function attachChat(){
      const qg = query(collection(db,"messages"), where("bank","==",state.bank), where("type","==","global"), orderBy("at","desc"), limit(50));
      onSnapshot(qg, (qs)=>{
        const box = $("#globalList"); box.innerHTML="";
        qs.forEach(d=>{ const m=d.data(); const div=document.createElement("div"); div.className="chat-bubble "+(m.from===state.user?.name?"mine":""); div.innerHTML=`<b>${m.from}</b><br>${m.text||""}`; box.appendChild(div); });
      });
      if (state.user){
        const qp = query(collection(db,"messages"), where("bank","==",state.bank), where("type","==","private"), orderBy("at","desc"), limit(50));
        onSnapshot(qp, (qs)=>{
          const box = $("#privateList"); box.innerHTML="";
          qs.forEach(d=>{ const m=d.data(); if (m.from===state.user.name || m.to===state.user.name){ const div=document.createElement("div"); div.className="chat-bubble "+(m.from===state.user?.name?"mine":""); div.innerHTML=`<b>${m.from} ‚ûú ${m.to}</b><br>${m.text||""}`; box.appendChild(div); } });
        });
      }
    }
    $("#sendGlobal").onclick = async ()=>{ const text=$("#globalMsg").value.trim(); if (!text) return; try{ if (!state.userDoc) return openSheet(); await ensureAuth(); await addDoc(collection(db,"messages"), { bank: state.bank, type:"global", text, from: state.user?.name||"?", at: serverTimestamp() }); $("#globalMsg").value=""; }catch(e){ showToast(e.message||"Fehler"); } };
    $("#sendPrivate").onclick = async ()=>{ const to=$("#pmTo").value.trim(); const text=$("#privateMsg").value.trim(); if (!to||!text) return; try{ if (!state.userDoc) return openSheet(); await ensureAuth(); await addDoc(collection(db,"messages"), { bank: state.bank, type:"private", to, text, from: state.user?.name||"?", at: serverTimestamp() }); $("#privateMsg").value=""; }catch(e){ showToast(e.message||"Fehler"); } };

    $("#tabGlobal").onclick = ()=>{ $("#tabGlobal").classList.add("active"); $("#tabPrivate").classList.remove("active"); $("#chatGlobal").classList.remove("hidden"); $("#chatPrivate").classList.add("hidden"); };
    $("#tabPrivate").onclick = ()=>{ $("#tabPrivate").classList.add("active"); $("#tabGlobal").classList.remove("active"); $("#chatPrivate").classList.remove("hidden"); $("#chatGlobal").classList.add("hidden"); };

    // User search
    async function findUserByName(nameLower){ const ref = doc(db, "users_index", nameLower); const snap = await getDoc(ref); return snap.exists() ? snap.data() : null; }
    const pmFindHint = $("#pmFindHint");
    const btnFind = $("#btnFindUser");
    if (btnFind){ btnFind.onclick = async ()=>{ const input=$("#pmTo"); const nameRaw=(input.value||"").trim(); const name=nameRaw.toLowerCase(); if (!name){ showToast("Bitte einen Namen eingeben."); return; } try{ await ensureAuth(); const data=await findUserByName(name); pmFindHint.textContent = data ? `‚úÖ Spieler gefunden in ${data.bank}` : `‚ùå Kein Spieler "${nameRaw}" gefunden.`; }catch(e){ pmFindHint.textContent = "Suche fehlgeschlagen."; } }; }

    // ----------- Bereich Navigation -----------
    function showArea(id){
      ["bankArea","slotsArea","houseArea","chatArea","jobArea","shopArea"].forEach(x=> { const el=$("#"+x); if(el) el.classList.add("hidden"); });
      const target=$("#"+id); if (target) target.classList.remove("hidden");
    }
    function requireLoginThen(areaId){
      if (!state.userDoc){ openSheet(); showToast("Bitte zuerst einloggen."); return; }
      showArea(areaId);
    }
    $("#btnSlots").onclick = ()=> requireLoginThen("slotsArea");
    $("#btnHouse").onclick = ()=> requireLoginThen("houseArea");
    $("#btnChat").onclick  = ()=> requireLoginThen("chatArea");
    $("#btnJob").onclick   = ()=> requireLoginThen("jobArea");
    $("#btnFirm").onclick  = ()=> requireLoginThen("firmArea");
    $("#btnShop").onclick  = ()=> requireLoginThen("shopArea");

    // ------- Slots helpers & games -------
    const SYMBOLS = ["üçã","üçí","üçá","üçÄ","‚≠ê","üîî","7Ô∏è‚É£","üçâ"];
    const stakes = [5,10,30,50,80,100];
    const SLOT_MIN_INTERVAL = 2000;
    let lastSlotAction = 0;
    function parseStake(selId){ return stakes.includes(Number($(selId).value)) ? Number($(selId).value) : 5; }
    function slotGuard() {
      const now = Date.now();
      const diff = now - lastSlotAction;
      if (diff < SLOT_MIN_INTERVAL) {
        const wait = Math.ceil((SLOT_MIN_INTERVAL - diff) / 1000);
        showToast(`Bitte noch ${wait}s warten‚Ä¶`);
        return false;
      }
      lastSlotAction = now;
      return true;
    }
    function setSlotsDisabled(disabled) {
      ["#btnHigher","#btnLower","#btnCF","#btnSpin","#btnAuto10","#btnBuyCase","#btnOpenCase"]
        .forEach(sel => { const el = document.querySelector(sel); if (el) el.disabled = disabled; });
    }
    function quickStatus(el, text) { if (el) { el.textContent = text; setTimeout(()=>{ if (el.textContent===text) el.textContent=""; }, 1200); } }
    async function spendCash(amount){ if (!state.userDoc) return openSheet(); await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud.cash||0)<amount) throw new Error("Zu wenig Bargeld. Bitte auszahlen."); tx.update(state.userDoc,{cash:(ud.cash||0)-amount}); tx.update(state.bankDoc,{funds:(bd.funds||0)+amount}); }); }
    async function payoutCash(amount){ if (!state.userDoc) return openSheet(); await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); tx.update(state.userDoc,{cash:(ud.cash||0)+amount}); tx.update(state.bankDoc,{funds:(bd.funds||0)-amount}); }); }

    // High/Lower
    let hlBusy=false;
    $("#btnHigher") && ($("#btnHigher").onclick = ()=> { if (!slotGuard()) return; playHL("higher"); });
    $("#btnLower")  && ($("#btnLower").onclick  = ()=> { if (!slotGuard()) return; playHL("lower");  });
    async function playHL(choice){
      if (hlBusy || !state.userDoc) { if (!state.userDoc) openSheet(); return; }
      hlBusy = true;
      setSlotsDisabled(true);
      quickStatus($("#hlStatus"), "‚Ä¶ wird gepr√ºft");
      const stake = parseStake("#stakeHL");
      try{
        await spendCash(stake);
        const dealer = 1+Math.floor(Math.random()*13);
        const you    = 1+Math.floor(Math.random()*13);
        $("#hlDealer").textContent = cardEmoji(dealer);
        $("#hlYou").textContent = cardEmoji(you);
        const win = choice==="higher" ? you>dealer : you<dealer;
        if (win){ await payoutCash(stake*2); $("#hlStatus").innerHTML = `<span style="color:var(--win)">Gewinn ${EUR(stake*2)}</span>`; await logFeed(`High/Lower Gewinn: ${EUR(stake)}`); }
        else    { $("#hlStatus").innerHTML = `<span style="color:var(--loss)">Verlust ${EUR(stake)}</span>`; await logFeed(`High/Lower Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#hlStatus").textContent="", 1500);
      }catch(e){ showToast(e.message||"Fehler"); }
      hlBusy=false;
      setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL);
    }
    function cardEmoji(v){ const faces = {1:"A",11:"J",12:"Q",13:"K"}; return "üÇ†"+(faces[v]||String(v)); }

    // Coinflip
    let cfBusy=false;
    $("#btnCF") && ($("#btnCF").onclick = async ()=>{
      if (!slotGuard()) return;
      if (cfBusy){ return; }
      if (!state.userDoc){ openSheet(); return; }
      cfBusy=true;
      quickStatus($("#cfStatus"), "‚Ä¶ wird geworfen");
      setSlotsDisabled(true);
      const stake = parseStake("#stakeCF");
      try{
        await spendCash(stake);
        const pick = $("#cfPick").value;
        const res = Math.random()<.5?"kopf":"zahl";
        $("#cfResult").textContent = res==="kopf"?"üôÇ":"ü™ô";
        if (pick===res){ await payoutCash(stake*2); $("#cfStatus").innerHTML = `<span style="color:var(--win)">Gewinn ${EUR(stake*2)}</span>`; await logFeed(`Kopf/Zahl Gewinn: ${EUR(stake)}`); }
        else            { $("#cfStatus").innerHTML = `<span style="color:var(--loss)">Verlust ${EUR(stake)}</span>`; await logFeed(`Kopf/Zahl Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#cfStatus").textContent="", 1500);
      }catch(e){ showToast(e.message||"Fehler"); }
      cfBusy=false;
      setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL);
    });

    // Triple Chance
    $("#btnSpin") && ($("#btnSpin").onclick = ()=>{
      if (!slotGuard()) return;
      quickStatus($("#tcStatus"), "‚Ä¶ dreht");
      setSlotsDisabled(true);
      spinOnce().finally(()=> setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL));
    });
    $("#btnAuto10") && ($("#btnAuto10").onclick = async ()=>{
      if (!slotGuard()) return;
      if (!state.userDoc){ openSheet(); return; }
      setSlotsDisabled(true);
      for (let i=0;i<10;i++){ await spinOnce(true); await sleep(160); }
      setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL);
    });
    async function spinOnce(fromAuto=false){
      if (!state.userDoc){ openSheet(); return; }
      const stake = parseStake("#stakeTC");
      try{
        if (!fromAuto) quickStatus($("#tcStatus"), "‚Ä¶ dreht");
        await spendCash(stake);
        const grid = $("#slotGrid").children;
        const picks=[];
        for (let i=0;i<9;i++){ const sym = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]; picks.push(sym); }
        for (let i=0;i<9;i++){ grid[i].classList.add("spin"); grid[i].textContent = picks[i]; await sleep(45); grid[i].classList.remove("spin"); }
        const lines=[[0,1,2],[3,4,5],[6,7,8],[0,4,8],[6,4,2]];
        let wins=0; lines.forEach(L=>{ if (picks[L[0]]===picks[L[1]] && picks[L[1]]===picks[L[2]]) wins++; });
        if (wins>0) { const payout = stake*5*wins; await payoutCash(payout); $("#tcStatus").textContent = `Gewinn ${EUR(payout)} (${wins} Linie${wins>1?"n":""})`; await logFeed(`TripleChance Gewinn: ${EUR(payout)} (${wins} Linien)`); }
        else { $("#tcStatus").textContent = `Verlust ${EUR(stake)}`; await logFeed(`TripleChance Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#tcStatus").textContent="", 1400);
      }catch(e){ showToast(e.message||"Fehler"); }
    }

    // CS:GO CASE (must buy before open)
    const CASE_ID = "";
    $("#caseId") && ($("#caseId").textContent = CASE_ID);
    const CASE_LOOT = [
      { name:"Graues Item",  weight:62, multiplier:0.0 },
      { name:"Blaues Item",  weight:28, multiplier:1.2 },
      { name:"Lila Item",    weight:7.5, multiplier:2.5 },
      { name:"Pink Item",    weight:2.0, multiplier:5.0 },
      { name:"Rotes Item",   weight:0.45, multiplier:12.0 },
      { name:"Gold (Knife)", weight:0.05, multiplier:48.0 },
    ];
    function stakeCase(){ return parseStake("#stakeCASE"); }
    function pickWeighted(){
      const total = CASE_LOOT.reduce((s,x)=>s+x.weight,0);
      let r = Math.random()*total;
      for(const it of CASE_LOOT){ if((r-=it.weight)<=0) return it; }
      return CASE_LOOT[0];
    }
    let hasCase = false;
    async function buyCase(){
      if (!state.userDoc) return openSheet();
      const stake = stakeCase();
      try{
        await spendCash(stake);
        hasCase = true;
        const openBtn = document.querySelector("#btnOpenCase"); if (openBtn) openBtn.disabled = false;
        $("#caseStatus").textContent = "Kiste gekauft.";
        await logFeed(`CS:GO-Kiste (${CASE_ID}) gekauft: Einsatz ${EUR(stake)}`);
      }catch(e){ showToast(e.message||"Fehler"); }
    }
    async function openCase(){
      if (!state.userDoc) return openSheet();
      if (!hasCase){ showToast("Bitte zuerst eine Kiste kaufen."); return; }
      const stake = stakeCase();
      try{
        const drop = pickWeighted();
        const win  = Math.round(stake * drop.multiplier);
        $("#casePrize").textContent = `Drop: ${drop.name} (${drop.multiplier}√ó) ‚Ä¢ Gewinn ${EUR(win)}`;
        if (win>0) await payoutCash(win);
        hasCase = false;
        const openBtn = document.querySelector("#btnOpenCase"); if (openBtn) openBtn.disabled = true;
        await logFeed(`CS:GO-Kiste ge√∂ffnet (${CASE_ID}): ${drop.name}, Gewinn ${EUR(win)}`);
      }catch(e){ showToast(e.message||"Fehler"); }
    }
    const btnBuyCase = $("#btnBuyCase");
    const btnOpenCase = $("#btnOpenCase");
    if (btnBuyCase)  btnBuyCase.onclick  = ()=> { if (!slotGuard()) return; setSlotsDisabled(true); buyCase().finally(()=> setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL)); };
    if (btnOpenCase) btnOpenCase.onclick = ()=> { if (!slotGuard()) return; setSlotsDisabled(true); openCase().finally(()=> setTimeout(()=>setSlotsDisabled(false), SLOT_MIN_INTERVAL)); };

    // ---- Job (daily) ----
    const JOB_MAX_HITS = 100;
    const JOB_TIME_MS = 60*1000; // 1 minute
    const JOB_PAY_PER_HIT = 20;
    let jobRunning=false, jobTarget=-1, jobHits=0, jobTimerId=null, jobTickId=null, jobEndsAt=0, jobAccrued=0;

    function buildJobGrid(){
      const grid = $("#jobGrid"); if (!grid) return;
      grid.innerHTML = "";
      for (let i=0;i<100;i++){ // 20 x 5
        const cell = document.createElement("div");
        cell.className = "job-cell";
        cell.dataset.idx = i;
        cell.onclick = ()=> handleJobClick(i);
        grid.appendChild(cell);
      }
    }
    buildJobGrid();

    function formatTime(ms){ const s=Math.max(0, Math.ceil(ms/1000)); const mm=String(Math.floor(s/60)).padStart(2,"0"); const ss=String(s%60).padStart(2,"0"); return mm+":"+ss; }
    function resetJobUI(){ jobHits=0; jobTarget=-1; jobAccrued=0; $("#jobHits").textContent="0"; $("#jobEarn").textContent="‚Ç¨0,00"; $("#jobTime").textContent="01:00"; [...$("#jobGrid").children].forEach(c=> c.classList.remove("target")); $("#btnStartJob").disabled=false; $("#btnEndJob").disabled=true; }
    async function canStartJobToday(){ if (!state.userDoc) return false; const snap = await getDoc(state.userDoc); const u = snap.data()||{}; const today = todayDE(); return (u.lastJob||"") !== today; }
    function spawnTarget(){ const cells=[...$("#jobGrid").children]; cells.forEach(c=> c.classList.remove("target")); jobTarget=Math.floor(Math.random()*cells.length); cells[jobTarget].classList.add("target"); }
    async function startJob(){ if (!state.userDoc){ openSheet(); return; } if(jobRunning) return; if(!(await canStartJobToday())){ showToast("Job schon erledigt ‚Äì morgen wieder ab 00:00."); return; } jobRunning=true; jobAccrued=0; $("#btnStartJob").disabled=true; $("#btnEndJob").disabled=false; jobEndsAt=Date.now()+JOB_TIME_MS; spawnTarget(); jobTimerId=setTimeout(()=> endJob(), JOB_TIME_MS); jobTickId=setInterval(()=>{ const left=jobEndsAt-Date.now(); $("#jobTime").textContent=formatTime(left); },250); }
    async function endJob(){ if(!jobRunning) return; jobRunning=false; clearTimeout(jobTimerId); jobTimerId=null; clearInterval(jobTickId); jobTickId=null; [...$("#jobGrid").children].forEach(c=> c.classList.remove("target")); const maxEarn=JOB_MAX_HITS*(JOB_PAY_PER_HIT+(state.user?.jobToolBonus||0)); const earnings=Math.min(jobAccrued, maxEarn); try{ await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const ud=u.data(); const today=todayDE(); if ((ud.lastJob||"")===today) throw new Error("Job heute bereits abgerechnet."); tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+earnings, lastJob: today }); }); $("#jobEarn").textContent = EUR(earnings); await logFeed(`Job erledigt: +${EUR(earnings)} (${jobHits} Treffer)`); showToast(`Job beendet: ${EUR(earnings)}`); }catch(e){ showToast(e.message||"Fehler"); } resetJobUI(); }
    function handleJobClick(idx){ if(!jobRunning) return; if(idx===jobTarget){ const cells=[...$("#jobGrid").children]; const cell=cells[jobTarget]; if(cell){ cell.classList.add("burst"); setTimeout(()=> cell.classList.remove("burst"), 200); } jobHits++; const rate = JOB_PAY_PER_HIT + (state.user?.jobToolBonus||0); jobAccrued += rate; $("#jobHits").textContent=String(jobHits); $("#jobEarn").textContent=EUR(jobAccrued); if(jobHits>=JOB_MAX_HITS){ endJob(); return; } setTimeout(()=> spawnTarget(), 120); } }
    $("#btnStartJob").onclick = startJob;
    $("#btnEndJob").onclick = endJob;

    // ---- Job tools (pickaxes) ----
    const JOB_TOOLS = [
      { id:0, key:"hand",      name:"Hand",           cost:0,       bonus:0,    color:"#e5e7eb" },
      { id:1, key:"wood",      name:"Holz Spitzhacke",cost:10000,   bonus:10,   color:"#b45309" },
      { id:2, key:"iron",      name:"Eisen Spitzhacke",cost:25000,  bonus:30,   color:"#4b5563" },
      { id:3, key:"diamond",   name:"Diamant Spitzhacke",cost:50000,bonus:50,   color:"#06b6d4" },
      { id:4, key:"netherite", name:"Netherrite Spitzhacke",cost:100000,bonus:200,color:"#4c1d95" },
      { id:5, key:"ultra",     name:"Ultra Spitzhacke",cost:1000000,bonus:1000, color:"#ca8a04" },
    ];
    function toolById(id){ return JOB_TOOLS.find(t=>t.id===id)||JOB_TOOLS[0]; }

    function renderShop(u){
      const wrap = $("#toolList"); if (!wrap) return;
      wrap.innerHTML="";
      const cashNow = (u.cash||0);
      const rateNow = 20 + (toolById(u.jobTool||0).bonus||0);
      const shopRate = $("#shopRate"); if (shopRate) shopRate.textContent = EUR(rateNow);
      JOB_TOOLS.filter(t=>t.id>0).forEach(t=>{
        const owned = (u.jobTool||0) === t.id;
        const afford = cashNow >= t.cost;
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="row between">
            <div class="row" style="gap:.6rem">
              <div style="width:42px;height:42px;border-radius:10px;background:${t.color}22;border:2px solid ${t.color};display:flex;align-items:center;justify-content:center;font-size:22px">‚õèÔ∏è</div>
              <div class="col">
                <div class="section-title" style="margin:0">${t.name}</div>
                <small>+${EUR(t.bonus)} pro Treffer</small>
              </div>
            </div>
            <div class="col tool-right" style="align-items:flex-end">
              <b>${EUR(t.cost)}</b>
              <button class="btn ${owned?'':'primary'}" data-buy="${t.id}" ${owned||!afford?'disabled':''} title="${owned?'Bereits aktiv':(afford?'Kaufen':'Zu wenig Bargeld (üíµ)')}">${owned?'Aktiv':(afford?'Kaufen':'Zu wenig üíµ')}</button>
            </div>
          </div>`;
        wrap.appendChild(card);
      });
      $$("#toolList [data-buy]").forEach(b=> b.onclick = ()=> buyTool(Number(b.dataset.buy)));
    }

    async function buyTool(id){
      if (!state.userDoc) return openSheet();
      const tool = toolById(id); if (!tool) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.cash||0) < tool.cost) throw new Error("Zu wenig Bargeld.");
          tx.update(state.userDoc, { cash:(ud.cash||0)-tool.cost, jobTool: tool.id });
          tx.update(state.bankDoc, { funds:(bd.funds||0)+tool.cost });
        });
        await logFeed(`Gekauft: ${tool.name} (${EUR(tool.cost)})`);
        showToast(`${tool.name} aktiviert!`);
      }catch(e){ showToast(e.message||"Fehler"); }
    }

  
    // ---------- Firma (Company) ----------
    let firmRef = null, firmBankRef = null, firmData = null;
    const FIRM_BANK_ID = "UnternehmensBank";

    async function ensureFirmBankDoc(){
      await ensureAuth();
      const ref = doc(db, "banks", FIRM_BANK_ID);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        await setDoc(ref, { name: "UnternehmensBank", funds: 5_000_000, lastStockUpdate: Date.now(), stockPrice: 100 });
      }
      firmBankRef = ref;
    }

    function firmDocRef(){ if(!state.userDoc) return null; return doc(db, "companies", state.userDoc.id); }

    function renderFirm(){
      const has = !!firmData;
      $("#firmWizard").classList.toggle("hidden", has);
      $("#firmDash").classList.toggle("hidden", !has);
      if (!has) return;
      $("#firmName").textContent = firmData.name || "‚Äî";
      $("#firmBusiness").textContent = firmData.business || (firmData.type==="legal"?"Legales Unternehmen":"Illegales Unternehmen");
      $("#firmFunds").textContent = EUR(firmData.funds||0);
      $("#firmLoan").textContent  = EUR(firmData.loanOutstanding||0);
      $("#firmDailyHint").textContent = (firmData.lastDaily===todayDE()) ? "Heute bereits abgerechnet." : ((firmData.type==="legal")?"Heute f√§llig: Steuer ‚Ç¨1.000 + L√∂hne":"Heute f√§llig: Schmiergeld ‚Ç¨1.000 + L√∂hne");
      $("#firmCreditHint").textContent = `Heute Kredit m√∂glich: ‚Ç¨${Math.max(0, 5000-(firmData.dailyCreditTaken||0)).toLocaleString("de-DE")}, Gesamt-Limit bis ‚Ç¨100.000 offen.`;
      $("#stockRaw").textContent   = String(firmData.stock_raw||0);
      $("#stockProc").textContent  = String(firmData.stock_proc||0);
      $("#stockStore").textContent = String(firmData.stock_store||0);
      $("#stockCheck").textContent = String(firmData.stock_check||0);
      renderWorkers();
    }

    async function attachFirm(){
      if (!state.userDoc) return;
      await ensureFirmBankDoc();
      firmRef = firmDocRef();
      const snap = await getDoc(firmRef);
      firmData = snap.exists() ? snap.data() : null;
      renderFirm();
      const unsub = onSnapshot(firmRef, (d)=>{ firmData = d.data()||null; renderFirm(); });
      state.listeners.push(unsub);
    }

    function requireFirmFunds(amount){
      if ((firmData?.funds||0) < amount) { showToast("Zu wenig Firmen-Geld."); return false; }
      return true;
    }

    // --- Wizard actions ---
    $("#btnBuyLegal").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      if ((state.user?.bankBalance||0) < 100000){ showToast("Du brauchst ‚Ç¨100.000 auf dem Konto."); return; }
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const bd = await tx.get(firmBankRef);
          const ud = u.data(); const bankd = bd.data();
          if ((ud.bankBalance||0) < 100000) throw new Error("Zu wenig Guthaben.");
          const base = { owner: state.userDoc.id, type:"legal", business:"", name:"", funds: 10000, lastDaily:"", employees:[], loanOutstanding:0, dailyCreditTaken:0, stock_raw:0, stock_proc:0, stock_store:0, stock_check:0 };
          tx.set(firmRef, base);
          tx.update(state.userDoc, { bankBalance: (ud.bankBalance||0)-100000 });
          tx.update(firmBankRef,   { funds: (bankd.funds||0)+100000 });
        });
        showToast("Legales Unternehmen gegr√ºndet. W√§hle nun eine Branche.");
        $("#legalKinds").classList.remove("hidden");
        $("#illegalKinds").classList.add("hidden");
      }catch(e){ showToast(e.message||"Fehler"); }
    };
    $("#btnBuyIllegal").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      if ((state.user?.bankBalance||0) < 100000){ showToast("Du brauchst ‚Ç¨100.000 auf dem Konto."); return; }
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const bd = await tx.get(firmBankRef);
          const ud = u.data(); const bankd = bd.data();
          if ((ud.bankBalance||0) < 100000) throw new Error("Zu wenig Guthaben.");
          const base = { owner: state.userDoc.id, type:"illegal", business:"", name:"", funds: 10000, lastDaily:"", employees:[], loanOutstanding:0, dailyCreditTaken:0, stock_raw:0, stock_proc:0, stock_store:0, stock_check:0 };
          tx.set(firmRef, base);
          tx.update(state.userDoc, { bankBalance: (ud.bankBalance||0)-100000 });
          tx.update(firmBankRef,   { funds: (bankd.funds||0)+100000 });
        });
        showToast("Illegales Unternehmen gegr√ºndet. W√§hle nun eine Branche.");
        $("#illegalKinds").classList.remove("hidden");
        $("#legalKinds").classList.add("hidden");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    // choose kind
    $$("#legalKinds .btn, #illegalKinds .btn").forEach(b=> b.onclick = async ()=>{
      if (!firmDocRef()) return;
      const kind = b.dataset.kind;
      const name = prompt("Firmenname eingeben:");
      try{
        await updateDoc(firmDocRef(), { business: kind, name: name||"Meine Firma" });
        showToast("Unternehmen eingerichtet.");
        await attachFirm();
      }catch(e){ showToast(e.message||"Fehler"); }
    });

    function incomeRange(prestige, level){
      const p = prestige||0, l = level||1;
      const min = 100 + 1000*p + 200*(l-1);
      return [min, min+200];
    }

    // --- Daily settlement
    async function firmDaily(){
      if (!firmData){ showToast("Kein Unternehmen vorhanden."); return; }
      const today = todayDE();
      if ((firmData.lastDaily||"") === today){ showToast("Heute bereits abgerechnet."); return; }
      const workers = firmData.employees||[];
      const salaries = workers.length * 200;
      const fixedTax = 1000;
      // income from workers
      let income = 0;
      const newWorkers = workers.map(w=>{
        const [mn, mx] = incomeRange(w.prestige||0, w.level||1);
        const add = Math.floor(mn + Math.random()*(mx-mn));
        income += add;
        // XP/Level
        let xp = (w.xp||0)+1, level = (w.level||1), prestige=(w.prestige||0);
        if (xp>=5 && level<5){ level++; xp=0; }
        return Object.assign({}, w, { xp, level, prestige });
      });
      const net = income - (salaries + fixedTax);
      try{
        await txUpdate(async (tx)=>{
          const f = await tx.get(firmDocRef());
          const b = await tx.get(firmBankRef);
          const fd = f.data(); const bd = b.data();
          const fundsNow = (fd.funds||0) + net;
          tx.update(firmDocRef(), { funds: fundsNow, employees: newWorkers, lastDaily: today });
          tx.update(firmBankRef, { funds: (bd.funds||0) + fixedTax + (workers.length*200) });
        });
        showToast(`Abgerechnet: +${EUR(income)} Einnahmen ‚àí ${EUR(salaries)} L√∂hne ‚àí ${EUR(1000)} ${(firmData.type==="legal"?"Steuer":"Schmiergeld")}`);
      }catch(e){ showToast(e.message||"Fehler"); }
    }
    $("#btnDoDaily").onclick = firmDaily;

    // --- Workers
    function renderWorkers(){
      const box = $("#workerList"); if (!box) return;
      box.innerHTML="";
      const workers = firmData?.employees||[];
      if (workers.length===0){ box.innerHTML = "<small>Noch keine Mitarbeiter.</small>"; return; }
      workers.forEach((w,i)=>{
        const p = w.prestige||0, l=w.level||1, xp=w.xp||0;
        const title = (w.name||"Mitarbeiter");
        const pre = p>0 ? ` ‚Ä¢ Prestige ${p}` : "";
        const barPct = Math.round((xp/5)*100);
        const row = document.createElement("div");
        row.className = "card";
        row.innerHTML = `
          <div class="row between">
            <div class="col"><b>${title}</b><small>Level ${l}${pre}</small></div>
            <div class="row" style="gap:.4rem">
              <button class="btn small" data-rename="${i}">Umbenennen</button>
              ${ (l>=5 && p<5) ? `<button class="btn warn small" data-prestige="${i}">Prestige ‚Ç¨1.000.000</button>` : ""}
            </div>
          </div>
          <div style="height:10px;background:#e5e7eb;border-radius:999px;margin-top:.4rem">
            <div style="height:10px;width:${barPct}%;background:#16a34a;border-radius:999px"></div>
          </div>
        `;
        box.appendChild(row);
      });
      $$("#workerList [data-rename]").forEach(b=> b.onclick = async ()=>{
        const idx = Number(b.dataset.rename);
        const nm = prompt("Neuer Name f√ºr Mitarbeiter:");
        if (!nm) return;
        const snap = await getDoc(firmDocRef()); const d = snap.data()||{};
        const arr = [...(d.employees||[])];
        arr[idx] = Object.assign({}, arr[idx], { name: nm });
        await updateDoc(firmDocRef(), { employees: arr });
      });
      $$("#workerList [data-prestige]").forEach(b=> b.onclick = async ()=>{
        const idx = Number(b.dataset.prestige);
        const snap = await getDoc(firmDocRef()); const d = snap.data()||{};
        if ((d.funds||0) < 1_000_000){ showToast("Zu wenig Firmen-Geld."); return; }
        const arr = [...(d.employees||[])];
        const w = Object.assign({}, arr[idx]);
        if ((w.level||1) < 5){ showToast("Erst Level 5 erreichen."); return; }
        if ((w.prestige||0) >= 5){ showToast("Max Prestige erreicht."); return; }
        w.prestige = (w.prestige||0)+1; w.level=1; w.xp=0;
        arr[idx]=w;
        await updateDoc(firmDocRef(), { employees: arr, funds: (d.funds||0) - 1_000_000 });
        showToast("Prestige gekauft.");
      });
    }

    $("#btnAddWorker").onclick = async ()=>{
      if (!firmData){ showToast("Zuerst Unternehmen gr√ºnden."); return; }
      const snap = await getDoc(firmDocRef()); const d = snap.data()||{};
      if ((d.funds||0) < 3500){ showToast("Zu wenig Firmen-Geld."); return; }
      const arr = [...(d.employees||[])];
      arr.push({ name:"Mitarbeiter", level:1, prestige:0, xp:0 });
      await updateDoc(firmDocRef(), { employees: arr, funds:(d.funds||0)-3500 });
      const b = await getDoc(firmBankRef); const bd=b.data()||{};
      await updateDoc(firmBankRef, { funds:(bd.funds||0)+3500 });
      showToast("Mitarbeiter gekauft.");
    };

    // --- Goods pipeline
    async function processTimed(fromKey, toKey, qty, perMs){
      for (let i=0;i<qty;i++){
        await new Promise(r=> setTimeout(r, perMs));
        const snap = await getDoc(firmDocRef());
        const d = snap.data()||{};
        if ((d[fromKey]||0) <= 0) continue;
        await updateDoc(firmDocRef(), { [fromKey]: (d[fromKey]||0)-1, [toKey]: (d[toKey]||0)+1 });
      }
    }
    $("#btnBuyGoods").onclick = async ()=>{
      const n = Math.trunc(Number($("#buyQty").value||0)); if (n<=0) return;
      const cost = 1000*n;
      const snap = await getDoc(firmDocRef()); const d = snap.data()||{};
      if ((d.funds||0) < cost){ showToast("Zu wenig Firmen-Geld."); return; }
      await updateDoc(firmDocRef(), { funds:(d.funds||0)-cost, stock_raw:(d.stock_raw||0)+n });
      const b = await getDoc(firmBankRef); const bd=b.data()||{};
      await updateDoc(firmBankRef, { funds:(bd.funds||0)+cost });
      showToast(`Gekauft: ${n} Rohware`);
    };
    $("#btnProcess").onclick = async ()=>{
      const n = Math.trunc(Number($("#procQty").value||0)); if (n<=0) return;
      await processTimed("stock_raw","stock_proc", n, 2000);
    };
    $("#btnStore").onclick = async ()=>{
      const n = Math.trunc(Number($("#storeQty").value||0)); if (n<=0) return;
      await processTimed("stock_proc","stock_store", n, 3000);
    };
    $("#btnCheck").onclick = async ()=>{
      const n = Math.trunc(Number($("#checkQty").value||0)); if (n<=0) return;
      await processTimed("stock_store","stock_check", n, 2000);
    };
    $("#btnSell").onclick = async ()=>{
      const n = Math.trunc(Number($("#sellQty").value||0)); if (n<=0) return;
      const snap = await getDoc(firmDocRef()); const d = snap.data()||{};
      const can = Math.min(n, d.stock_check||0);
      if (can<=0){ showToast("Keine gepr√ºfte Ware."); return; }
      const revenue = 1500*can;
      await updateDoc(firmDocRef(), { stock_check:(d.stock_check||0)-can, funds:(d.funds||0)+revenue });
      showToast(`Verkauft: ${can} St√ºck f√ºr ${EUR(revenue)}`);
    };

    // --- Company credit & payout
    $("#btnFirmCredit").onclick = async ()=>{
      const snap = await getDoc(firmDocRef()); const d = snap.data()||{};
      const taken = d.dailyCreditTaken||0;
      if (taken >= 5000){ showToast("Tageslimit 5.000‚Ç¨ erreicht."); return; }
      const take = Math.min(5000, 5000 - taken);
      if ((d.loanOutstanding||0) + take*1.2 > 100000){ showToast("Kredit-Limit 100.000‚Ç¨ erreicht."); return; }
      const tax = Math.round(take*0.05);
      await updateDoc(firmDocRef(), {
        funds:(d.funds||0) + (take - tax),
        loanOutstanding:(d.loanOutstanding||0) + Math.round(take*1.20),
        dailyCreditTaken: taken + take
      });
      const b = await getDoc(firmBankRef); const bd=b.data()||{};
      await updateDoc(firmBankRef, { funds:(bd.funds||0)+tax });
      showToast(`Kredit genommen: ${EUR(take)} (5% ${(d.type==="legal"?"Steuer":"Schmiergeld")})`);
    };
    $("#btnFirmRepay").onclick = async ()=>{
      const snap = await getDoc(firmDocRef()); const d = snap.data()||{};
      const due = Math.min(1000, d.loanOutstanding||0);
      if (due<=0){ showToast("Kein Kredit offen."); return; }
      if ((d.funds||0) < due){ showToast("Zu wenig Firmen-Geld."); return; }
      await updateDoc(firmDocRef(), { loanOutstanding:(d.loanOutstanding||0)-due, funds:(d.funds||0)-due });
      showToast("Kredit -‚Ç¨1.000");
    };
    $("#btnFirmPayout").onclick = async ()=>{
      const amt = Math.trunc(Number($("#firmSalaryAmt").value||0)); if (amt<=0) return;
      if (amt > 1_000_000){ showToast("Max ‚Ç¨1.000.000 pro Tag."); return; }
      const f = await getDoc(firmDocRef()); const fd=f.data()||{};
      if ((fd.funds||0) < amt){ showToast("Zu wenig Firmen-Geld."); return; }
      const u = await getDoc(state.userDoc); const ud=u.data()||{};
      await updateDoc(firmDocRef(), { funds:(fd.funds||0)-amt });
      await updateDoc(state.userDoc, { bankBalance:(ud.bankBalance||0)+amt });
      showToast(`Lohn ausgezahlt: ${EUR(amt)}`);
    };

    // Attach after user
    const _origAttachUser = attachUser;
    attachUser = async function(userRef){
      await _origAttachUser(userRef);
      await ensureFirmBankDoc();
      await attachFirm();
    };


// ===== Test Cheat: STRG+ALT+# -> +‚Ç¨100.000 Bargeld =====
async function cheatAddCash(amount){
  if (!state.userDoc){ 
    try { openSheet(); } catch(_) {}
    showToast("Bitte zuerst einloggen (Cheat)");
    return; 
  }
  try {
    await txUpdate(async (tx) => {
      const u = await tx.get(state.userDoc);
      const ud = u.data() || {};
      tx.update(state.userDoc, { cash: (ud.cash || 0) + amount });
    });
    await logFeed("Cheat aktiviert: +" + EUR(amount) + " Bargeld");
    showToast("Cheat: +" + EUR(amount) + " Bargeld");
  } catch (e) {
    console.error(e);
    try { showToast("Cheat-Fehler: " + (e?.message || "")); } catch(_){}
  }
}

// robust key check for German layout: detect Ctrl+Alt (or AltGr) + '#'
document.addEventListener("keydown", (e) => {
  const isAltGraph = (typeof e.getModifierState === "function") && e.getModifierState("AltGraph");
  const withMods = (e.ctrlKey && e.altKey) || isAltGraph;
  const keyIsHash = (e.key === "#") || (e.code === "Backslash") || (e.code === "IntlRo");
  if (withMods && keyIsHash) {
    e.preventDefault();
    cheatAddCash(100000);
  }
});
// ===== End Test Cheat =====


// === Triple Chance Jackpot (restore) ===
// Shared jackpot state per user (persisted in userDoc)
if (typeof state === "object") {
  state.slot = state.slot || {};
  state.slot.triple = state.slot.triple || {};
}
const JP_KEY = "slot_triple_jackpot";

async function getJackpot() {
  try {
    if (!state.userDoc) return 0;
    const snap = await getDoc(state.userDoc);
    const d = snap.data() || {};
    return Number(d[JP_KEY] || 0);
  } catch(e){ console.error("getJackpot", e); return 0; }
}

async function setJackpot(v) {
  try {
    if (!state.userDoc) return;
    await updateDoc(state.userDoc, { [JP_KEY]: Math.max(0, Math.round(v)) });
  } catch(e){ console.error("setJackpot", e); }
}

async function addToJackpot(v){
  try {
    if (!state.userDoc) return;
    await txUpdate(async (tx) => {
      const u = await tx.get(state.userDoc);
      const d = u.data() || {};
      const nv = Math.max(0, Number(d[JP_KEY] || 0) + Number(v||0));
      tx.update(state.userDoc, { [JP_KEY]: nv });
    });
  } catch(e){ console.error("addToJackpot", e); }
}

// Hook spin resolution for Triple Chance. We try to wrap existing resolve function if present.
async function slotTripleChance_spin(costPerSpin, outcome){
  // 1) take stake -> 5% to jackpot
  const fee = Math.round(costPerSpin * 0.05);
  if (fee > 0) await addToJackpot(fee);

  // 2) if outcome signals JACKPOT, pay jackpot and reset
  if (outcome && (outcome.winType === "JACKPOT" || outcome.jackpot === true)) {
    const jp = await getJackpot();
    if (jp > 0) {
      await txUpdate(async (tx) => {
        const u = await tx.get(state.userDoc);
        const d = u.data() || {};
        tx.update(state.userDoc, { cash: Math.round((d.cash||0) + jp), [JP_KEY]: 0 });
      });
      try { 
        showToast("JACKPOT! +" + EUR(jp)); 
        await logFeed("Triple Chance JACKPOT: +" + EUR(jp));
      } catch(_){}
    }
  }
}

// Try to monkey-patch a known spin function
(function(){
  const g = (typeof window !== "undefined") ? window : globalThis;
  const origSpin = g.tripleChanceSpin || g.slotTripleSpin || null;
  if (!g.__tripleJackpotPatched) {
    g.__tripleJackpotPatched = true;
    g.tripleChanceSpin = async function(costPerSpin, ...rest){
      let outcome = null;
      try { outcome = await (origSpin ? origSpin.apply(this, [costPerSpin, ...rest]) : null); } catch(e){ console.error(e); }
      try { await slotTripleChance_spin(Number(costPerSpin||0), outcome||{}); } catch(e){ console.error(e); }
      return outcome;
    };
  }
})();
// === End Triple Chance Jackpot ===


// === CS:GO Crates Purchase Counter ===
const CSGO_COUNTER_KEY = "csgo_crates_bought";

async function getCsgoCounter(){
  try{
    if (!state.userDoc) return 0;
    const snap = await getDoc(state.userDoc);
    const d = snap.data() || {};
    return Number(d[CSGO_COUNTER_KEY] || 0);
  } catch(e){ console.error(e); return 0; }
}

async function incCsgoCounter(n=1){
  try{
    if (!state.userDoc) return;
    await txUpdate(async (tx) => {
      const u = await tx.get(state.userDoc);
      const d = u.data() || {};
      tx.update(state.userDoc, { [CSGO_COUNTER_KEY]: Number(d[CSGO_COUNTER_KEY]||0) + Number(n||0) });
    });
    // also update UI if present
    updateCsgoCounterBadge();
  }catch(e){ console.error(e); }
}

function mountCsgoCounterBadge(){
  try{
    const host = document.querySelector("[data-csgo-bar]") || document.querySelector("#csgo-bar") || document.body;
    if (!host) return;
    let badge = document.querySelector("#csgoCounterBadge");
    if (!badge){
      badge = document.createElement("div");
      badge.id = "csgoCounterBadge";
      badge.style.position = "absolute";
      badge.style.top = "8px";
      badge.style.right = "8px";
      badge.style.padding = "6px 10px";
      badge.style.borderRadius = "999px";
      badge.style.fontWeight = "600";
      badge.style.boxShadow = "0 2px 8px rgba(0,0,0,.25)";
      badge.style.background = "var(--panel, #101622)";
      badge.style.color = "var(--text, #e7edf3)";
      badge.style.border = "1px solid var(--line, #1b2433)";
      badge.title = "Gekaufte CS:GO Kisten (gesamt)";
      badge.textContent = "CS:GO Kisten: 0";
      host.appendChild(badge);
    }
  }catch(e){ console.error(e); }
}

async function updateCsgoCounterBadge(){
  try{
    const badge = document.querySelector("#csgoCounterBadge");
    if (!badge) return;
    const val = await getCsgoCounter();
    badge.textContent = "CS:GO Kisten: " + val;
  }catch(e){ console.error(e); }
}

// Patch common buy/open functions
(function(){
  const g = (typeof window !== "undefined") ? window : globalThis;
  const origBuy = g.buyCsgoCrate || g.csgoBuy || g.openCsgoCrate || null;
  if (!g.__csgoCounterPatched){
    g.__csgoCounterPatched = true;
    g.buyCsgoCrate = async function(...args){
      let res = null;
      try { res = await (origBuy ? origBuy.apply(this, args) : null); } catch(e){ console.error(e); }
      try { await incCsgoCounter(1); } catch(e){ console.error(e); }
      return res;
    };
  }
  // mount UI after DOM ready
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", () => { mountCsgoCounterBadge(); updateCsgoCounterBadge(); });
  } else {
    mountCsgoCounterBadge(); updateCsgoCounterBadge();
  }
})();
// === End CS:GO Counter ===











// Ensure any top button bar stays sticky/fixed
(function(){
  function stickify(){
    const candidates = Array.from(document.querySelectorAll("header, #topBar, .topbar, .toolbar, .nav-buttons"));
    candidates.forEach(el=>{
      el.style.position = "sticky";
      el.style.top = "0";
      el.style.zIndex = "1100";
      el.style.backdropFilter = "blur(10px)";
      el.style.background = "rgba(6,7,21,.82)";
      el.style.borderBottom = "1px solid var(--line)";
    });
    // Add top padding to main containers to avoid overlap if any fixed/sticky headers
    const main = document.querySelector("main") || document.querySelector("#app") || document.querySelector(".content") || document.body;
    if (main && !main.__padOnce){
      main.__padOnce = true;
      const padTop = parseInt(getComputedStyle(main).paddingTop || "0", 10);
      if (padTop < 72) main.style.paddingTop = "72px";
    }
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", stickify);
  else stickify();
})();


// === Unternehmen's Ware purchase logic ===
(function(){
  const KEY = "firm_goods_count";
  async function getFirmGoods(){
    try{
      if (!state?.userDoc) return 0;
      const snap = await getDoc(state.userDoc);
      const d = snap.data()||{};
      return Number(d[KEY]||0);
    }catch(e){ console.error(e); return 0; }
  }
  async function incFirmGoods(n=1){
    try{
      if (!state?.userDoc) return;
      await txUpdate(async (tx)=>{
        const u = await tx.get(state.userDoc);
        const d = u.data()||{};
        tx.update(state.userDoc, { [KEY]: Number(d[KEY]||0) + Number(n||0) });
      });
      updateFirmGoodsUI();
    }catch(e){ console.error(e); }
  }
  async function updateFirmGoodsUI(){
    try{
      const box = document.querySelector("#firmGoodsCount");
      if (!box) return;
      const v = await getFirmGoods();
      box.textContent = "x" + v;
    }catch(e){}
  }
  async function buyFirmGoods(){
    if (!state?.userDoc){ try{ openSheet(); }catch(_){ } return; }
    const price = 1000; const raw = (document.querySelector('#firmGoodsQty')?.value)||'1'; const qty = Math.max(1, parseInt(raw,10)||1);
    try{
      await spendCash(price*qty); // uses existing 50/50 split logic
      await incFirmGoods(qty);
      try{ showToast("Unternehmen's Ware gekauft: ‚Ç¨" + (price*qty).toLocaleString("de-DE")); }catch(_){}
      try{ await logFeed("Unternehmen's Ware gekauft ‚Äì ‚Ç¨" + (price*qty).toLocaleString("de-DE")); }catch(_){}
    }catch(e){
      console.error(e);
      try{ showToast("Kauf fehlgeschlagen: " + (e?.message||"")); }catch(_){}
    }
  }
  function bind(){
    const btn = document.querySelector("#btnBuyFirmGoods");
    if (btn && !btn.__boundFirm){
      btn.__boundFirm = true;
      btn.addEventListener("click", buyFirmGoods);
    }
  }
  const init = ()=>{ bind(); updateFirmGoodsUI(); };
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
  setInterval(()=>{ bind(); updateFirmGoodsUI(); }, 5000);
})();
// === End Unternehmen's Ware ===


// Bind topbar Bank button to open bank area
(function(){
  const el = document.querySelector("#btnBank");
  if (el && !el.__bound){
    el.__bound = true;
    el.addEventListener("click", ()=> { showArea && showArea("bankArea"); }, false);
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ()=>{
      const e = document.querySelector("#btnBank");
      if (e && !e.__bound){
        e.__bound = true; e.addEventListener("click", ()=> { showArea && showArea("bankArea"); });
      }
    });
  }
})();


// === Triple Chance dedicated jackpot (50/50 per spin) ===
(function(){
  const JP_KEY = "slot_triple_jackpot";
  const g = (typeof window!=="undefined") ? window : globalThis;

  // Remove previous global split override if present
  try{
    if (g.__spendCashSplit50) { g.__spendCashSplit50 = false; }
  }catch(_){}

  async function getTcJackpot(){
    try{
      if (!state?.userDoc) return 0;
      const snap = await getDoc(state.userDoc);
      const d = snap.data()||{};
      return Number(d[JP_KEY]||0);
    }catch(e){ console.error(e); return 0; }
  }
  async function setTcJackpot(v){
    try{
      if (!state?.userDoc) return;
      await updateDoc(state.userDoc, { [JP_KEY]: Math.max(0, Math.round(Number(v||0))) });
    }catch(e){ console.error(e); }
  }
  async function addTcJackpot(v){
    try{
      if (!state?.userDoc) return;
      await txUpdate(async (tx)=>{
        const u = await tx.get(state.userDoc);
        const d = u.data()||{};
        tx.update(state.userDoc, { [JP_KEY]: Math.max(0, Number(d[JP_KEY]||0) + Number(v||0)) });
      });
    }catch(e){ console.error(e); }
  }
  function parseStakeTC(){
    const sel = document.querySelector("#stakeTC");
    if (!sel) return 0;
    const n = Number((sel.value||"0").replace(",", "."));
    return isNaN(n) ? 0 : n;
  }
  async function refreshTcJackpotLabel(){
    const el = document.querySelector("#tcJackpot");
    if (!el) return;
    const v = await getTcJackpot();
    try{ el.textContent = EUR(v); } catch(_){ el.textContent = "‚Ç¨"+(v||0).toLocaleString("de-DE"); }
  }

  // Monkey-patch spendCash ONLY while Triple Chance spin is running.
  const origSpend = g.spendCash;
  g.__tcSplitActive = false;
  g.spendCash = async function(amount){
    if (g.__tcSplitActive){
      // custom split: 50% to TC jackpot, 50% to bank
      if (!state?.userDoc || !state?.bankDoc) { try{ openSheet(); }catch(_){}; return; }
      amount = Math.max(0, Number(amount||0));
      if (!amount) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc);
          const b = await tx.get(state.bankDoc);
          const ud = u.data()||{}; const bd = b.data()||{};
          if ((ud.cash||0) < amount) throw new Error("Nicht genug Bargeld");
          const half = Math.floor(amount/2);
          const rest = amount - half;
          tx.update(state.userDoc, { cash: (ud.cash||0) - amount, [JP_KEY]: Math.max(0, Number(ud[JP_KEY]||0) + half) });
          tx.update(state.bankDoc, { funds: (bd.funds||0) + rest });
        });
        try{ showToast("Triple Chance Einsatz: 50% Jackpot / 50% Bank"); }catch(_){}
        // immediate label refresh
        setTimeout(refreshTcJackpotLabel, 250);
      }catch(e){
        console.error("TC split spend", e);
        // fallback to original to avoid breaking flow
        try{ return await origSpend.call(this, amount); }catch(_){}
      }
    } else {
      return await origSpend.call(this, amount);
    }
  };

  function activateTCSplit(ms=2000){
    g.__tcSplitActive = true;
    setTimeout(()=>{ g.__tcSplitActive = false; }, ms);
  }

  function bindTcButtons(){
    const spin = document.querySelector("#btnSpin");
    if (spin && !spin.__tcBound){
      spin.__tcBound = true;
      // capture phase so we set flag before any handlers run
      spin.addEventListener("click", ()=>{ activateTCSplit(); }, true);
    }
    const auto10 = document.querySelector("#btnAuto10");
    if (auto10 && !auto10.__tcBound){
      auto10.__tcBound = true;
      auto10.addEventListener("click", ()=>{ activateTCSplit(3500); }, true);
    }
  }

  // Initial mount & periodic refresh
  const init = ()=>{ bindTcButtons(); refreshTcJackpotLabel(); };
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
  setInterval(()=>{ bindTcButtons(); refreshTcJackpotLabel(); }, 4000);
})();
// === End TC jackpot ===


// Show multiple areas at once (job + firm)
function showAreas(ids){
  const all = ["bankArea","slotsArea","houseArea","chatArea","jobArea","firmArea","shopArea"];
  all.forEach(x=> { const el=$("#"+x); if(el) el.classList.add("hidden"); });
  ids.forEach(id=> { const el=$("#"+id); if(el) el.classList.remove("hidden"); });
}


// === Button anti-spam guards (non-invasive) ===
(function(){
  const IDS = ["#btnProcess","#btnStore","#btnCheck","#btnSell"];
  function guard(el, ms){
    if (!el) return;
    el.addEventListener("click", ()=>{
      if (el.dataset.busy === "1") return;
      el.dataset.busy = "1";
      el.disabled = true;
      setTimeout(()=>{ el.dataset.busy = "0"; el.disabled = false; }, ms);
    }, true); // capture so it runs before original handler
  }
  function init(){
    IDS.forEach(sel=> guard(document.querySelector(sel), 2500));
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
// === End guards ===


// --- Mobile footer nav bindings + cash mirror ---
(function(){
  function bind(id, area){ const el = document.querySelector(id); if (el) el.onclick = ()=> requireLoginThen(area); }
  bind("#navBank","bankArea");
  bind("#navJob","jobArea");
  bind("#navFirm","firmArea");
  bind("#navSlots","slotsArea");
  bind("#navHouse","houseArea");
  bind("#navChat","chatArea");
  bind("#navShop","shopArea");
  // Mirror cash to #cashLabelTop when snapshot updates
  const _origAttach = attachUser;
  attachUser = async function(userRef){
    await _origAttach(userRef);
    try{
      const cl2 = document.querySelector("#cashLabelTop");
      if (cl2){ const v = document.querySelector("#cashLabel")?.textContent || ""; cl2.textContent = v; }
    }catch(_){}
  };
})();

</script>

  <footer class="nav" id="mobileNav">
    <div id="navBank"  class="circle" title="Bank">üí∂</div>
    <div id="navJob"   class="circle" title="Job">üë∑</div>
    <div id="navFirm"  class="circle" title="Firma">üë®‚Äçüíº</div>
    <div id="navSlots" class="circle" title="Slots">üé∞</div>
    <div id="navHouse" class="circle" title="H√§user">üè†</div>
    <div id="navChat"  class="circle" title="Chat">üí¨</div>
    <div id="navShop"  class="circle" title="Shop">üíµ</div>
  </footer>

</body></html>
