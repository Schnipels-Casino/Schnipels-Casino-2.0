<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Friends Bank ‚Äì v4.1</title>
<meta name="theme-color" content="#3b82f6"/>
<style>
:root{
  --bg:#f6f8fb; --paper:#fff; --ink:#0b1324; --muted:#5f6c86; --line:#e6ebf2;
  --accent:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --shadow:0 8px 22px rgba(11,19,36,.08);
  --rounded:18px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0; background:var(--bg); color:var(--ink); font:500 15px/1.45 ui-sans-serif, system-ui, Segoe UI, Inter, Roboto, Arial}
/* Header compact */
header.app{position:sticky; top:0; z-index:10; display:flex; align-items:center; gap:10px; padding:8px 10px;
  background:rgba(255,255,255,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--line)}
.brand{display:flex; align-items:center; gap:8px}
.logo{width:32px; height:32px; display:grid; place-items:center; font-weight:900; border-radius:10px;
  background:linear-gradient(135deg,#60a5fa,#a5b4fc); color:#0a1b3a; box-shadow:var(--shadow)}
.title{font-weight:900; font-size:16px}
.head-money{margin-left:auto; display:flex; gap:10px; font-weight:800}
.head-money .lab{color:var(--muted); font-size:12px}
.head-money .val{font-variant-numeric:tabular-nums}
/* KPIs hidden (replaced by inline head-money) */
.kpis{display:none}

main{padding:12px 10px 92px}
.panel{background:var(--paper); border:1px solid var(--line); border-radius:var(--rounded); padding:12px; box-shadow:var(--shadow)}
.panel + .panel{margin-top:10px}
h2{margin:2px 0 8px; font-size:16px} h3{margin:2px 0 8px; font-size:14px; color:#0f254f}
.row{display:flex; gap:8px; flex-wrap:wrap} .right{margin-left:auto}
.btn{display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:8px 10px; border-radius:12px; cursor:pointer; user-select:none;
  border:1px solid var(--line); background:#f8fafc; font-weight:800; font-size:13px}
.btn.sm{padding:8px 10px; font-size:12.5px}
.btn.xs{padding:6px 8px; font-size:11.5px}
.btn.block{width:100%} .btn.ghost{background:#fff} .btn.acc{background:#ecf2ff; border-color:#d7e3ff}
.btn.ok{background:#e8fbef; border-color:#bff1ce} .btn.warn{background:#fff6e6; border-color:#fde0a1} .btn.bad{background:#ffecec; border-color:#ffd1d1}
.btn:disabled{opacity:.6; cursor:not-allowed}
input,select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; font-weight:700; color:var(--ink)}
label{font-size:12px; color:#5f6c86; text-transform:uppercase; letter-spacing:.35px}
.field{display:flex; flex-direction:column; gap:6px}
.stat{display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px dashed #cfd7e6; border-radius:12px; background:#fff}
.muted{color:#5f6c86}
.section{display:none; animation:fade .2s ease} .section.active{display:block}
@keyframes fade{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)}}

/* AUTH */
.auth-grid{display:grid; grid-template-columns:1fr; gap:10px}

/* Job mini-game ‚Äì smaller for mobile (20 cells) */
.job-grid{display:grid; grid-template-columns:repeat(5,1fr); gap:4px; align-items:center; justify-items:center}
.job-cell{width:100%}
.job-cell .btn{width:100%; aspect-ratio:1/1}
.job-cell .btn.xs{font-size:10px}
.btn.target{background:#e8fbef; border-color:#bff1ce; box-shadow:0 0 0 2px #86efac inset}
.btn.nontarget{background:#f8fafc}

/* Slots compact */
.slot-wrap{display:flex; flex-direction:column; gap:8px}
.slot-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:6px}
.slot-cell{display:grid; place-items:center; border:1px solid var(--line); border-radius:12px; background:#fff; font-size:22px;
  height:20vw; max-height:64px}

/* Immobilien */
.house{display:flex; flex-direction:column; gap:8px}

/* Bottom nav tighter for mobile */
nav.bottom{position:fixed; left:0; right:0; bottom:0; z-index:20; background:rgba(255,255,255,.95); border-top:1px solid var(--line); backdrop-filter:blur(8px)}
nav .bar{display:grid; grid-template-columns:repeat(8,1fr); gap:4px; padding:6px 6px}
.tab{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; padding:6px 2px; border-radius:10px; cursor:pointer;
  border:1px solid transparent} .tab.active{background:#ecf2ff; border-color:#d7e3ff}
.icon{font-size:16px} .txt{font-size:10px; color:#5f6c86; font-weight:800}

/* Toast */
.toast{position:fixed; left:50%; transform:translateX(-50%); bottom:74px; z-index:30; display:none; padding:10px 14px; border-radius:12px;
  background:#e8fbef; border:1px solid #bff1ce; color:#0a2d12; font-weight:900; box-shadow:var(--shadow)}

@media (min-width:720px){ main{max-width:780px; margin:0 auto} }

/* MOD MENU OVERLAY */
#modOverlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:9999;display:none;color:#fff}
#modPanel{position:absolute;right:0;top:0;height:100%;width:min(420px,95vw);background:rgba(0,0,0,.55);border-left:1px solid rgba(255,255,255,.15);padding:14px 14px 24px 14px;overflow:auto}
#modPanel h2{margin:6px 0 12px 0;font-size:18px}
#modPanel .mnav{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
#modPanel .mnav .btn{background:#0b0b0bcc;border:1px solid rgba(255,255,255,.15)}
#modPanel .section{display:none}
#modPanel .section.active{display:block}
#modPanel .row{display:flex;align-items:center;gap:8px;margin:8px 0}
#modPanel label{font-size:12px;color:#cdd3d8}
#modPanel input[type="number"], #modPanel input[type="text"]{width:130px;background:#00000088;border:1px solid rgba(255,255,255,.15);color:#fff;border-radius:8px;padding:6px 8px}
#modPanel .list{border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:6px}
#modPanel .list .row{justify-content:space-between}
#modClose{position:absolute;top:8px;left:8px}


/* MOD MENU PIN PROMPT */
#modPin{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.65);backdrop-filter:blur(3px);z-index:10000}
#modPin .box{width:min(360px,92vw);background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:16px;color:#fff}
#modPin h3{margin:0 0 10px 0;font-size:16px}
#modPin input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#0009;color:#fff;outline:none}
#modPin .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}


/* MOD MENU text red override */
#modOverlay, #modOverlay * { color:#ff3b30 !important; }
#modPanel small.muted { color:#ff3b30 !important; opacity:0.9; }
#modPanel label { color:#ff3b30 !important; }

</style>
</head>
<body>
<header class="app">
  <div class="brand"><div class="logo">FB</div><div class="title">Friends Bank</div></div>
  <div class="head-money">
    <div><span class="lab">Konto</span> <span class="val" id="balance">0,00 ‚Ç¨</span></div>
    <div><span class="lab">Bar</span> <span class="val" id="cash">0,00 ‚Ç¨</span></div>
  </div>
  <div class="kpis"><!-- hidden on mobile --></div>
</header>

<main>
  <!-- AUTH / BANK + LOGIN -->
  <section id="sec-auth" class="section active">
    <div class="panel">
      <h2>1) Bank ausw√§hlen (permanent)</h2>
      <div class="row">
        <button class="btn acc bankBtn" data-bank="Deutsche Bank">üè¶ Deutsche Bank</button>
        <button class="btn acc bankBtn" data-bank="VR-Bank">üè¶ VR‚ÄëBank</button>
        <button class="btn acc bankBtn" data-bank="Sparkasse">üè¶ Sparkasse</button>
        <button class="btn acc bankBtn" data-bank="Postbank">üè¶ Postbank</button>
      </div>
      <div class="stat" style="margin-top:8px">
        <strong>Hinweis:</strong> Jede Bank hat 1.000.000.000 ‚Ç¨ Budget (Info), dein pers√∂nliches Konto startet bei 1.500 ‚Ç¨.
      </div>
      <div class="stat muted" id="bankLockedNote" style="display:none">Bankwechsel ist gesperrt.</div>
    </div>

    <div class="panel">
      <h2>2) Anmeldezentrum</h2>
      <div class="auth-grid">
        <div class="field"><label>Dein Name</label><input id="authName" placeholder="z.‚ÄØB. Julian"/></div>
        <div class="field"><label>Passwort</label><input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
        <div class="row">
          <button class="btn ok" id="btnRegister">Registrieren</button>
          <button class="btn acc" id="btnLogin">Anmelden</button>
        </div>
        <div class="stat"><strong>Status:</strong><span id="authStatus">Bitte Bank w√§hlen und anmelden.</span></div>
      </div>
    </div>
  </section>

  <!-- KONTO -->
  <section id="sec-konto" class="section">
    <div class="panel">
      <h2>Konto</h2>
      <div class="row">
        <button class="btn ok xs" id="btnDaily500">+500 ‚Ç¨ Tagesbonus</button>
        <div class="stat right xs"><strong>Leih offen:</strong><span id="leihOffen">0,00 ‚Ç¨</span></div>
        <div class="stat xs"><strong>Kredit offen:</strong><span id="kreditOffen">0,00 ‚Ç¨</span></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="field" style="flex:1"><label>Betrag (‚Ç¨)</label><input id="ioAmount" type="number" min="0" inputmode="decimal" placeholder="0"/></div>
        <button class="btn ghost xs" id="btnEinzahlen">Einzahlen ‚Üí</button>
        <button class="btn ghost xs" id="btnAuszahlen">‚Üê Auszahlen</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="field" style="flex:1"><label>Kredit (‚Ç¨)</label><input id="loanAmount" type="number" min="0" inputmode="decimal" placeholder="0"/></div>
        <button class="btn warn xs" id="btnKreditNehmen">Kredit nehmen</button>
        <button class="btn ok xs" id="btnKreditZurueck">Kredit zur√ºckzahlen</button>
      </div>
    </div>

    <div class="panel">
      <h3>Live‚ÄëAktien</h3>
      <div class="row">
        <div class="stat xs"><strong>Symbol:</strong><span id="stockSymbol">FRND</span></div>
        <div class="stat xs"><strong>Kurs:</strong><span id="stockPrice">‚Äî</span></div>
        <div class="stat xs"><strong>St√ºck:</strong><span id="stockShares">0</span></div>
        <div class="stat xs"><strong>Wert:</strong><span id="stockValue">0,00 ‚Ç¨</span></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="field" style="flex:1"><label>Menge</label><input id="stockQty" type="number" min="1" value="1"/></div>
        <button class="btn acc xs" id="btnBuy">Kaufen</button>
        <button class="btn bad xs" id="btnSell">Verkaufen</button>
      </div>
    </div>
  </section>

  <!-- JOB -->
  <section id="sec-job" class="section">
    <div class="panel">
      <h2 style="font-size:16px">Job ‚Äì Tippe gr√ºn (1√ó pro Tag)</h2>
      <div class="row" style="margin-bottom:6px">
        <button class="btn acc xs" id="btnJobStart">‚ñ∂Ô∏è Start</button>
        <button class="btn bad xs" id="btnJobStop" disabled>‚èπ Stop</button>
        <div class="stat xs right"><strong>Pro Treffer:</strong><span id="perHit">20,00 ‚Ç¨</span>
        <div class="stat xs"><strong>Timer:</strong><span id="jobTime">01:00</span></div>
</div>
      </div>
      <div class="job-grid" id="jobGrid"></div>
      <div class="row" style="margin-top:8px">
        <div class="stat xs"><strong>Treffer:</strong><span id="hitCount">0</span></div>
        <div class="stat xs"><strong>Verdienst:</strong><span id="jobEarn">0,00 ‚Ç¨</span></div>
        <button class="btn ok xs right" id="btnCollect">üíµ Auszahlen</button>
      </div>
      <div class="stat muted" id="jobLockNote" style="display:none; margin-top:8px">Job heute bereits erledigt.</div>
    </div>
    <div class="panel">
      <h3>Spitzhacken</h3>
      <div class="row">
        <button class="btn ghost xs pick" data-id="1" data-bonus="10" data-price="500">‚õèÔ∏è I ¬∑ +10‚Ç¨ ¬∑ 500‚Ç¨</button>
        <button class="btn ghost xs pick" data-id="2" data-bonus="50" data-price="3000">‚õèÔ∏è II ¬∑ +50‚Ç¨ ¬∑ 3.000‚Ç¨</button>
        <button class="btn ghost xs pick" data-id="3" data-bonus="100" data-price="15000">‚õèÔ∏è III ¬∑ +100‚Ç¨ ¬∑ 15.000‚Ç¨</button>
        <button class="btn ghost xs pick" data-id="4" data-bonus="500" data-price="80000">‚õèÔ∏è IV ¬∑ +500‚Ç¨ ¬∑ 80.000‚Ç¨</button>
        <button class="btn ghost xs pick" data-id="5" data-bonus="1000" data-price="200000">‚õèÔ∏è V ¬∑ +1000‚Ç¨ ¬∑ 200.000‚Ç¨</button>
      </div>
    </div>
  </section>

  <!-- CHEF / UNTERNEHMEN -->
  <section id="sec-chef" class="section">
    <div class="panel">
      <h2>Unternehmen</h2>
      <div class="row">
        <div class="field" style="flex:2"><label>Name</label><input id="firmName" placeholder="Mein Unternehmen"/></div>
        <div class="field" style="flex:1">
          <label>Typ</label>
          <select id="firmType">
            <option value="legal">Legal</option>
            <option value="illegal">Illegal</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn acc" id="btnFirmCreate">üíº Unternehmen gr√ºnden (10.000‚Ç¨)</button>
        <button class="btn ok xs" id="btnFirmRun" disabled>‚ñ∂Ô∏è Einnahmen Start</button>
        <button class="btn bad xs" id="btnFirmStop" disabled>‚èπ Stop</button>
        <div class="stat right xs"><strong>Kasse:</strong><span id="firmCash">0,00 ‚Ç¨</span></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost xs" id="btnFirmWithdraw">‚Üê Auszahlen 1.000‚Ç¨</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="stat xs"><strong>Team:</strong><span id="teamSummary">‚Äî</span></div>
        <div class="stat xs"><strong>Einnahmen/s:</strong><span id="revPerSec">0,00 ‚Ç¨</span></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn warn xs" id="btnPayCompanyCost">üìÖ Unternehmenskosten 5.000 ‚Ç¨ zahlen</button>
        <div class="stat xs right" id="companyCostInfo">Heute f√§llig</div>
      </div>
      <small class="muted">Einnahmen laufen nur, wenn die heutigen Unternehmenskosten bezahlt sind.</small>
    </div>

    <div class="panel">
      <h3>Mitarbeiter einstellen</h3>
      <div class="row">
        <button class="btn ghost xs hire" data-role="arbeiter" data-cost="2000" data-rev="1">üë∑ Arbeiter ¬∑ 2.000‚Ç¨ ¬∑ +1‚Ç¨/s</button>
        <button class="btn ghost xs hire" data-role="manager" data-cost="10000" data-rev="5">üßë‚Äçüíº Manager ¬∑ 10.000‚Ç¨ ¬∑ +5‚Ç¨/s</button>
        <button class="btn ghost xs hire" data-role="kurier" data-cost="5000" data-rev="3">üöö Kurier ¬∑ 5.000‚Ç¨ ¬∑ +3‚Ç¨/s</button>
      </div>
    </div>

    <div class="panel">
      <h3>Warenfluss</h3>
      <div class="row">
        <div class="field" style="flex:1"><label>Menge</label><input id="goodsQty" type="number" min="1" value="1"/></div>
        <button class="btn warn xs" id="btnGoodsBuy">üõí Kaufen (2.000‚Ç¨)</button>
        <button class="btn acc xs" id="btnGoodsProcess">‚öôÔ∏è Verarbeiten (2s/Stk)</button>
        <button class="btn acc xs" id="btnGoodsCheck">‚úÖ Pr√ºfen (1s/Stk)</button>
        <button class="btn acc xs" id="btnGoodsStore">üì¶ Lagern (2s/Stk)</button>
        <button class="btn ok xs" id="btnGoodsSell">üí∞ Verkaufen (2.500‚Ç¨)</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="stat xs"><strong>Unterwegs:</strong><span id="gInTransit">0</span></div>
        <div class="stat xs"><strong>Rohwaren:</strong><span id="gRaw">0</span></div>
        <div class="stat xs"><strong>Verarbeitet:</strong><span id="gProcessed">0</span></div>
        <div class="stat xs"><strong>Gepr√ºft:</strong><span id="gChecked">0</span></div>
        <div class="stat xs"><strong>Gelagert:</strong><span id="gStored">0</span></div>
      </div>
    </div>
  
    <div class="panel">
      <h3>Bestellungen</h3>
      <div class="row">
        <div class="field" style="flex:1"><label>Menge</label><input id="orderQty" type="number" min="1" value="1"/></div>
        <div class="field" style="flex:1"><label>Bestellbetrag (‚Ç¨)</label><input id="orderAmount" type="number" min="1" value="1000"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn acc xs" id="btnOrderEdit">‚úèÔ∏è Bestellung bearbeiten</button>
        <button class="btn warn xs" id="btnOrderPack" disabled>üì¶ Bestellung verpacken (1 min)</button>
        <button class="btn acc xs" id="btnOrderShip" disabled>üöö Bestellung losschicken (2 min)</button>
        <button class="btn ok xs" id="btnOrderCash" disabled>üí∂ Bestellung abkassieren</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="stat xs"><strong>Status:</strong><span id="orderStatus">‚Äî</span></div>
        <div class="stat xs"><strong>Timer:</strong><span id="orderTimer">‚Äî</span></div>
      </div>
      <small class="muted">Es wird Ware aus ‚ÄûGelagert‚Äú reserviert.</small>
    </div>
</section>

  <!-- SLOTS -->
  <section id="sec-slots" class="section">
    <div class="panel">
      <h2>Slots</h2>
      <div class="slot-wrap">
        <div class="row">
          <div class="stat xs"><strong>Jackpot:</strong><span id="jackpotValue">0,00 ‚Ç¨</span></div>
        </div>
        <div class="slot-grid" id="slotGrid">
          <div class="slot-cell">üçí</div><div class="slot-cell">üçã</div><div class="slot-cell">‚≠ê</div>
          <div class="slot-cell">üçã</div><div class="slot-cell">‚≠ê</div><div class="slot-cell">üçÄ</div>
          <div class="slot-cell">‚≠ê</div><div class="slot-cell">üçí</div><div class="slot-cell">üçã</div>
        </div>
        <div class="row">
          <div class="field" style="flex:1"><label>Einsatz (1‚Äì100 ‚Ç¨)</label><input id="slotBet" type="number" min="1" max="100" value="50"/></div>
          <button class="btn acc xs" id="btnSpin">üé∞ Drehen</button>
        </div>
        <small class="muted">Auszahlung pro Linie: 2√ó Einsatz. Vollbild zahlt den globalen Jackpot.</small>
      </div>
    </div>
  </section>
  <!-- J. JUMP GAME -->
  <section id="sec-jjump" class="section">
    <div class="panel">
      <h2>J. Jump</h2>
      <div class="row" style="margin-bottom:6px">
        <div class="stat xs"><strong>Einsatz:</strong><span>100,00 ‚Ç¨</span></div>
        <div class="stat xs"><strong>Charakter:</strong><span id="jjCharLabel">Schwarz</span></div>
        <div class="right">
          <select id="jjCharSelect" class="btn xs" style="padding:6px 8px">
          </select>
        </div>
      </div>
      <div style="border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#cfe8ff">
        <canvas id="jjCanvas" width="640" height="200" style="width:100%; display:block"></canvas>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn ok xs" id="jjStart">‚ñ∂Ô∏è Start</button>
        <button class="btn bad xs" id="jjStop" disabled>‚èπ Stop</button>
        <div class="stat xs right"><strong>Punkte:</strong><span id="jjScore">0</span></div>
        <div class="stat xs"><strong>Tempo:</strong><span id="jjSpeed">0</span></div>
        <div class="stat xs"><strong>Zeit:</strong><span id="jjTime">00:00</span></div>
      </div>
    </div>
    <div class="panel">
      <h3>Bestenliste (J. Jump)</h3>
      <ol id="jjBoard" style="margin:0; padding-left:18px"></ol>
    </div>
  </section>


  <!-- IMMOBILIEN -->
  <section id="sec-immo" class="section">
    <div class="panel">
      <h2>Immobilien</h2>
      <div id="houseList" class="house"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn ok xs" id="btnClaimRent">üè¶ T√§gliche Mieten kassieren</button>
      </div>
      <small class="muted">Stufe 1: 50.000‚Ç¨ ‚Üí 2.000‚Ç¨/Tag; je Stufe +50.000‚Ç¨ & +2.000‚Ç¨/Tag.</small>
    </div>
  </section>

  <!-- SHOP -->
  
  <!-- SHOP -->
  <section id="sec-shop" class="section">
    <div class="panel">
      <h2>Shop</h2>
      <div class="row" id="jjShop"></div>
      <small class="muted">Charaktere sind nur Optik f√ºr J. Jump. Gold kostet 20.000‚Ç¨, alle anderen 10.000‚Ç¨ (Schwarz ist Standard).</small>
    </div>
  </section>


  <!-- MESSENGER -->
  <section id="sec-messenger" class="section">
    <div class="panel">
      <h2>Messenger</h2>
      <div id="msgList" style="display:flex; flex-direction:column; gap:8px; max-height:46vh; overflow:auto; padding-right:4px"></div>
      <div class="row" style="margin-top:8px">
        <input id="msgInput" placeholder="Nachricht schreiben‚Ä¶"/>
        <button class="btn acc xs" id="btnSend">Senden</button>
      </div>
    </div>
  </section>
</main>

<nav class="bottom" id="bottomNav" style="display:none">
  <div class="bar">
    <div class="tab active" data-target="konto"><div class="icon">üí∂</div><div class="txt">Konto</div></div>
    <div class="tab" data-target="job"><div class="icon">üõ†Ô∏è</div><div class="txt">Job</div></div>
    <div class="tab" data-target="chef"><div class="icon">üëî</div><div class="txt">Chef</div></div>
    <div class="tab" data-target="slots"><div class="icon">üé∞</div><div class="txt">Slots</div></div>
        <div class="tab" data-target="jjump"><div class="icon">üèÉ</div><div class="txt">J. Jump</div></div>
    <div class="tab" data-target="immo"><div class="icon">üè†</div><div class="txt">Immobilien</div></div>
    <div class="tab" data-target="shop"><div class="icon">üõçÔ∏è</div><div class="txt">Shop</div></div>
    <div class="tab" data-target="messenger"><div class="icon">üí¨</div><div class="txt">Chat</div></div>
  </div>
</nav>

<div id="toast" class="toast">Gespeichert</div>

<script type="module">
/* ========== Helpers ========== */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const fmt=n=>(new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'})).format(n||0);
const toast=t=>{const el=$("#toast"); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1600)};
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const todayKey=()=> new Date().toISOString().slice(0,10);
async function hashPass(str){ const buf = new TextEncoder().encode(str); const h = await crypto.subtle.digest('SHA-256', buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('') }

/* ========== Firebase (with local fallback) ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, serverTimestamp, runTransaction, increment } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyArqwFEi1afYtkPTbGuA0PiwJsHmBuJhos",
  authDomain: "schnipels-casino.firebaseapp.com",
  projectId: "schnipels-casino",
  storageBucket: "schnipels-casino.firebasestorage.app",
  messagingSenderId: "233562090178",
  appId: "1:233562090178:web:520c0e28b295308527e95b",
  measurementId: "G-EJPHEFBSDX"
};

let app, auth, db, uid=null, localOnly=false;
try{ app=initializeApp(firebaseConfig); auth=getAuth(app); db=getFirestore(app);
     signInAnonymously(auth).catch(e=>{console.warn("Auth error",e); localOnly=true}); }
catch(e){ console.warn("Firebase init failed", e); localOnly=true; }
onAuthStateChanged?.(auth, user=>{ uid=user?.uid||"local"; boot(); });

/* ========== State ========== */
const BANKS=["Deutsche Bank","VR-Bank","Sparkasse","Postbank"];
const PERSONAL_START=1500, DAILY_BONUS=500, COMPANY_COST=10_000;

const defaults={
  isLoggedIn:false,
  bank:null, bankLocked:false,
  balances:Object.fromEntries(BANKS.map(b=>[b,0])),
  cash:0, leihOffen:0, kreditOffen:0,
  dailyClaimDate:null,
  stocks:{symbol:"FRND", shares:0, avgPrice:0, realized:0},
  firm:null, // {name,type,cash,team:{arbeiter,manager,kurier},running:false, goods:{inTransit,raw,processed,checked,stored}, lastCompanyCostDate}
  houses:[], lastRentClaimDate:null,
  items:[], picks:{1:false,2:false,3:false,4:false,5:false},
  name:"", accountKey:null,
  jobPlayedDate:null
};
let state=structuredClone(defaults);
const lsKey="friendsbank_v41_state";
const loadLocal=()=>{ try{const j=localStorage.getItem(lsKey); if(j) state=JSON.parse(j)}catch{} };
const saveLocal=()=>{ try{localStorage.setItem(lsKey, JSON.stringify(state))}catch{} };
const userRef=()=> doc(db,"friendsbank_users_v41", uid||"local");
const accRef=(key)=> doc(db,"friendsbank_accounts_v1", key);
const jackpotRef= doc(db,"friendsbank_jackpot","global");

async function syncFromCloud(){ if(localOnly){loadLocal(); renderAll(); return}
  try{ const s=await getDoc(userRef()); if(s.exists()) state=Object.assign({}, defaults, s.data()); saveLocal(); }
  catch(e){ console.warn("sync fail", e); localOnly=true; loadLocal(); }
  renderAll();
  startOrderTicker();
}
async function push(partial={}){ Object.assign(state, partial); saveLocal(); if(localOnly) return;
  try{ await setDoc(userRef(), state, {merge:true}); } catch(e){ console.warn("push fail",e); localOnly=true; } }

/* ========== Boot ========== */
async function boot(){
  if(!state.houses||state.houses.length===0){
    state.houses = Array.from({length:10},(_,i)=>({id:"immo"+(i+1), name:"Immobilie "+(i+1), price:50_000+i*50_000, rent:2_000+i*2_000, owned:false}));
  }
  await syncFromCloud();
  ensureJJump();
  try{ renderCostsPanel(); }catch(_){}
  wireUI();
  tickerStocks();
  if(!localOnly){
    onSnapshot(jackpotRef, (snap)=>{ const v=snap.data()?.value||0; $("#jackpotValue").textContent = fmt(v); });
  }
}

/* ========== UI Wiring ========== */
function wireUI(){
  // Tabs
  $$(".tab").forEach(t=> t.addEventListener("click", ()=>{
    $$(".tab").forEach(x=>x.classList.remove("active")); t.classList.add("active");
    const id=t.dataset.target; $$(".section").forEach(s=>s.classList.remove("active")); $("#sec-"+id).classList.add("active");
  }));

  // Auth: bank buttons
  $$(".bankBtn").forEach(b=> b.addEventListener("click", ()=> selectBank(b.dataset.bank)) );
  $("#btnRegister").addEventListener("click", doRegister);
  $("#btnLogin").addEventListener("click", doLogin);

  // Konto actions
  $("#btnEinzahlen").addEventListener("click", ()=> io(true));
  $("#btnAuszahlen").addEventListener("click", ()=> io(false));
  $("#btnKreditNehmen").addEventListener("click", ()=> kredit(true));
  $("#btnKreditZurueck").addEventListener("click", ()=> kredit(false));
  $("#btnDaily500").addEventListener("click", dailyClaim);

  // Stocks
  $("#btnBuy").addEventListener("click", ()=> trade(true));
  $("#btnSell").addEventListener("click", ()=> trade(false));

  // Job grid 20 cells (smaller .xs buttons)
  const grid=$("#jobGrid");
  for(let i=0;i<20;i++){
    const wrap=document.createElement("div"); wrap.className="job-cell";
    const b=document.createElement("button"); b.className="btn xs jobBtn nontarget"; b.textContent="ü™®"; b.addEventListener("click",()=> jobClick(i));
    wrap.appendChild(b); grid.appendChild(wrap);
  }
  $("#btnJobStart").addEventListener("click", jobStart);
  $("#btnJobStop").addEventListener("click", jobStop);
  $("#btnCollect").addEventListener("click", jobCollect);
  $$(".pick").forEach(p=> p.addEventListener("click", ()=> buyPick(p)) );

  // Firm
  $("#btnFirmCreate").addEventListener("click", firmCreate);
  $("#btnFirmRun").addEventListener("click", firmStart);
  $("#btnFirmStop").addEventListener("click", firmStop);
  $("#btnFirmWithdraw").addEventListener("click", ()=> firmWithdraw(1000));
  $$(".hire").forEach(h=> h.addEventListener("click", ()=> hire(h)) );
  $("#btnPayCompanyCost").addEventListener("click", payCompanyCost);

  // Goods pipeline
  $("#btnGoodsBuy").addEventListener("click", goodsBuy);
  $("#btnGoodsProcess").addEventListener("click", ()=> goodsStep("raw","processed",2000));
  $("#btnGoodsCheck").addEventListener("click", ()=> goodsStep("processed","checked",1000));
  $("#btnGoodsStore").addEventListener("click", ()=> goodsStep("checked","stored",2000));
  $("#btnGoodsSell").addEventListener("click", goodsSell);

  // Orders
  $("#btnOrderEdit").addEventListener("click", orderEdit);
  $("#btnOrderPack").addEventListener("click", orderPack);
  $("#btnOrderShip").addEventListener("click", orderShip);
  $("#btnOrderCash").addEventListener("click", orderCash);


  // J. Jump
  $("#jjStart").addEventListener("click", jjStartGame);
  $("#jjStop").addEventListener("click", jjStopGame);
  $("#jjCharSelect").addEventListener("change", async (e)=>{
    ensureJJump();
  try{ renderCostsPanel(); }catch(_){}
    state.jjump.selected = e.target.value;
    await push({ jjump: state.jjump });
    renderJJump();
  });

  // Slots
  $("#btnSpin").addEventListener("click", spin);

  // Immobilien
  renderHouses();
  $("#btnClaimRent").addEventListener("click", claimDailyRent);

  // Messenger
  setupChat();

  gateAuth();
  renderAll();
  startOrderTicker();
}

/* ========== Auth flow ========== */
async function selectBank(pick){
  if(state.bank && state.bank!==pick){ return alert("Bankwechsel ist nicht erlaubt."); }
  if(!state.bank){
    const balances=Object.assign({}, state.balances);
    balances[pick] = PERSONAL_START;
    await push({ bank: pick, bankLocked:true, balances });
    $("#bankLockedNote").style.display='block';
    toast("Bank gew√§hlt: "+pick+" (permanent), Start 1.500 ‚Ç¨");
  }
  renderAccount();
  gateAuth();
}
function accountKey(name, bank){ return (bank+"|"+name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'_')).slice(0,64) }
async function doRegister(){
  const name=$("#authName").value.trim(); const pass=$("#authPass").value;
  if(!state.bank) return alert("Zuerst Bank w√§hlen.");
  if(!name||!pass) return alert("Name und Passwort eingeben.");
  const key=accountKey(name, state.bank); const passHash = await hashPass(pass);
  if(localOnly){
    await push({ isLoggedIn:true, name, accountKey:key });
    $("#authStatus").textContent="Registriert (lokal)"; afterLogin(); return;
  }
  const ref=accRef(key); const snap=await getDoc(ref);
  if(snap.exists()){ $("#authStatus").textContent="Name existiert. Bitte anmelden."; return }
  await setDoc(ref, { bank: state.bank, name, passHash, uid, createdAt: serverTimestamp() });
  await push({ isLoggedIn:true, name, accountKey:key });
  $("#authStatus").textContent="Registriert & angemeldet.";
  afterLogin();
}
async function doLogin(){
  const name=$("#authName").value.trim(); const pass=$("#authPass").value;
  if(!state.bank) return alert("Zuerst Bank w√§hlen.");
  if(!name||!pass) return alert("Name und Passwort eingeben.");
  const key=accountKey(name, state.bank); const passHash=await hashPass(pass);
  if(localOnly){
    await push({ isLoggedIn:true, name, accountKey:key });
    $("#authStatus").textContent="Angemeldet (lokal)"; afterLogin(); return;
  }
  const ref=accRef(key); const snap=await getDoc(ref);
  if(!snap.exists()){ $("#authStatus").textContent="Kein Konto. Bitte registrieren."; return }
  const ok = snap.data().passHash===passHash;
  if(!ok){ $("#authStatus").textContent="Falsches Passwort."; return }
  await push({ isLoggedIn:true, name, accountKey:key });
  $("#authStatus").textContent="Erfolgreich angemeldet.";
  afterLogin();
}
function afterLogin(){
  gateAuth();
  toast("Willkommen, "+(state.name||"User"));
}
function gateAuth(){
  const authed = state.isLoggedIn && !!state.bank;
  $("#sec-auth").style.display = authed ? 'none':'block';
  $("#bottomNav").style.display = authed ? 'block':'none';
  if(authed){
    // default to Konto
    $$(".tab").forEach(x=>x.classList.remove("active"));
    $$('.tab[data-target="konto"]')[0].classList.add("active");
    $$(".section").forEach(s=>s.classList.remove("active"));
    $("#sec-konto").classList.add("active");
  }
}

/* ========== Konto & Kredit ========== */
async function dailyClaim(){
  const today=todayKey(); if(state.dailyClaimDate===today) return toast("Heute schon abgeholt");
  const b=state.bank; if(!b) return alert("Zuerst Bank w√§hlen.");
  const balances=Object.assign({}, state.balances); balances[b]+=DAILY_BONUS;
  await push({ balances, dailyClaimDate: today }); renderAccount(); toast("+500 ‚Ç¨ gutgeschrieben");
}
async function io(deposit){
  const amt=parseFloat($("#ioAmount").value||"0"); if(!amt||amt<=0) return;
  const b=state.bank, balances=Object.assign({}, state.balances);
  if(deposit){
    if(state.cash<amt) return alert("Nicht genug Bargeld.");
    balances[b]+=amt; await push({ balances, cash: state.cash-amt }); toast("Einzahlung ok");
  }else{
    if(balances[b]<amt) return alert("Nicht genug Kontoguthaben.");
    balances[b]-=amt; await push({ balances, cash: state.cash+amt }); toast("Auszahlung ok");
  }
  renderAccount();
}
async function kredit(take){
  const amt=parseFloat($("#loanAmount").value||"0"); if(!amt||amt<=0) return;
  const b=state.bank, balances=Object.assign({}, state.balances);
  if(take){
    balances[b]+=amt; await push({ balances, kreditOffen:(state.kreditOffen||0)+amt }); toast("Kredit aufgenommen");
  }else{
    if((state.kreditOffen||0)<amt) return alert("So viel Kredit ist nicht offen.");
    if(balances[b]<amt) return alert("Nicht genug Guthaben.");
    balances[b]-=amt; await push({ balances, kreditOffen:(state.kreditOffen||0)-amt }); toast("Kredit zur√ºckgezahlt");
  }
  renderAccount();
}
setInterval(()=>{ if(state.kreditOffen>0){ state.kreditOffen += state.kreditOffen*0.02/60; saveLocal(); renderAccount(); } },1000);
function renderAccount(){
  $("#balance").textContent = fmt(state.bank? state.balances[state.bank]:0);
  $("#cash").textContent = fmt(state.cash);
  $("#leihOffen").textContent = fmt(state.leihOffen||0);
  $("#kreditOffen").textContent = fmt(state.kreditOffen||0);
  const today=todayKey(); $("#btnDaily500").disabled = (state.dailyClaimDate===today);
}

/* ========== Stocks (sim) ========== */
let price=120, symIdx=0, symbols=["FRND","FBNK","DRGN","KLAU"];
function tickerStocks(){ setInterval(()=>{ if(Math.floor(performance.now()/1000)%15===0){ symIdx=(symIdx+1)%symbols.length; state.stocks.symbol=symbols[symIdx]; }
  const drift=(Math.random()-0.5)*2; price=Math.max(1, price+drift*1.8); renderStocks(); },1000); }
function renderStocks(){ $("#stockSymbol").textContent=state.stocks.symbol; $("#stockPrice").textContent=fmt(price);
  $("#stockShares").textContent=(state.stocks.shares||0); $("#stockValue").textContent=fmt((state.stocks.shares||0)*price); }
async function trade(buy){
  const qty=Math.max(1, parseInt($("#stockQty").value||"1",10)); const total=qty*price; const b=state.bank; const balances=Object.assign({}, state.balances);
  if(buy){
    if(balances[b]<total) return alert("Nicht genug Guthaben.");
    balances[b]-=total; const s=state.stocks; const newShares=s.shares+qty; const newAvg=((s.shares*s.avgPrice)+total)/newShares;
    await push({ balances, stocks:{...s, shares:newShares, avgPrice:newAvg} }); toast("Aktien gekauft");
  }else{
    if(state.stocks.shares<qty) return alert("Nicht genug St√ºck.");
    const s=state.stocks, proceeds=total; balances[b]+=proceeds; const newShares=s.shares-qty, realized=(s.realized||0)+(price-s.avgPrice)*qty;
    await push({ balances, stocks:{...s, shares:newShares, realized} }); toast("Aktien verkauft");
  }
  renderStocks(); renderAccount();
}

/* ========== Job (tap green) ‚Äì 1√ó/Tag ========== */
let jobTimer=null, targetIdx=-1, hit=0, earn=0;
function clickValue(){ const base=20; const add=Object.entries(state.picks).filter(([k,v])=>v)
  .map(([k,v])=>({1:10,2:50,3:100,4:500,5:1000}[k])).reduce((a,b)=>a+b,0); return base+add; }
function renderPerHit(){ $("#perHit").textContent = fmt(clickValue()); }
function jobAllowedToday(){ return state.jobPlayedDate!==todayKey(); }
function updateJobLock(){ const ok=jobAllowedToday(); $("#btnJobStart").disabled = !ok; $("#jobLockNote").style.display = ok?'none':'block'; }
function jobStart(){ if(!jobAllowedToday()) return toast("Heute schon erledigt");
  if(jobTimer) return; $("#btnJobStart").disabled=true; $("#btnJobStop").disabled=false;
  jobTimer=setInterval(()=> setTarget(Math.floor(Math.random()*20)), 800); }
function jobStop(){ clearInterval(jobTimer); jobTimer=null; setTarget(-1); $("#btnJobStart").disabled=!jobAllowedToday(); $("#btnJobStop").disabled=true; }
function setTarget(i){ targetIdx=i; $$(".jobBtn").forEach((b,idx)=>{ b.classList.remove("target"); b.classList.add("nontarget");
  b.textContent = (idx===i)?"‚úÖ":"ü™®"; b.classList.toggle("xs", true); if(idx===i){ b.classList.add("target"); b.classList.remove("nontarget"); } }); }
function jobClick(i){ if(i===targetIdx){ hit++; const add=clickValue(); earn+=add; $("#hitCount").textContent=hit; $("#jobEarn").textContent=fmt(earn); setTarget(-1); } }
async function jobCollect(){ if(earn<=0) return; await push({ cash: state.cash+earn, jobPlayedDate: todayKey() });
  earn=0; hit=0; $("#jobEarn").textContent=fmt(0); $("#hitCount").textContent=0; renderAccount(); updateJobLock(); toast("Verdienst ausgezahlt"); }
async function buyPick(btn){ const id=btn.dataset.id, price=parseFloat(btn.dataset.price);
  if(state.picks[id]) return toast("Schon gekauft");
  if(state.cash<price) return alert("Nicht genug Bargeld."); const picks={...state.picks}; picks[id]=true;
  await push({ cash: state.cash-price, picks }); btn.disabled=true; btn.classList.add("ok"); renderPerHit(); renderAccount(); toast("Spitzhacke gekauft"); }
renderPerHit(); updateJobLock();

/* ========== Unternehmen ========== */
let firmTimer=null;
function firmRevPerSec(){ if(!state.firm) return 0; const t=state.firm.team||{arbeiter:0,manager:0,kurier:0};
  // Neue Raten: Arbeiter 1‚Ç¨/s, Manager 5‚Ç¨/s, Kurier 3‚Ç¨/s. Kein Illegal‚ÄëMultiplikator.
  let rev = t.arbeiter*1 + t.manager*5 + t.kurier*3;
  return rev;
}
function companyCostDue(){ if(!state.firm) return false; return state.firm.lastCompanyCostDate !== todayKey(); }
function renderCompanyCostInfo(){
  const due = companyCostDue();
  $("#companyCostInfo").textContent = due ? "Heute f√§llig" : "Bezahlt";
  $("#btnFirmRun").disabled = !state.firm || state.firm.running || due;
  $("#btnFirmStop").disabled = !state.firm || !state.firm.running;
}
function renderFirm(){ $("#firmCash").textContent=fmt(state.firm?.cash||0);
  const t=state.firm?.team||{arbeiter:0,manager:0,kurier:0}; $("#teamSummary").textContent=`üë∑ ${t.arbeiter} ¬∑ üßë‚Äçüíº ${t.manager} ¬∑ üöö ${t.kurier}`;
  $("#revPerSec").textContent=fmt(firmRevPerSec());
  $("#firmName").disabled = !!state.firm;
  $("#firmType").disabled = !!state.firm;
  renderCompanyCostInfo();
}
async function firmCreate(){
  if(!(await applyFirmCreationCost())){ return; }
if(state.firm) return toast("Bereits gegr√ºndet");
  const name=$("#firmName").value.trim(); const type=$("#firmType").value;
  if(!name) return alert("Bitte Name angeben."); if(!type) return alert("Bitte Typ w√§hlen.");
  if(state.cash<COMPANY_COST) return alert("Nicht genug Bargeld (10.000‚Ç¨).");
  const firm={name, type, cash:0, team:{arbeiter:0,manager:0,kurier:0}, running:false, goods:{inTransit:0,raw:0,processed:0,checked:0,stored:0}, lastCompanyCostDate:null};
  await push({ cash: state.cash-COMPANY_COST, firm }); renderFirm(); renderAccount(); toast("Unternehmen gegr√ºndet");
}
function firmStart(){ if(!state.firm||firmTimer) return;
  if(companyCostDue()){
    if((state.firm.cash||0) < 5000) { return alert("Erst die t√§glichen Unternehmenskosten (5.000‚Ç¨) zahlen."); }
  }
  state.firm.running=true; saveLocal(); renderFirm();
  firmTimer=setInterval(()=>{ state.firm.cash += firmRevPerSec(); saveLocal(); renderFirm(); if(!localOnly){ setDoc(userRef(), state, {merge:true}).catch(()=>{}) } },1000);
}
function firmStop(){ clearInterval(firmTimer); firmTimer=null; if(state.firm){ state.firm.running=false; saveLocal(); renderFirm(); } }
async function firmWithdraw(amt){ if(!state.firm) return; if((state.firm.cash||0)<amt) return alert("Firmenkasse zu klein.");
  await push({ cash: state.cash+amt, firm:{...state.firm, cash: state.firm.cash-amt} }); renderFirm(); renderAccount(); toast("Ausgezahlt "+fmt(amt)); }

async function payCompanyCost(){
  if(!state.firm) return;
  if((state.firm.cash||0) < 5000) return alert("Firmenkasse zu klein (5.000‚Ç¨).");
  state.firm.cash -= 5000; state.firm.lastCompanyCostDate = todayKey();
  await push({ firm: state.firm }); renderFirm(); toast("Unternehmenskosten bezahlt: 5.000‚Ç¨");
}

/* Goods pipeline */
function renderGoods(){ $("#gInTransit").textContent=state.firm?.goods?.inTransit||0; $("#gRaw").textContent=state.firm?.goods?.raw||0;
  $("#gProcessed").textContent=state.firm?.goods?.processed||0; $("#gChecked").textContent=state.firm?.goods?.checked||0; $("#gStored").textContent=state.firm?.goods?.stored||0; }
async function goodsBuy(){
  if(!state.firm) return alert("Unternehmen gr√ºnden zuerst.");
  const qty=Math.max(1, parseInt($("#goodsQty").value||"1",10)); const cost=2000*qty;
  if((state.firm.cash||0)<cost) return alert("Firmenkasse zu klein.");
  state.firm.cash -= cost; state.firm.goods.inTransit += qty; await push({ firm: state.firm }); renderFirm(); renderGoods();
  (async()=>{ for(let i=0;i<qty;i++){ await sleep(10000); state.firm.goods.inTransit--; state.firm.goods.raw++; saveLocal(); renderGoods();
    if(!localOnly){ setDoc(userRef(), state, {merge:true}).catch(()=>{}) } } })();
  toast(`Bestellt: ${qty} Artikel (Lieferzeit ${qty*10}s)`);
}
let goodsBusy=false;
async function goodsStep(from,to,msPerItem){
  if(!state.firm) return alert("Unternehmen gr√ºnden zuerst.");
  if(goodsBusy) return toast("Bitte warten‚Ä¶");
  const avail=state.firm.goods[from]; if(!avail||avail<=0) return toast("Keine Artikel verf√ºgbar");
  goodsBusy=true; for(let i=0;i<avail;i++){ await sleep(msPerItem);
    state.firm.goods[from]--; state.firm.goods[to]++; saveLocal(); renderGoods(); if(!localOnly){ setDoc(userRef(), state, {merge:true}).catch(()=>{}) } }
  goodsBusy=false; toast("Fertig: "+to);
}
async function goodsSell(){
  if(!state.firm) return alert("Unternehmen gr√ºnden zuerst.");
  const qty=state.firm.goods.stored; if(qty<=0) return toast("Keine gelagerten Artikel");
  const revenue=2500*qty; state.firm.goods.stored=0; state.firm.cash += revenue;
  await push({ firm: state.firm }); renderFirm(); renderGoods(); toast("Verkauft: "+qty+" Stk ‚Üí "+fmt(revenue));
}



/* ==== Firm Creation Rules ==== */
async function applyFirmCreationCost(){
  // Costs 100000‚Ç¨ from user's cash first; if not enough, try bank; else abort.
  const cfg = getCostsConfig();
  const COST = cfg.firmCost;
  const START_CASH = cfg.startCash;
  if(state.firm && state.firm.createdAt) return true; // already exists
  const total = (state.cash||0) + (state.bank||0);
  if(total < COST){ alert('Du brauchst 100.000‚Ç¨ um ein Unternehmen zu gr√ºnden.'); return false; }
  // prefer cash
  let need = COST;
  const cashTake = Math.min(state.cash||0, need);
  state.cash = (state.cash||0) - cashTake; need -= cashTake;
  if(need>0){ state.bank = (state.bank||0) - need; need = 0; }
  // initialize firm balances
  if(!state.firm) state.firm = {};
  state.firm.cash = (state.firm.cash||0) + START_CASH;
  // rest goes to firm bank as "Bank Found"
  const remaining = COST - START_CASH;
  state.firm.bank = (state.firm.bank||0) + remaining;
  state.firm.createdAt = Date.now();
  await push({ cash: state.cash, bank: state.bank, firm: state.firm });
  renderAccount(); renderFirm();
  toast('Firma gegr√ºndet: -'+fmt(COST)+' ¬∑ '+fmt(START_CASH)+' Firmenkasse ¬∑ '+fmt(remaining)+' Firmenbank');
  return true;
}


/* === Robust 1‚ÄëMinute Job Timer (fix) === */
(function(){
  let jobSessionEnd = null;
  let jobTimeTicker = null;

  function jobMsToMMSS(ms){
    if(!ms || ms <= 0) return "00:00";
    const s = Math.ceil(ms/1000);
    const m = Math.floor(s/60).toString().padStart(2,'0');
    const r = (s%60).toString().padStart(2,'0');
    return m+":"+r;
  }
  function renderJobTime(){
    const el = document.getElementById('jobTime');
    if(!el) return;
    const left = (jobSessionEnd||0) - Date.now();
    el.textContent = jobMsToMMSS(left);
  }
  function jobCanMine(){
    return jobSessionEnd && Date.now() < jobSessionEnd;
  }
  function startTicker(){
    if(jobTimeTicker) clearInterval(jobTimeTicker);
    jobTimeTicker = setInterval(()=>{
      renderJobTime();
      if(!jobCanMine()){
        try{ stopJobInternal(); }catch(_){}
      }
    }, 250);
  }
  function stopTicker(){
    if(jobTimeTicker){ clearInterval(jobTimeTicker); jobTimeTicker = null; }
  }

  async function startJobInternal(){
    jobSessionEnd = Date.now() + 60_000;
    renderJobTime();
    startTicker();
  }
  async function stopJobInternal(){
    stopTicker();
    const el = document.getElementById('jobTime');
    if(el) el.textContent = "00:00";
    jobSessionEnd = null;
  }

  // Wire to start/stop buttons (multiple id variants for robustness)
  function wireJobButtons(){
    const startBtn = document.getElementById('btnJobStart') || document.getElementById('jobStartBtn') || document.getElementById('job-start');
    const stopBtn  = document.getElementById('btnJobStop')  || document.getElementById('jobStopBtn')  || document.getElementById('job-stop');

    if(startBtn && !startBtn.__jobTimerWired){
      startBtn.addEventListener('click', ()=>{
        startJobInternal();
      });
      startBtn.__jobTimerWired = true;
    }
    if(stopBtn && !stopBtn.__jobTimerWired){
      stopBtn.addEventListener('click', ()=>{
        stopJobInternal();
      });
      stopBtn.__jobTimerWired = true;
    }
  }

  // Guard mining clicks by wrapping common handlers if present
  function wrapIfExists(name){
    if(window[name] && !window[name].__wrappedForJobTimer){
      const orig = window[name];
      window[name] = function(...args){
        if(!jobCanMine()){
          if(typeof toast==='function') toast('Zeit vorbei ‚Äì bitte neu starten.');
          return;
        }
        return orig.apply(this, args);
      };
      window[name].__wrappedForJobTimer = true;
    }
  }

  function wireTiles(){
    // additionally guard DOM tiles (if they use inline handlers)
    document.querySelectorAll('.job-tile, .tile, .mine-tile').forEach(el=>{
      if(el.__jobGuardWired) return;
      el.addEventListener('click', (ev)=>{
        if(!jobCanMine()){
          ev.preventDefault();
          ev.stopPropagation();
          if(typeof toast==='function') toast('Zeit vorbei ‚Äì bitte neu starten.');
        }
      }, true);
      el.__jobGuardWired = true;
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    wireJobButtons();
    wrapIfExists('jobClick');
    wrapIfExists('jobHit');
    wrapIfExists('mineClick');
    wrapIfExists('onTileHit');
    wireTiles();
    // initialize display
    const el = document.getElementById('jobTime');
    if(el) el.textContent = "01:00";
  });

  // In case UI re-renders dynamically
  const obs = new MutationObserver(()=>{
    wireJobButtons();
    wireTiles();
  });
  obs.observe(document.documentElement, {subtree:true, childList:true});
})();

/* ========== Bestellungen (Order Flow) ========== */
let orderTicker=null;
function ensureOrder(){
  if(!state.firm) return;
  if(!state.firm.order){
    state.firm.order = { qty:1, amount:1000, status:"idle", packagingEndAt:null, deliveryEndAt:null };
  }
}
const ORDER_STATUS_TEXT = {
  idle: "Bereit",
  editing: "In Bearbeitung",
  packaging: "Verpackung l√§uft",
  inTransit: "Unterwegs",
  readyToCash: "Bereit zum Abkassieren",
  completed: "Abgeschlossen"
};
function msToMMSS(ms){
  if(ms<=0) return "00:00";
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60);
  const r = s % 60;
  return String(m).padStart(2,'0')+":"+String(r).padStart(2,'0');
}
function renderOrder(){
  const statusEl = document.getElementById("orderStatus");
  const timerEl  = document.getElementById("orderTimer");
  const qEl = document.getElementById("orderQty");
  const aEl = document.getElementById("orderAmount");
  const btnEdit = document.getElementById("btnOrderEdit");
  const btnPack = document.getElementById("btnOrderPack");
  const btnShip = document.getElementById("btnOrderShip");
  const btnCash = document.getElementById("btnOrderCash");

  if(!statusEl) return; // not on this screen yet
  if(!state.firm){
    statusEl.textContent = "‚Äî";
    timerEl.textContent = "‚Äî";
    [btnEdit,btnPack,btnShip,btnCash].forEach(b=> b && (b.disabled=true));
    if(qEl) qEl.disabled = true;
    if(aEl) aEl.disabled = true;
    return;
  }
  ensureOrder();
  const o = state.firm.order;
  // inputs locked while not idle/completed
  const inputsLocked = !(o.status==="idle" || o.status==="completed");
  if(qEl) { if(o.status==="idle"||o.status==="completed"){} qEl.disabled = inputsLocked; }
  if(aEl) { aEl.disabled = inputsLocked; }
  // status text
  statusEl.textContent = ORDER_STATUS_TEXT[o.status] || "‚Äî";
  // timers
  let showTimer = "‚Äî";
  const now = Date.now();
  if(o.status==="packaging"){
    const left = (o.packagingEndAt||0) - now;
    showTimer = msToMMSS(left);
    if(left<=0){
      // packaging done: enable shipping
      showTimer = "00:00";
    }
  }else if(o.status==="inTransit"){
    const left = (o.deliveryEndAt||0) - now;
    showTimer = msToMMSS(left);
    if(left<=0){
      showTimer = "00:00";
    }
  }else{
    showTimer = "‚Äî";
  }
  timerEl.textContent = showTimer;

  // enablement
  btnEdit.disabled = !(o.status==="idle" || o.status==="completed");
  const canPack = (o.status==="editing");
  btnPack.disabled = !canPack;
  const canShip = (o.status==="packaging") && (Date.now() >= (o.packagingEndAt||0));
  btnShip.disabled = !canShip;
  const canCash = (o.status==="inTransit") && (Date.now() >= (o.deliveryEndAt||0));
  btnCash.disabled = !canCash;
}
function startOrderTicker(){
  if(orderTicker) return;
  orderTicker = setInterval(()=>{
    renderOrder();
  }, 1000);
}
async function orderEdit(){
  if(!state.firm) return alert("Unternehmen gr√ºnden zuerst.");
  ensureOrder();
  const qEl = document.getElementById("orderQty");
  const aEl = document.getElementById("orderAmount");
  const qty = Math.max(1, parseInt((qEl?.value||"1"),10));
  const amount = Math.max(1, parseFloat((aEl?.value||"1000")));
  if(state.firm.goods.stored < qty) return alert("Nicht genug gelagerte Ware.");
  state.firm.goods.stored -= qty;
  state.firm.order = { qty, amount, status:"editing", packagingEndAt:null, deliveryEndAt:null };
  await push({ firm: state.firm });
  renderGoods(); renderOrder();
  toast(`Reserviert: ${qty} Stk f√ºr Bestellung`);
}
async function orderPack(){
  if(!state.firm) return;
  ensureOrder();
  const o = state.firm.order;
  if(o.status!=="editing") return toast("Erst Bestellung bearbeiten.");
  o.packagingEndAt = Date.now() + 60_000;
  o.status = "packaging";
  await push({ firm: state.firm });
  renderOrder();
  toast("Verpackung gestartet (1 Minute)");
}
async function orderShip(){
  if(!state.firm) return;
  ensureOrder();
  const o = state.firm.order;
  if(o.status!=="packaging") return toast("Erst verpacken.");
  if(Date.now() < (o.packagingEndAt||0)) return toast("Verpackung noch nicht fertig.");
  o.deliveryEndAt = Date.now() + 120_000;
  o.status = "inTransit";
  await push({ firm: state.firm });
  renderOrder();
  toast("Bestellung unterwegs (2 Minuten)");
}
async function orderCash(){
  if(!state.firm) return;
  ensureOrder();
  const o = state.firm.order;
  if(o.status!=="inTransit") return toast("Noch unterwegs.");
  if(Date.now() < (o.deliveryEndAt||0)) return toast("Noch nicht zugestellt.");
  state.firm.cash = (state.firm.cash||0) + (o.amount||0);
  o.status = "completed";
  o.packagingEndAt = null; o.deliveryEndAt = null;
  await push({ firm: state.firm });
  renderFirm(); renderOrder();
  toast("Abkassiert: "+fmt(o.amount||0));
}


/* ========== J. Jump (Endless Runner) ========== */
function ensureJJump(){
  if(!state.jjump){
    state.jjump = {
      owned: { black:true, green:false, blue:false, red:false, gold:false },
      selected: 'black',
      leaderboard: []
    };
  }
}
const JJ_COLORS = { black:'#111', green:'#1db954', blue:'#1d4ed8', red:'#dc2626', gold:'#b45309' };
function renderJJump(){
  ensureJJump();
  try{ renderCostsPanel(); }catch(_){}
  const sel = document.getElementById('jjCharSelect');
  if(sel){
    sel.innerHTML = Object.keys(state.jjump.owned)
      .filter(k=> state.jjump.owned[k])
      .map(k=> `<option value="${k}" ${state.jjump.selected===k?'selected':''}>${labelForChar(k)}</option>`)
      .join('');
  }
  const lab = document.getElementById('jjCharLabel');
  if(lab) lab.textContent = labelForChar(state.jjump.selected);
  const board = document.getElementById('jjBoard');
  if(board){
    const rows = (state.jjump.leaderboard||[]).slice(0,10).map((e,i)=>{
      const d = new Date(e.ts||Date.now()).toLocaleDateString('de-DE');
      return `<li><strong>${e.score}</strong> Pkt ‚Äì ${e.name||'Player'} <span class="muted">(${d})</span></li>`;
    }).join('');
    board.innerHTML = rows || '<li class="muted">Noch keine Eintr√§ge.</li>';
  }
  renderJJumpShop();
}
function labelForChar(k){
  return {black:'Schwarz', green:'Gr√ºn', blue:'Blau', red:'Rot', gold:'Gold'}[k]||k;
}
function priceForChar(k){
  if(k==='gold') return 20000;
  if(k==='black') return 0;
  return 10000;
}
function renderJJumpShop(){
  ensureJJump();
  try{ renderCostsPanel(); }catch(_){}
  const root = document.getElementById('jjShop'); if(!root) return;
  const order = ['black','green','blue','red','gold'];
  root.innerHTML = order.map(k=>{
    const owned = !!state.jjump.owned[k];
    const price = priceForChar(k);
    const disabled = owned || (k==='black');
    return `<button class="btn ghost xs charBuy" data-k="${k}" ${disabled?'disabled':''} title="${owned?'Geh√∂rt dir':''}">
      <div style="width:16px; height:16px; border-radius:50%; background:${JJ_COLORS[k]}; box-shadow:inset 0 0 0 2px rgba(0,0,0,.1)"></div>
      ${labelForChar(k)} ${price>0?('¬∑ '+fmt(price)):'¬∑ Standard'}
    </button>`;
  }).join('');
  root.querySelectorAll('.charBuy').forEach(btn=>{
    btn.addEventListener('click', async()=>{
      const k = btn.dataset.k;
      const price = priceForChar(k);
      if(state.cash < price) return alert('Nicht genug Bargeld.');
      state.cash -= price; state.jjump.owned[k] = true;
      await push({ cash: state.cash, jjump: state.jjump });
      renderAccount(); renderJJump(); toast(labelForChar(k)+' gekauft');
    });
  });
}

let jjRunning=false, jjRAF=null, jjLast=0, jjSpeed=6, jjScore=0, jjStartTs=0, jjNextMilestone=0;
let jjPlayer, jjObstacles=[], jjBg=[], jjWeather='clear', jjNextWeatherAt=0, jjTimeOfDay=0;

function jjReset(){
  const canvas = document.getElementById('jjCanvas'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  jjSpeed = 6;
  jjScore = 0;
  jjStartTs = performance.now();
  jjNextMilestone = jjStartTs + 30000;
  jjLast = jjStartTs;
  jjObstacles = [];
  jjBg = initBackground(canvas);
  jjWeather = 'clear';
  jjNextWeatherAt = jjStartTs + 20000 + Math.random()*20000;
  jjTimeOfDay = 0;
  jjPlayer = {
    x: 70, y: 0, w: 18, h: 36, vy: 0, onGround: true,
    color: JJ_COLORS[state.jjump.selected] || '#111'
  };
  jjPlayer.y = groundY(canvas) - jjPlayer.h;
  updateJJHUD();
  drawJJ(ctx, canvas);
}

function groundY(canvas){ return canvas.height - 30; }
function initBackground(canvas){
  const trees = Array.from({length:8}, ()=>({x:Math.random()*canvas.width, h:40+Math.random()*40, w:12+Math.random()*10}));
  const clouds = Array.from({length:5}, ()=>({x:Math.random()*canvas.width, y:20+Math.random()*60, r:12+Math.random()*12}));
  return {trees, clouds, rain:[]};
}

function spawnObstacle(canvas){
  const size = 16 + Math.floor(Math.random()*18);
  jjObstacles.push({ x: canvas.width + 10, y: groundY(canvas) - size, w: size, h: size });
  if(jjObstacles.length>12) jjObstacles.shift();
}

function maybeSpawn(canvas, now){
  const interval = Math.max(350, 1400 - jjSpeed*80);
  if(!maybeSpawn.next) maybeSpawn.next = now + 800;
  if(now >= maybeSpawn.next){
    spawnObstacle(canvas);
    maybeSpawn.next = now + interval * (0.6 + Math.random()*0.8);
  }
}

function jjJump(){
  if(!jjRunning) return;
  if(jjPlayer.onGround){
    jjPlayer.vy = -10.5;
    jjPlayer.onGround = false;
  }
}
function jjKey(e){ if(e.code==='Space'){ e.preventDefault(); jjJump(); } }
function jjTap(){ jjJump(); }

function stepJJ(now){
  const canvas = document.getElementById('jjCanvas'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const dt = Math.min(40, now - jjLast); jjLast = now;

  if(now >= jjNextMilestone){
    jjSpeed += 1.5;
    jjNextMilestone += 30000;
    state.cash += 2000; saveLocal(); renderAccount(); toast('+2.000 ‚Ç¨ durch J. Jump');
  }

  if(now >= jjNextWeatherAt){
    jjWeather = (jjWeather==='clear') ? 'rain' : 'clear';
    jjNextWeatherAt = now + 20000 + Math.random()*25000;
  }

  jjTimeOfDay += dt/120000; if(jjTimeOfDay>1) jjTimeOfDay-=1;

  const g = 0.55;
  jjPlayer.vy += g;
  jjPlayer.y += jjPlayer.vy;
  const gy = groundY(canvas);
  if(jjPlayer.y >= gy - jjPlayer.h){ jjPlayer.y = gy - jjPlayer.h; jjPlayer.vy = 0; jjPlayer.onGround = true; }

  maybeSpawn(canvas, now);
  jjObstacles.forEach(o=> o.x -= jjSpeed);
  jjObstacles = jjObstacles.filter(o=> o.x + o.w > -10);

  for(const o of jjObstacles){
    if(jjPlayer.x < o.x + o.w && jjPlayer.x + jjPlayer.w > o.x && jjPlayer.y < o.y + o.h && jjPlayer.y + jjPlayer.h > o.y){
      return jjGameOver();
    }
  }

  jjScore += Math.floor(jjSpeed);
  updateJJHUD();

  drawJJ(ctx, canvas);

  if(jjRunning){ jjRAF = requestAnimationFrame(stepJJ); }
}

function updateJJHUD(){
  const elapsed = Math.max(0, Math.floor((jjLast - jjStartTs)/1000));
  document.getElementById('jjScore').textContent = jjScore;
  document.getElementById('jjSpeed').textContent = jjSpeed.toFixed(1);
  const m = Math.floor(elapsed/60).toString().padStart(2,'0');
  const s = (elapsed%60).toString().padStart(2,'0');
  document.getElementById('jjTime').textContent = m+':'+s;
}

function bgColor(){
  const t = jjTimeOfDay;
  const mix = (a,b,p)=> Math.round(a + (b-a)*p);
  function hex(c){ return c.toString(16).padStart(2,'0'); }
  const day=[207,232,255], night=[11,19,36];
  const p = (Math.sin((t*2*Math.PI)-Math.PI/2)+1)/2;
  const r=mix(day[0],night[0],p), g=mix(day[1],night[1],p), b=mix(day[2],night[2],p);
  return '#'+hex(r)+hex(g)+hex(b);
}

function drawJJ(ctx, canvas){
  ctx.fillStyle = bgColor(); ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = '#2c3e50'; ctx.fillRect(0, groundY(canvas), canvas.width, 3);
  ctx.fillStyle = 'rgba(0,0,0,.08)'; ctx.fillRect(0, groundY(canvas)+3, canvas.width, 10);

  ctx.fillStyle = '#1f3f2b';
  jjBg.trees.forEach(t=>{ t.x -= jjSpeed*0.25; if(t.x < -t.w) t.x = canvas.width + Math.random()*80;
    ctx.fillRect(t.x, groundY(canvas)-t.h, t.w, t.h);
  });

  ctx.fillStyle = 'rgba(255,255,255,.9)';
  jjBg.clouds.forEach(c=>{ c.x -= jjSpeed*0.15; if(c.x < -c.r*2) c.x = canvas.width + Math.random()*40;
    ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill();
  });

  if(jjWeather==='rain'){
    if(!jjBg.rain || jjBg.rain.length<120){
      jjBg.rain = Array.from({length:120}, ()=>({x:Math.random()*canvas.width, y:Math.random()*canvas.height}));
    }
    ctx.strokeStyle = 'rgba(255,255,255,.6)'; ctx.lineWidth = 1;
    jjBg.rain.forEach(r=>{ r.y += 8; r.x -= 2; if(r.y>canvas.height) { r.y= -10; r.x=Math.random()*canvas.width; }
      ctx.beginPath(); ctx.moveTo(r.x, r.y); ctx.lineTo(r.x+2, r.y+6); ctx.stroke();
    });
  }

  ctx.fillStyle = jjPlayer.color;
  ctx.fillRect(jjPlayer.x, jjPlayer.y, jjPlayer.w, jjPlayer.h);
  ctx.beginPath(); ctx.arc(jjPlayer.x + jjPlayer.w/2, jjPlayer.y-8, 7, 0, Math.PI*2); ctx.fill();

  ctx.fillStyle = '#8b5e3c';
  jjObstacles.forEach(o=>{
    ctx.fillRect(o.x, o.y, o.w, o.h);
    ctx.strokeStyle = 'rgba(0,0,0,.25)'; ctx.strokeRect(o.x+0.5, o.y+0.5, o.w-1, o.h-1);
  });
}

async function jjGameOver(){
  jjRunning=false; cancelAnimationFrame(jjRAF); jjRAF=null;
  ensureJJump();
  try{ renderCostsPanel(); }catch(_){}
  state.jjump.leaderboard.push({ name: state.name||'Player', score: jjScore, ts: Date.now() });
  state.jjump.leaderboard.sort((a,b)=> b.score - a.score);
  await push({ jjump: state.jjump });
  renderJJump();
  document.getElementById('jjStart').disabled = false;
  document.getElementById('jjStop').disabled = true;
  toast('Game Over ‚Äì Punkte: '+jjScore);
}

async function jjStartGame(){
  if(state.cash < 100) return alert('Nicht genug Bargeld (100‚Ç¨ Einsatz).');
  ensureJJump();
  try{ renderCostsPanel(); }catch(_){}
  state.cash -= 100; await push({ cash: state.cash });
  renderAccount();
  jjReset();
  jjRunning = true;
  document.getElementById('jjStart').disabled = true;
  document.getElementById('jjStop').disabled = false;
  window.addEventListener('keydown', jjKey);
  const canvas = document.getElementById('jjCanvas'); canvas.addEventListener('pointerdown', jjTap);
  jjRAF = requestAnimationFrame(stepJJ);
}

function jjStopGame(){
  jjRunning=false; cancelAnimationFrame(jjRAF); jjRAF=null;
  document.getElementById('jjStart').disabled = false;
  document.getElementById('jjStop').disabled = true;
  window.removeEventListener('keydown', jjKey);
  const canvas = document.getElementById('jjCanvas'); canvas.removeEventListener('pointerdown', jjTap);
}

/* ========== Slots ========== */
const SYMS=["üçí","üçã","üçÄ","‚≠ê","üîî","7Ô∏è‚É£"]; const rndSym=()=>SYMS[Math.floor(Math.random()*SYMS.length)];
async function spin(){
  const betRaw=parseInt($("#slotBet").value||"1",10); const bet=Math.max(1, Math.min(100, betRaw)); $("#slotBet").value=bet;
  if(state.cash<bet) return alert("Nicht genug Bargeld.");
  const cells=$$("#slotGrid .slot-cell");
  for(let r=0;r<10;r++){ cells.forEach(c=> c.textContent=rndSym()); await sleep(40+r*10) }
  const grid=[]; for(let i=0;i<9;i++){ const s=rndSym(); grid.push(s); cells[i].textContent=s }
  if(!localOnly){ await setDoc(jackpotRef, { value: increment(bet) }, {merge:true}); }
  const lines=[[0,1,2],[3,4,5],[6,7,8]]; let linesWin=0;
  for(const L of lines){ const [a,b,c]=L.map(i=>grid[i]); if(a===b && b===c){ linesWin++; } }
  let cash = state.cash - bet;
  const full = grid.every(s=> s===grid[0]);
  if(full){
    let jackpot=0;
    if(localOnly){
      const localJack = parseInt(localStorage.getItem("fb_v41_jackpot")||"0",10);
      jackpot = localJack; localStorage.setItem("fb_v41_jackpot","0");
    }else{
      try{
        await runTransaction(db, async(tx)=>{
          const snap = await tx.get(jackpotRef);
          const cur = (snap.exists()? (snap.data().value||0):0);
          jackpot = cur;
          tx.set(jackpotRef, { value: 0 }, { merge:true });
        });
      }catch(e){ console.warn("jackpot tx fail", e); }
    }
    cash += jackpot;
    await push({ cash }); renderAccount();
    toast("Vollbild! Jackpot: "+fmt(jackpot));
    return;
  }
  if(linesWin>0){
    const payout = bet * Math.pow(2, linesWin); // 2√ó per line
    cash += payout;
  }
  await push({ cash }); renderAccount();
  toast(linesWin>0? ("Gewinn: "+fmt(cash - (state.cash - bet))) : "Leider nix");
}

/* ========== Immobilien ========== */
function renderHouses(){
  const root=$("#houseList"); root.innerHTML="";
  state.houses.forEach(h=>{
    const div=document.createElement("div"); div.className="panel";
    div.innerHTML=`
      <div class="row"><strong>${h.name}</strong><span class="right muted">${fmt(h.price)} ¬∑ Miete ${fmt(h.rent)}/Tag</span></div>
      <div class="row" style="margin-top:6px">
        <button class="btn ghost xs" data-id="${h.id}" ${h.owned?"disabled":""}>${h.owned?"‚úÖ Gekauft":"Kaufen"}</button>
      </div>
    `;
    div.querySelector("button").addEventListener("click", ()=> buyHouse(h.id));
    root.appendChild(div);
  });
}
async function buyHouse(id){
  const h=state.houses.find(x=>x.id===id); if(!h) return; const b=state.bank; const balances=Object.assign({}, state.balances);
  if(balances[b]<h.price) return alert("Nicht genug Kontoguthaben.");
  balances[b]-=h.price; h.owned=true; await push({ balances, houses: state.houses }); renderHouses(); renderAccount(); toast("Gekauft: "+h.name);
}
async function claimDailyRent(){
  const today=todayKey(); if(state.lastRentClaimDate===today) return toast("Mieten heute schon kassiert");
  const b=state.bank; if(!b) return alert("Zuerst Bank w√§hlen.");
  const income = state.houses.filter(h=>h.owned).reduce((sum,h)=>sum+h.rent,0);
  if(income<=0) return toast("Keine Eigent√ºmer‚ÄëMieten");
  const balances=Object.assign({}, state.balances); balances[b]+=income;
  await push({ balances, lastRentClaimDate: today }); renderAccount(); toast("Miete kassiert: "+fmt(income));
}

/* ========== Messenger ========== */
function setupChat(){ if(localOnly){ renderMsgs([{name:"System", text:"Willkommen bei Friends Bank v4.1!"}]); return; }
  const ref=collection(db,"friendsbank_global_chat"); onSnapshot(ref, snap=>{ const msgs=[]; snap.forEach(d=>{ const v=d.data(); msgs.push({name:v.name, text:v.text, ts:v.ts?.toMillis?.()||Date.now(), uid:v.uid}); });
    msgs.sort((a,b)=>a.ts-b.ts); renderMsgs(msgs); }); }
function renderMsgs(msgs){ const root=$("#msgList"); root.innerHTML=""; msgs.forEach(m=>{ const el=document.createElement("div");
  el.innerHTML=`<div class="stat"><strong>${m.name||"User"}:</strong> ${m.text}</div>`; root.appendChild(el); }); root.scrollTop=root.scrollHeight; }
$("#btnSend").addEventListener("click", async()=>{ const text=$("#msgInput").value.trim(); if(!text) return; $("#msgInput").value="";
  const name=state.name||"User"; if(localOnly){ const root=$("#msgList"); const el=document.createElement("div"); el.innerHTML=`<div class="stat"><strong>${name}:</strong> ${text}</div>`; root.appendChild(el); root.scrollTop=root.scrollHeight; }
  else{ await addDoc(collection(db,"friendsbank_global_chat"), { text, uid, name, ts: serverTimestamp() }); } });

/* ========== Render All ========== */
function renderAll(){ renderAccount(); renderStocks(); renderFirm(); renderGoods(); renderHouses(); renderOrder(); renderJJump(); }

/* ========== Initial save ========== */
if(!localStorage.getItem(lsKey)){ saveLocal(); }

/* ===== Mod Men√º ===== */
let modOpen = false;
function toggleMod(open){
  const ov = document.getElementById('modOverlay');
  modOpen = open!=null ? open : !modOpen;
  if(!ov) return;
  ov.style.display = modOpen ? 'block' : 'none';
  ov.setAttribute('aria-hidden', modOpen?'false':'true');
}
document.addEventListener('keydown', (e)=>{
  // Ctrl + Alt + # (DE layout -> '#')
  if(e.ctrlKey && e.altKey && (e.key === '#' || e.code === 'Digit3')){
    e.preventDefault();
    toggleMod();
  }
});
$("#modClose").addEventListener("click", ()=> toggleMod(false));

// Tabs
Array.from(document.querySelectorAll('#modPanel .mnav .btn')).forEach(b=>{
  b.addEventListener('click', ()=>{
    const tab = b.dataset.modtab;
    Array.from(document.querySelectorAll('#modPanel .section')).forEach(s=> s.classList.remove('active'));
    $("#mod-"+tab).classList.add('active');
  });
});

// Money ops
async function modApplyMoney(sign){
  const target = $("#modMoneyTarget").value;    // user or firm
  const kind   = $("#modMoneyKind").value;      // cash or bank
  const amt    = Math.max(0, parseFloat($("#modMoneyAmount").value||0));
  if(!amt) return;
  if(target==='user'){
    if(kind==='cash'){ state.cash = (state.cash||0) + sign*amt; await push({cash: state.cash}); renderAccount(); }
    else { state.bank = (state.bank||0) + sign*amt; await push({bank: state.bank}); renderAccount(); }
  }else{
    if(!state.firm){ alert('Keine Firma vorhanden.'); return; }
    if(kind==='cash'){ state.firm.cash = (state.firm.cash||0) + sign*amt; }
    else { state.firm.bank = (state.firm.bank||0) + sign*amt; }
    await push({ firm: state.firm }); renderFirm();
  }
  toast((sign>0?'+':'-')+fmt(amt)+' gesetzt.');
}
$("#modMoneyAdd").addEventListener("click", ()=> modApplyMoney(+1));
$("#modMoneySub").addEventListener("click", ()=> modApplyMoney(-1));

// Timer reset (Job)
async function modResetJob(){
  // try to reset any job cooldown flags used in the app
  // We'll clear nextJobAt or similar custom fields
  if(state.job){ delete state.job.nextAt; delete state.job.cooldown; }
  // also clear any local limit flags commonly used
  localStorage.removeItem('jobNextAt');
  await push({ job: state.job||null });
  toast('Job-Timer zur√ºckgesetzt.');
}
$("#modResetJobTimer").addEventListener("click", modResetJob);

// Online Spieler (simple view based on cloud "presence")
async function modRenderOnline(){
  const box = $("#modOnlineList"); if(!box) return;
  box.innerHTML = '<div class="muted">Lade‚Ä¶</div>';
  try{
    // fetch presence from your existing cloud structure if available
    // Fallback: show only current user as "online".
    const users = state.online?.list || [{ id: state.uid||'me', name: state.name||'Ich', cash: state.cash||0, bank: state.bank||0 }];
    box.innerHTML = users.map((u,i)=> `
      <div class="row">
        <div>
          <div><strong>${u.name||('User '+(i+1))}</strong> <span class="muted">(${u.id||''})</span></div>
          <div class="muted">Bar: ${fmt(u.cash||0)} ¬∑ Bank: ${fmt(u.bank||0)}</div>
        </div>
        <div>
          <input type="number" class="u-cash" data-id="${u.id}" value="${u.cash||0}" style="width:100px" />
          <input type="number" class="u-bank" data-id="${u.id}" value="${u.bank||0}" style="width:100px" />
          <button class="btn xs setUser" data-id="${u.id}">Setzen</button>
        </div>
      </div>`).join('');
    box.querySelectorAll('.setUser').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.dataset.id;
        const cashEl = box.querySelector(`.u-cash[data-id="${id}"]`);
        const bankEl = box.querySelector(`.u-bank[data-id="${id}"]`);
        const cash = parseFloat(cashEl.value||0);
        const bank = parseFloat(bankEl.value||0);
        if(id=== (state.uid||'me')){
          state.cash = cash; state.bank = bank; await push({cash: state.cash, bank: state.bank}); renderAccount();
        }else{
          // Placeholder: in a real multi-user setup, you'd write to that user's node
          toast('Nur Demo: fremde Nutzer nicht verbunden.');
        }
        toast('Werte gesetzt.');
      });
    });
  }catch(e){
    box.innerHTML = '<div class="muted">Keine Online-Daten.</div>';
  }
}
const modOnlineObserver = new MutationObserver(()=>{
  if($('#mod-online').classList.contains('active')) modRenderOnline();
});
modOnlineObserver.observe(document.getElementById('modPanel'), { attributes:true, subtree:true, attributeFilter:['class'] });

// Reset actions
$("#modResetMine").addEventListener("click", async ()=>{
  if(!confirm('Meinen Account lokal zur√ºcksetzen?')) return;
  const keep = { uid: state.uid, name: state.name };
  Object.keys(state).forEach(k=> delete state[k]);
  state.uid = keep.uid; state.name = keep.name;
  await push(state);
  saveLocal();
  await syncFromCloud();
  ensureJJump();
  try{ renderCostsPanel(); }catch(_){}
  renderAll();
  toast('Account zur√ºckgesetzt.');
});

$("#modResetAll").addEventListener("click", async ()=>{
  if(!confirm('ALLE lokalen Daten wirklich l√∂schen?')) return;
  localStorage.clear();
  toast('Lokale Daten gel√∂scht. Seite neu laden empfohlen.');
});

// Re-render Money tab values when opening
const modOpenObs = new MutationObserver(()=>{
  if(modOpen){
    // nothing extra for now
  }
});
modOpenObs.observe(document.getElementById('modOverlay'), { attributes:true, attributeFilter:['style'] });


/* ===== Mod Men√º Lock (PIN) ===== */
const MOD_PIN = "140318";
const MOD_UNLOCK_MINUTES = 15;
function isModUnlocked(){
  const until = +localStorage.getItem('modUnlockedUntil') || 0;
  return Date.now() < until;
}
function setModUnlock(minutes){
  const until = Date.now() + minutes*60*1000;
  localStorage.setItem('modUnlockedUntil', String(until));
}
function clearModUnlock(){
  localStorage.removeItem('modUnlockedUntil');
}
function showPinPrompt(show=true){
  const el = document.getElementById('modPin');
  el.style.display = show ? 'grid' : 'none';
  el.setAttribute('aria-hidden', show?'false':'true');
  if(show){
    const input = document.getElementById('modPinInput');
    input.value = "";
    setTimeout(()=> input.focus(), 50);
  }
}

document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.altKey && (e.key === '#' || e.code === 'Digit3')){
    e.preventDefault();
    if(isModUnlocked()){
      toggleMod();
    }else{
      showPinPrompt(true);
    }
  }
});

$("#modPinCancel").addEventListener("click", ()=> showPinPrompt(false));
$("#modPinOk").addEventListener("click", ()=>{
  const v = (document.getElementById('modPinInput').value||"").trim();
  if(v === MOD_PIN){
    setModUnlock(MOD_UNLOCK_MINUTES);
    showPinPrompt(false);
    toggleMod(true);
    toast('Mod-Men√º entsperrt.');
  }else{
    toast('Falscher Code.', 'bad');
  }
});

// Also allow Enter key in PIN input
document.getElementById('modPinInput').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    $("#modPinOk").click();
  }
});

// Lock button inside Mod Panel
$("#modLock").addEventListener("click", ()=>{
  clearModUnlock();
  toggleMod(false);
  toast('Mod-Men√º gesperrt.');
});


/* ==== Mod Hotkey Guard ==== */
(function(){
  if(!window.__modHotkeyBound){
    window.__modHotkeyBound = true;
    document.addEventListener('keydown', (e)=>{
      // Allow ESC to close overlay
      if(e.key === 'Escape' && document.getElementById('modOverlay')?.style.display==='block'){
        e.preventDefault(); toggleMod(false); return;
      }
      // Ctrl + Alt + #
      if(e.ctrlKey && e.altKey && (e.key === '#' || e.code === 'Digit3')){
        e.preventDefault();
        if(typeof isModUnlocked === 'function' ? isModUnlocked() : true){
          toggleMod();
        }else{
          if(typeof showPinPrompt === 'function') showPinPrompt(true);
        }
      }
    }, {capture:true});
  }
})();


// ==== Mod Costs Config ====
function getCostsConfig(){
  const cfg = state.config && state.config.costs ? state.config.costs : null;
  if(cfg) return cfg;
  // fallback to localStorage if present
  try{
    const fromLS = JSON.parse(localStorage.getItem('modCosts')||'{}');
    if(fromLS && (fromLS.firmCost||fromLS.startCash)){
      state.config = state.config || {}; state.config.costs = fromLS;
      return fromLS;
    }
  }catch(_){}
  return { firmCost: 100000, startCash: 10000 };
}
async function saveCostsConfig(cfg){
  state.config = state.config || {};
  state.config.costs = cfg;
  localStorage.setItem('modCosts', JSON.stringify(cfg));
  await push({ config: state.config });
  toast('Kosten/Startwerte gespeichert.');
}
function renderCostsPanel(){
  const cfg = getCostsConfig();
  const c1 = document.getElementById('modCostFirm');
  const c2 = document.getElementById('modStartCash');
  if(c1) c1.value = cfg.firmCost;
  if(c2) c2.value = cfg.startCash;
}
document.getElementById('modSaveCosts').addEventListener('click', async ()=>{
  const firmCost = Math.max(0, parseInt(document.getElementById('modCostFirm').value||'0',10));
  const startCash = Math.max(0, parseInt(document.getElementById('modStartCash').value||'0',10));
  await saveCostsConfig({ firmCost, startCash });
});

// Update costs panel when opened
const costsTabWatcher = new MutationObserver(()=>{
  if(document.getElementById('mod-costs')?.classList.contains('active')){
    renderCostsPanel();
  }
});
costsTabWatcher.observe(document.getElementById('modPanel'), { attributes:true, subtree:true, attributeFilter:['class'] });

</script>

<!-- MOD MENU OVERLAY -->
<div id="modOverlay" aria-hidden="true">
  <div id="modPanel">
    <button id="modClose" class="btn bad xs">Schlie√üen</button> <button id="modLock" class="btn warn xs" style="margin-left:6px">Sperren</button>
    <h2>Mod Men√º</h2>
    <div class="mnav">
      <button class="btn xs" data-modtab="money">Money</button>
      <button class="btn xs" data-modtab="timer">Timer Reset</button>
      <button class="btn xs" data-modtab="online">Online Spieler</button>
      <button class="btn xs" data-modtab="resetall">Alles zur√ºcksetzen</button>
      <button class="btn xs" data-modtab="costs">Kosten & Startwerte</button>
    </div>

    <div id="mod-money" class="section active">
      <div class="row">
        <label>Ziel</label>
        <select id="modMoneyTarget" class="btn xs">
          <option value="user">Mein Konto (Bar oder Bank)</option>
          <option value="firm">Firmenkonto</option>
        </select>
      </div>
      <div class="row">
        <label>Art</label>
        <select id="modMoneyKind" class="btn xs">
          <option value="cash">Bargeld</option>
          <option value="bank">Bankkonto</option>
        </select>
      </div>
      <div class="row">
        <label>Betrag (‚Ç¨)</label><input id="modMoneyAmount" type="number" step="1" value="10000"/>
        <button id="modMoneyAdd" class="btn ok xs">Geld geben</button>
        <button id="modMoneySub" class="btn warn xs">Geld abziehen</button>
      </div>
      <small class="muted">Achtung: √Ñnderungen werden sofort gespeichert.</small>
    </div>

    <div id="mod-timer" class="section">
      <div class="row">
        <button id="modResetJobTimer" class="btn ok xs">Job-Timer zur√ºcksetzen</button>
      </div>
      <small class="muted">Setzt Limits zur√ºck, damit du den Job sofort wieder starten kannst.</small>
    </div>

    <div id="mod-online" class="section">
      <div class="list" id="modOnlineList"></div>
      <small class="muted">Zeigt alle aktuell synchronisierten Nutzer mit Kontost√§nden. (Editierbar)</small>
    </div>

    <div id="mod-resetall" class="section">
      <div class="row">
        <button id="modResetMine" class="btn warn xs">Meinen Account zur√ºcksetzen</button>
        <button id="modResetAll" class="btn bad xs">Alles zur√ºcksetzen</button>
      </div>
      <small class="muted">‚ÄûAlles zur√ºcksetzen‚Äú l√∂scht lokale Daten. Vorsicht!</small>
    
    <div id="mod-costs" class="section">
      <div class="row">
        <label>Kosten Firmengr√ºndung (‚Ç¨)</label>
        <input id="modCostFirm" type="number" step="1000" value="100000"/>
      </div>
      <div class="row">
        <label>Startgeld Firmenkasse (‚Ç¨)</label>
        <input id="modStartCash" type="number" step="1000" value="10000"/>
      </div>
      <div class="row">
        <button id="modSaveCosts" class="btn ok xs">Speichern</button>
      </div>
      <small class="muted">Wirkt bei der n√§chsten Firmengr√ºndung.</small>
    </div>

  </div>
</div>


<!-- MOD PIN PROMPT -->
<div id="modPin" aria-hidden="true">
  <div class="box">
    <h3>Mod-Men√º entsperren</h3>
    <p class="muted" style="margin-top:0">Bitte Code eingeben, um das Mod-Men√º zu √∂ffnen.</p>
    <input id="modPinInput" type="password" inputmode="numeric" placeholder="Code (6-stellig)" maxlength="6"/>
    <div class="row">
      <button id="modPinCancel" class="btn xs">Abbrechen</button>
      <button id="modPinOk" class="btn ok xs">Entsperren</button>
    
    <div id="mod-costs" class="section">
      <div class="row">
        <label>Kosten Firmengr√ºndung (‚Ç¨)</label>
        <input id="modCostFirm" type="number" step="1000" value="100000"/>
      </div>
      <div class="row">
        <label>Startgeld Firmenkasse (‚Ç¨)</label>
        <input id="modStartCash" type="number" step="1000" value="10000"/>
      </div>
      <div class="row">
        <button id="modSaveCosts" class="btn ok xs">Speichern</button>
      </div>
      <small class="muted">Wirkt bei der n√§chsten Firmengr√ºndung.</small>
    </div>

  </div>
</div>

</body>
</html>
