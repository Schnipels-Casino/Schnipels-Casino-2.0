<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>Friends Bank ‚Äì Mobile v3.3 (Bright + Auth + CSGO Case)</title>
  <meta name="theme-color" content="#ffffff">
  <style>
    :root{
      --bg:#f6f8fc; --card:#ffffff; --muted:#566074; --text:#0f1624;
      --accent:#2dd36f; --accent2:#2563eb; --danger:#e11d48; --warn:#f59e0b;
      --outline:#e4e8f1; --pill:#eff3f9; --win:#16a34a; --loss:#dc2626;
      --shadow:0 8px 28px rgba(15,22,36,.08);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;font-size:17px;line-height:1.5;letter-spacing:.2px;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    .hidden{display:none!important}
    .row{display:flex;gap:.8rem;align-items:center}
    .col{display:flex;flex-direction:column;gap:.8rem}
    .between{justify-content:space-between}
    .center{justify-content:center;align-items:center}
    .container{max-width:880px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .btn{background:var(--pill);border:1px solid var(--outline);padding:1rem 1.15rem;border-radius:14px;min-width:48px;min-height:48px;font-weight:800;color:var(--text);cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.primary{background:var(--accent);color:#052010;border-color:#129454}
    .btn.warn{background:var(--warn);color:#231a00;border-color:#b07404}
    .btn.danger{background:#f43f5e;color:#2b0d0d;border-color:#d11a44}
    input,select{width:100%;background:#f2f5fb;color:var(--text);border:1px solid var(--outline);border-radius:12px;padding:1rem 1rem;font-size:18px}
    label{font-size:1rem;color:#24324a;font-weight:800}
    small{color:var(--muted);font-size:.98rem}
    ::placeholder{color:#6b7280;opacity:.9}
    .topbar{position:sticky;top:0;z-index:50;background:#ffffffee;border-bottom:1px solid var(--outline);padding:.6rem .9rem;backdrop-filter:saturate(1.3) blur(6px);box-shadow:0 6px 18px rgba(15,22,36,.06)}
    .top-grid{display:grid;grid-template-columns:110px 1fr 160px;gap:.6rem;align-items:center}
    .circle{width:48px;height:48px;border-radius:999px;background:var(--pill);border:1px solid var(--outline);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;cursor:pointer}
    #screen{padding:14px;display:flex;flex-direction:column;gap:14px;padding-bottom:110px}
    .tabs{display:flex;gap:.6rem}
    .tab{flex:1;padding:.9rem;border:1px solid var(--outline);background:var(--pill);border-radius:12px;text-align:center;font-weight:900;cursor:pointer}
    .tab.active{background:var(--accent2);color:#fff;border-color:#1e4fd5}
    .section-title{font-size:1.2rem;font-weight:1000}
    .strip{display:flex;gap:.6rem;overflow:auto;padding-bottom:.2rem}
    .grid2{display:grid;grid-template-columns:1fr;gap:.8rem}
    .grid3{display:grid;grid-template-columns:1fr;gap:.8rem}
    .gridAuto{display:grid;grid-template-columns:1fr;gap:.8rem}
    @media (min-width:720px){.grid2{grid-template-columns:1fr 1fr}.grid3{grid-template-columns:repeat(3,1fr)}.gridAuto{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}}
    .toast{position:fixed;bottom:14px;left:0;right:0;margin:auto;max-width:560px;padding:1rem 1.1rem;border-radius:12px;background:#0f1624;color:#fff;border:1px solid #1f2a40;box-shadow:0 10px 30px rgba(15,22,36,.25);text-align:center}
    .modal{position:fixed;inset:0;background:rgba(15,22,36,.4);display:none;align-items:flex-end}
    .sheet{background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;width:100%;max-height:88vh;overflow:auto;border-top:1px solid var(--outline);box-shadow:0 -10px 24px rgba(15,22,36,.08)}
    .sheet .handle{width:54px;height:6px;background:#d9deea;border-radius:100px;margin:10px auto}
    .chat-bubble{padding:.7rem .9rem;border-radius:12px;border:1px solid var(--outline);max-width:85%;background:#f7faff}
    .mine{background:#e5ffe5;border-color:#c7f3c7}
    .slot-grid{display:grid;grid-template-columns:repeat(3,74px);grid-auto-rows:74px;gap:10px;justify-content:center;align-content:center}
    .slot-cell{display:flex;align-items:center;justify-content:center;border:2px solid var(--outline);border-radius:12px;background:#f2f6ff;font-size:30px;transition:transform .12s;box-shadow:var(--shadow)}
    .slot-cell.spin{transform:scale(1.05)}
    footer.nav{position:fixed;left:0;right:0;bottom:0;padding:.6rem;background:#ffffffee;border-top:1px solid var(--outline);display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem;backdrop-filter:saturate(1.2) blur(6px)}
    .bank-choice .btn{border-width:2px}
    .bank-choice .btn.active{background:#e8f7ff;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.18) inset}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="top-grid">
        <div class="row" style="gap:.6rem">
          <div id="btnBank" class="circle" title="Bank w√§hlen">üí∂</div>
          <div class="col">
            <div style="font-weight:1000;font-size:1.05rem" id="bankLabel">Keine Bank gew√§hlt</div>
            <small class="money" id="acctBalance">‚Äî</small>
          </div>
        </div>
        <div class="center">
          <button id="btnChat" class="btn" style="padding:.65rem 1rem;">üí¨ Chat</button>
        </div>
        <div class="row" style="gap:.5rem;justify-content:flex-end">
          <div class="col" style="align-items:flex-end">
            <div class="small" style="opacity:.9">Bargeld</div>
            <div id="cashLabel" class="money" style="font-size:1.05rem">‚Ç¨0</div>
          </div>
          <div id="btnSlots" class="circle" title="Slots">üé∞</div>
          <div id="btnHouse" class="circle" title="H√§user">üè†</div>
        </div>
      </div>
    </div>
  </div>

  <main id="screen" class="container">
    <div id="welcome" class="card">
      <div class="section-title">Willkommen üëã</div>
      <p>Tippe links oben auf <b>üí∂</b>, w√§hle deine Bank & logge dich mit <b>Name + Passwort</b> ein.</p>
      <div class="grid2">
        <div class="card">
          <div class="section-title">T√§gliches Bonusgeld</div>
          <p>Jede Bank zahlt <b>‚Ç¨500 / Tag</b>. Startguthaben: <b>‚Ç¨1.500</b>.</p>
          <button id="btnClaimDaily" class="btn primary">‚Ç¨500 jetzt abholen</button>
        </div>
        <div class="card">
          <div class="section-title">Leihen & Kredit</div>
          <ul style="margin:.2rem 0 .2rem 1rem">
            <li>Leihen: <b>‚Ç¨1.000/Tag</b>, max. <b>‚Ç¨10.000</b>, <b>10% Zinsen</b>.</li>
            <li>Kredit: bis <b>‚Ç¨100.000</b>, mind. <b>‚Ç¨1.000/Tag</b> R√ºckzahlung.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="bankArea" class="card">
      <div class="section-title">Dein Konto</div>
      <div class="grid2">
        <div class="card">
          <div class="row between"><div>Kontostand</div><div class="money" id="bankBalance">‚Ç¨0</div></div>
          <div class="row between"><div>Leihe offen</div><div class="money" id="loanOutstanding">‚Ç¨0</div></div>
          <div class="row between"><div>Kredit offen</div><div class="money" id="creditOutstanding">‚Ç¨0</div></div>
        </div>
        <div class="card">
          <div class="row between"><div>Aktienkurs <span id="stockBankName" class="small"></span></div><div class="ticker" id="stockPrice">‚Äî</div></div>
          <div class="row between"><div>Deine Anteile</div><div id="userShares">0</div></div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="section-title">Ein-/Auszahlen</div>
          <label>Betrag (‚Ç¨)</label>
          <input id="ioAmount" type="number" inputmode="numeric" min="1" placeholder="z.B. 50">
          <div class="row strip">
            <button class="btn" data-quick="20">+20</button>
            <button class="btn" data-quick="50">+50</button>
            <button class="btn" data-quick="100">+100</button>
            <button class="btn" data-quick="500">+500</button>
          </div>
          <div class="row grid2">
            <button id="btnDeposit" class="btn primary">Einzahlen ‚ûú</button>
            <button id="btnWithdraw" class="btn">‚¨Ö Auszahlen</button>
          </div>
          <small>Bargeld wird oben rechts angezeigt.</small>
        </div>
        <div class="card">
          <div class="section-title">Leihen & Kredit</div>
          <div class="row grid2">
            <button id="btnBorrow1000" class="btn">Leihen ‚Ç¨1.000</button>
            <button id="btnRepayLoan1000" class="btn">Leih-R√ºckzahlung ‚Ç¨1.000</button>
          </div>
          <div class="row grid2" style="margin-top:.4rem">
            <button id="btnTakeCredit" class="btn warn">Kredit nehmen</button>
            <button id="btnRepayCredit1000" class="btn">Kredit -‚Ç¨1.000</button>
          </div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="section-title">Aktien handeln</div>
          <label>Menge (St√ºck)</label>
          <input id="sharesQty" type="number" min="1" step="1" placeholder="z.B. 10">
          <div class="row grid2">
            <button id="btnBuyShares" class="btn primary">Kaufen</button>
            <button id="btnSellShares" class="btn">Verkaufen</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Bank-Fonds</div>
          <div class="row between"><div>Bankverm√∂gen</div><div id="bankFunds" class="money">‚Äî</div></div>
          <small>Start: ‚Ç¨1.000.000.000. Eins√§tze erh√∂hen, Auszahlungen senken es.</small>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Verlauf</div>
        <div id="feed" class="mono" style="max-height:38vh;overflow:auto"></div>
      </div>
    </div>

    <div id="slotsArea" class="card hidden">
      <div class="section-title">Slots üé∞</div>
      <small>Eins√§tze: 5 / 10 / 30 / 50 / 80 / 100 ‚Ç¨ (vom Bargeld)</small>
      <div class="card">
        <div class="row between"><div class="section-title">High or Lower</div><div id="hlStatus"></div></div>
        <div class="grid3 center" style="gap:10px">
          <div class="card center" style="height:96px"><div id="hlDealer" class="section-title">üÇ†</div></div>
          <div class="card center" style="height:96px"><div id="hlYou" class="section-title">?</div></div>
          <div class="col">
            <select id="stakeHL"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
            <div class="row">
              <button id="btnHigher" class="btn" style="flex:1">H√∂her</button>
              <button id="btnLower"  class="btn" style="flex:1">Niedriger</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row between"><div class="section-title">Kopf oder Zahl</div><div id="cfStatus"></div></div>
        <div class="grid3 center" style="gap:10px">
          <div class="card center" style="height:96px"><div id="cfResult" class="section-title">ü™ô</div></div>
          <div class="col">
            <select id="stakeCF"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
            <select id="cfPick"><option value="kopf">Kopf</option><option value="zahl">Zahl</option></select>
          </div>
          <button id="btnCF" class="btn">Spielen</button>
        </div>
      </div>

      <div class="card">
        <div class="row between"><div class="section-title">Triple Chance</div><div id="tcStatus"></div></div>
        <div class="center" style="margin:.4rem 0">
          <div class="slot-grid" id="slotGrid">
            <div class="slot-cell">üçã</div><div class="slot-cell">üçí</div><div class="slot-cell">üçá</div>
            <div class="slot-cell">üçÄ</div><div class="slot-cell">‚≠ê</div><div class="slot-cell">üîî</div>
            <div class="slot-cell">7Ô∏è‚É£</div><div class="slot-cell">üçâ</div><div class="slot-cell">üçã</div>
          </div>
        </div>
        <div class="row center" style="gap:.6rem">
          <select id="stakeTC"><option>5</option><option>10</option><option>30</option><option>50</option><option>80</option><option>100</option></select>
          <button id="btnSpin" class="btn">Spin</button>
          <button id="btnAuto10" class="btn">Auto x10</button>
        </div>
      </div>

      <!-- CSGO CASE: Kauf & √ñffnen -->
      <div class="card">
        <div class="row between">
          <div class="section-title">CS:GO Kiste</div>
          <small>ID: <code id="caseId">case_csg_001</code></small>
        </div>

        <div class="row between" style="gap:.6rem">
          <div><small>Preis</small><br><b>‚Ç¨<span id="casePrice">50</span></b></div>
          <div><small>Deine Kisten</small><br><b id="caseOwned">0</b></div>
          <div class="row" style="gap:.6rem">
            <button id="btnBuyCase"  class="btn">Kiste kaufen</button>
            <button id="btnOpenCase" class="btn primary">Kiste √∂ffnen</button>
          </div>
        </div>

        <details style="margin-top:.5rem">
          <summary>Drop-Chancen & Gewinne</summary>
          <ul style="margin:.4rem 0 .2rem 1rem" id="caseTable"></ul>
        </details>

        <small id="caseResult"></small>
      </div>
    </div>

    <div id="houseArea" class="card hidden">
      <div class="section-title">H√§user & Mieten üè†</div>
      <div class="gridAuto" id="houseList"></div>
      <div class="row between">
        <button id="btnCollectRent" class="btn primary">Tagesmieten einsammeln</button>
        <small id="rentInfo"></small>
      </div>
    </div>

    <div id="chatArea" class="card hidden">
      <div class="row tabs">
        <div id="tabGlobal" class="tab active">Global</div>
        <div id="tabPrivate" class="tab">Privat</div>
      </div>
      <div id="chatGlobal" class="col">
        <div id="globalList" style="max-height:38vh;overflow:auto"></div>
        <div class="row"><input id="globalMsg" placeholder="Nachricht an alle‚Ä¶"><button id="sendGlobal" class="btn primary">Senden</button></div>
      </div>
      <div id="chatPrivate" class="col hidden">
        <div class="row"><input id="pmTo" placeholder="Empf√§nger (Name)"></div>
        <div id="privateList" style="max-height:38vh;overflow:auto"></div>
        <div class="row"><input id="privateMsg" placeholder="Deine private Nachricht‚Ä¶"><button id="sendPrivate" class="btn primary">Senden</button></div>
      </div>
    </div>
  </main>

  <footer class="nav">
    <div class="container" style="display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem">
      <button id="navBank"  class="btn">üí∂ Bank</button>
      <button id="navSlots" class="btn">üé∞ Slots</button>
      <button id="navHouse" class="btn">üè† H√§user</button>
      <button id="navChat"  class="btn">üí¨ Chat</button>
    </div>
  </footer>

  <!-- Bank Sheet -->
  <div id="sheetBank" class="modal">
    <div class="sheet">
      <div class="handle"></div>
      <div class="container" style="padding:10px 12px 18px">
        <div class="card bank-choice">
          <div class="section-title">Bank w√§hlen</div>
          <p>W√§hle genau <b>eine</b> Bank f√ºr dein Konto. Pro Name ist nur eine Bank erlaubt.</p>
          <div class="grid2">
            <button class="btn" data-bank="VR-Bank">VR-Bank</button>
            <button class="btn" data-bank="Deutsche Bank">Deutsche Bank</button>
            <button class="btn" data-bank="Sparkasse">Sparkasse</button>
            <button class="btn" data-bank="Postbank">Postbank</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Login / Registrierung</div>
          <label>Name</label><input id="loginName" placeholder="z.B. Julian">
          <label>Passwort</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          <div class="row between" style="gap:.6rem">
            <button id="btnLogin" class="btn primary" style="flex:1">Einloggen / Konto anlegen</button>
            <button id="btnLogout" class="btn danger" style="flex:1">Abmelden</button>
          </div>
          <small id="loginHint">Startguthaben: ‚Ç¨1.500. T√§glicher Bonus: ‚Ç¨500.</small>
        </div>
        <div class="center" style="padding:10px"><button id="closeBank" class="btn">Schlie√üen</button></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, orderBy, limit, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDN1MZv_q38Zoymt92BHWTe9sUNwteT1KA", authDomain: "sample-firebase-ai-app-b02a4.firebaseapp.com", projectId: "sample-firebase-ai-app-b02a4", storageBucket: "sample-firebase-ai-app-b02a4.firebasestorage.app", messagingSenderId: "382050648468", appId: "1:382050648468:web:8c6f34051a7b2991ebcf81" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const EUR = n => "‚Ç¨" + (Math.round(n*100)/100).toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const todayDE = () => new Date().toLocaleDateString("de-DE",{ timeZone:"Europe/Berlin" });
    const hash = async (s)=>{ const enc = new TextEncoder().encode(s); const buf = await crypto.subtle.digest("SHA-256", enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16),0).join(""); };
    const showToast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"), 2400); };
    const logFeed = async (txt)=>{ $("#feed").prepend(document.createTextNode("‚Ä¢ "+txt+"\n")); if (state.userDoc) await addDoc(collection(db, "users", state.userDoc.id, "feed"), { txt, at: serverTimestamp() }); };
    const state = { bank:null, user:null, userDoc:null, bankDoc:null, listeners:[], tcRunning:false, authed:false };

    // ---------- AUTH (anonymous) ----------
    const auth = getAuth(app);
    let authUser = null;
    async function ensureAuth(){
      if (state.authed) return authUser;
      try{
        await setPersistence(auth, browserLocalPersistence);
        if (!auth.currentUser) await signInAnonymously(auth);
        await new Promise((resolve)=> onAuthStateChanged(auth, (u)=>{ authUser=u; state.authed=!!u; resolve(); }));
        return authUser;
      }catch(e){ console.error(e); showToast("Auth-Fehler: "+(e?.message||"")); }
    }
    ensureAuth();

    // ---------- UI refs ----------
    const bankSheet = $("#sheetBank"), bankLabel=$("#bankLabel"), bankBalance=$("#bankBalance"), cashLabel=$("#cashLabel"), acctBalance=$("#acctBalance"), stockPriceEl=$("#stockPrice"), stockBankName=$("#stockBankName"), bankFundsEl=$("#bankFunds"), userSharesEl=$("#userShares");
    const openSheet = ()=> bankSheet.style.display = "flex";
    const closeSheet = ()=> bankSheet.style.display = "none";
    $("#btnBank").onclick = openSheet; $("#closeBank").onclick = closeSheet;
    setTimeout(()=>showToast("Tipp: Tippe links oben auf üí∂, um deine Bank zu w√§hlen."), 600);

    // Bank choice
    $$("#sheetBank [data-bank]").forEach(btn=>{
      btn.onclick = async ()=>{
        $$("#sheetBank [data-bank]").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        state.bank = btn.dataset.bank;
        bankLabel.textContent = state.bank;
        stockBankName.textContent = "("+state.bank+")";
        $("#loginHint").textContent = "Ausgew√§hlt: "+state.bank+" ‚Äì Startguthaben: ‚Ç¨1.500, Bonus: ‚Ç¨500/Tag.";
        await ensureAuth();
        await ensureBankDoc();
        await ensureTicker();
      };
    });

    // Login
    $("#btnLogin").onclick = async ()=>{
      const name = $("#loginName").value.trim();
      const pass = $("#loginPass").value;
      if (!state.bank){ showToast("Bitte zuerst eine Bank w√§hlen."); return; }
      if (name.length<2 || pass.length<3){ showToast("Name/Passwort zu kurz."); return; }

      const btn = $("#btnLogin"); btn.disabled = true; const oldTxt = btn.textContent; btn.textContent = "Bitte warten‚Ä¶";
      try{
        await ensureAuth();
        const uname = name.toLowerCase();
        const passHash = await hash(pass);

        const idxRef = doc(db, "users_index", uname);
        const idxSnap = await getDoc(idxRef);
        if (idxSnap.exists() && idxSnap.data().bank !== state.bank){
          showToast(`Name bereits in ${idxSnap.data().bank} registriert. Verwende einen anderen Namen oder melde dich dort an.`);
          return;
        }

        const userId = `${state.bank.replaceAll(" ","")}_${uname}`;
        const userRef = doc(db, "users", userId);
        const snap = await getDoc(userRef);

        if (!snap.exists()){
          const init = { bank: state.bank, name, passHash, createdAt: serverTimestamp(), bankBalance: 1500, cash: 0, lastDaily: "", lastBorrow: "", loanOutstanding: 0, creditOutstanding: 0, lastRent: "", shares: 0 };
          await setDoc(userRef, init);
          await setDoc(idxRef, { bank: state.bank, uid: userId });
          showToast("Konto erstellt. Willkommen!");
        }else{
          const data = snap.data();
          if (data.passHash !== passHash){ showToast("Falsches Passwort."); return; }
        }
        await attachUser(userRef);
        closeSheet();
        await logFeed("Angemeldet bei "+state.bank+".");
      }catch(err){ console.error(err); showToast("Login-Fehler: "+(err?.message||"Unbekannt")); }
      finally{ btn.disabled = false; btn.textContent = oldTxt; }
    };

    // Logout / Konto wechseln
    $("#btnLogout").onclick = ()=>{
      state.listeners.forEach(u=>u()); state.listeners=[];
      state.user = null; state.userDoc = null;
      $("#bankBalance").textContent = "‚Ç¨0";
      $("#loanOutstanding").textContent = "‚Ç¨0";
      $("#creditOutstanding").textContent = "‚Ç¨0";
      $("#userShares").textContent = "0";
      $("#rentInfo").textContent = "";
      $("#feed").textContent = "";
      showToast("Abgemeldet. Du kannst nun eine (andere) Bank und einen neuen Namen w√§hlen.");
      openSheet();
    };

    async function attachUser(userRef){
      state.listeners.forEach(u=>u()); state.listeners=[];
      state.userDoc = userRef;
      const unsub = onSnapshot(userRef, (d)=>{
        const u = d.data(); if (!u) return;
        state.user = { id:d.id, ...u };
        bankBalance.textContent = EUR(u.bankBalance||0);
        acctBalance.textContent = state.bank ? (state.bank+" ‚Ä¢ "+EUR(u.bankBalance||0)) : "‚Äî";
        cashLabel.textContent = EUR(u.cash||0);
        $("#loanOutstanding").textContent = EUR(u.loanOutstanding||0);
        $("#creditOutstanding").textContent = EUR(u.creditOutstanding||0);
        userSharesEl.textContent = (u.shares||0);
        $("#rentInfo").textContent = u.lastRent ? ("Letzte Miete: "+u.lastRent) : "Noch keine Miete kassiert";
        renderHouses(u);
        // <<< Neu: Kisten-Bestand live spiegeln
        updateCaseOwned(u);
      });
      state.listeners.push(unsub);
      await ensureBankDoc(); await ensureTicker(); await loadFeed(); await attachChat();
    }

    async function ensureBankDoc(){
      if (!state.bank) return;
      await ensureAuth();
      const id = state.bank.replaceAll(" ","");
      const bRef = doc(db, "banks", id);
      const snap = await getDoc(bRef);
      if (!snap.exists()){
        await setDoc(bRef, { name: state.bank, funds: 1_000_000_000, stockPrice: 100, lastStockUpdate: Date.now() });
      }
      state.bankDoc = bRef;
      const unsub = onSnapshot(bRef, (d)=>{
        const b = d.data(); if (!b) return;
        bankFundsEl.textContent = EUR(b.funds||0);
        stockPriceEl.textContent = EUR(b.stockPrice||0);
      });
      state.listeners.push(unsub);
    }

    async function ensureTicker(){
      if (!state.bankDoc) return;
      await ensureAuth();
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(state.bankDoc);
          const b = snap.data(); if (!b) return;
          const now = Date.now();
          if ((now - (b.lastStockUpdate||0)) < 12000) return;
          const dir = Math.random()<.5?-1:1;
          const pct = (0.004 + Math.random()*0.008) * dir;
          const next = Math.max(5, Math.round(b.stockPrice * (1+pct)*100)/100);
          tx.update(state.bankDoc, { stockPrice: next, lastStockUpdate: now });
        });
      }catch(e){ /* ignore */ }
    }
    setInterval(ensureTicker, 12_500);

    async function loadFeed(){
      if (!state.userDoc) return;
      const q = query(collection(db, "users", state.userDoc.id, "feed"), orderBy("at","desc"), limit(50));
      onSnapshot(q, (qs)=>{
        const el = $("#feed"); el.textContent = "";
        qs.forEach(doc=> el.append("‚Ä¢ "+doc.data().txt+"\n") );
      });
    }

    $$("#ioAmount ~ .strip .btn").forEach(b=> b.onclick = ()=>{
      const v = Number($("#ioAmount").value||0) + Number(b.dataset.quick||0);
      $("#ioAmount").value = v;
    });

    async function txUpdate(cb){ await ensureAuth(); return await runTransaction(db, cb); }

    $("#btnDeposit").onclick = async ()=>{
      try{
        if (!state.userDoc) return openSheet();
        const amount = Number($("#ioAmount").value||0); if (amount<=0) return;
        await txUpdate(async(tx)=>{
          const u = await tx.get(state.userDoc); const ud = u.data();
          if ((ud.cash||0) < amount) throw new Error("Zu wenig Bargeld.");
          tx.update(state.userDoc, { cash: (ud.cash||0)-amount, bankBalance: (ud.bankBalance||0)+amount });
        });
        showToast("Einzahlung: "+EUR(amount)); await logFeed("Einzahlung "+EUR(amount)); $("#ioAmount").value="";
      }catch(e){ showToast(e.message||"Fehler"); }
    };
    $("#btnWithdraw").onclick = async ()=>{
      try{
        if (!state.userDoc) return openSheet();
        const amount = Number($("#ioAmount").value||0); if (amount<=0) return;
        await txUpdate(async(tx)=>{
          const u = await tx.get(state.userDoc); const ud = u.data();
          if ((ud.bankBalance||0) < amount) throw new Error("Zu wenig Guthaben.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-amount, cash:(ud.cash||0)+amount });
        });
        showToast("Auszahlung: "+EUR(amount)); await logFeed("Auszahlung "+EUR(amount)+" (Bargeld erh√∂ht)"); $("#ioAmount").value="";
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnClaimDaily").onclick = async ()=>{
      if (!state.userDoc){ openSheet(); return; }
      try{
        await ensureAuth();
        const today = todayDE();
        const uSnap = await getDoc(state.userDoc);
        const u = uSnap.data();
        if (u.lastDaily === today){ showToast("Heute schon abgeholt."); return; }
        await updateDoc(state.userDoc, { bankBalance: (u.bankBalance||0)+500, lastDaily: today });
        await logFeed("Tagesbonus +‚Ç¨500"); showToast("Tagesbonus +‚Ç¨500");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnBorrow1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const today = todayDE();
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if (ud.lastBorrow === today) throw new Error("Heute schon geliehen.");
          if ((ud.loanOutstanding||0) >= 10_000) throw new Error("Leih-Limit erreicht (10.000‚Ç¨).");
          const fee = 100;
          const newLoan = (ud.loanOutstanding||0) + 1000 + fee;
          tx.update(state.userDoc, { loanOutstanding: newLoan, bankBalance: (ud.bankBalance||0) + 1000, lastBorrow: today });
          tx.update(state.bankDoc, { funds: (bd.funds||0) + fee });
        });
        await logFeed("Leihe +‚Ç¨1.000 (10% Geb√ºhr)"); showToast("Leihe +‚Ç¨1.000 (Geb√ºhr ‚Ç¨100)");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnRepayLoan1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.loanOutstanding||0) <= 0) throw new Error("Keine Leihe offen.");
          if ((ud.bankBalance||0) < 1000) throw new Error("Zu wenig Guthaben.");
          const repay = Math.min(1000, ud.loanOutstanding);
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0) - repay, loanOutstanding:(ud.loanOutstanding||0) - repay });
          tx.update(state.bankDoc, { funds:(bd.funds||0) + repay });
        });
        await logFeed("Leih-R√ºckzahlung -‚Ç¨1.000"); showToast("Leih-R√ºckzahlung -‚Ç¨1.000");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnTakeCredit").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const amt = Number(prompt("Kredit-Betrag (max. 100.000‚Ç¨):","10000")||0);
      if (!amt || amt<=0) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.creditOutstanding||0) + amt > 100_000) throw new Error("Kredit-Limit 100.000‚Ç¨.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+amt, creditOutstanding:(ud.creditOutstanding||0)+amt });
          tx.update(state.bankDoc, { funds:(bd.funds||0) - amt });
        });
        await logFeed("Kredit aufgenommen: "+EUR(amt)); showToast("Kredit aufgenommen: "+EUR(amt));
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnRepayCredit1000").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          if ((ud.creditOutstanding||0)<=0) throw new Error("Kein Kredit offen.");
          if ((ud.bankBalance||0) < 1000) throw new Error("Zu wenig Guthaben.");
          const pay = Math.min(1000, ud.creditOutstanding);
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-pay, creditOutstanding:(ud.creditOutstanding||0)-pay });
          tx.update(state.bankDoc, { funds:(bd.funds||0) + pay });
        });
        await logFeed("Kredit-R√ºckzahlung -‚Ç¨1.000"); showToast("Kredit-R√ºckzahlung -‚Ç¨1.000");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    $("#btnBuyShares").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const qty = Math.trunc(Number($("#sharesQty").value||0)); if (qty<=0) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          const price = b.data().stockPrice||100;
          const cost = Math.round(price*qty*100)/100;
          if ((ud.bankBalance||0) < cost) throw new Error("Zu wenig Guthaben.");
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)-cost, shares:(ud.shares||0)+qty });
          tx.update(state.bankDoc, { funds:(bd.funds||0)+cost });
        });
        await logFeed("Aktienkauf: +"+qty+" Stk."); showToast("Gekauft: "+qty+" Stk.");
      }catch(e){ showToast(e.message||"Fehler"); }
    };
    $("#btnSellShares").onclick = async ()=>{
      if (!state.userDoc) return openSheet();
      const qty = Math.trunc(Number($("#sharesQty").value||0)); if (qty<=0) return;
      try{
        await txUpdate(async (tx)=>{
          const u = await tx.get(state.userDoc); const b = await tx.get(state.bankDoc);
          const ud = u.data(); const bd = b.data();
          const price = b.data().stockPrice||100;
          if ((ud.shares||0) < qty) throw new Error("Nicht genug Anteile.");
          const proceeds = Math.round(price*qty*100)/100;
          tx.update(state.userDoc, { bankBalance:(ud.bankBalance||0)+proceeds, shares:(ud.shares||0)-qty });
          tx.update(state.bankDoc, { funds:(bd.funds||0)-proceeds });
        });
        await logFeed("Aktienverkauf: -"+qty+" Stk."); showToast("Verkauft: "+qty+" Stk.");
      }catch(e){ showToast(e.message||"Fehler"); }
    };

    const HOUSES = [
      { id:"h1", name:"Klein Familien Haus", price:50_000, rent:2_500 },
      { id:"h2", name:"Mittel Familien Haus", price:75_000, rent:4_000 },
      { id:"h3", name:"Gro√ü Familien Haus", price:100_000, rent:6_000 },
      { id:"h4", name:"Dubai Villa", price:450_000, rent:15_000 },
      { id:"h5", name:"Luxus Villa", price:1_000_000, rent:50_000 }
    ];
    function renderHouses(u){ const wrap=$("#houseList"); wrap.innerHTML=""; HOUSES.forEach(h=>{ const owned=(u && u["own_"+h.id])||0; const el=document.createElement("div"); el.className="card"; el.innerHTML=`<div class="section-title">${h.name}</div><div class="row between"><small>Preis</small><b>${EUR(h.price)}</b></div><div class="row between"><small>Miete/Tag</small><b>${EUR(h.rent)}</b></div><div class="row between"><small>Besitz</small><b>${owned}</b></div><div class="row grid2" style="margin-top:.4rem"><button class="btn" data-buy="${h.id}">Kaufen</button><button class="btn" data-sell="${h.id}" ${owned?"":"disabled"}>Verkaufen</button></div>`; wrap.appendChild(el); }); $$("#houseList [data-buy]").forEach(b=> b.onclick = ()=> buyHouse(b.dataset.buy)); $$("#houseList [data-sell]").forEach(b=> b.onclick = ()=> sellHouse(b.dataset.sell)); }
    async function buyHouse(hid){ if (!state.userDoc) return openSheet(); const h=HOUSES.find(x=>x.id===hid); if(!h) return; try{ await txUpdate(async(tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud.bankBalance||0)<h.price) throw new Error("Zu wenig Guthaben."); const patch={}; patch["own_"+hid]=(ud["own_"+hid]||0)+1; tx.update(state.userDoc, Object.assign(patch,{bankBalance:(ud.bankBalance||0)-h.price})); tx.update(state.bankDoc,{funds:(bd.funds||0)+h.price}); }); await logFeed("Gekauft: "+h.name+" f√ºr "+EUR(h.price)); showToast("Gekauft: "+h.name);}catch(e){ showToast(e.message||"Fehler"); }}
    async function sellHouse(hid){ if (!state.userDoc) return openSheet(); const h=HOUSES.find(x=>x.id===hid); if(!h) return; try{ await txUpdate(async(tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud["own_"+hid]||0)<=0) throw new Error("Kein Besitz."); const patch={}; patch["own_"+hid]=(ud["own_"+hid]||0)-1; const refund=Math.round(h.price*0.8); tx.update(state.userDoc, Object.assign(patch,{bankBalance:(ud.bankBalance||0)+refund})); tx.update(state.bankDoc,{funds:(bd.funds||0)-refund}); }); await logFeed("Verkauft: "+h.name+" f√ºr "+EUR(h.price*0.8)); showToast("Verkauft: "+h.name);}catch(e){ showToast(e.message||"Fehler"); }}

    const SYMBOLS = ["üçã","üçí","üçá","üçÄ","‚≠ê","üîî","7Ô∏è‚É£","üçâ"];
    const stakes = [5,10,30,50,80,100];
    function parseStake(selId){ return stakes.includes(Number($(selId).value)) ? Number($(selId).value) : 5; }
    async function spendCash(amount){ if (!state.userDoc) return openSheet(); await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); if((ud.cash||0)<amount) throw new Error("Zu wenig Bargeld. Bitte auszahlen."); tx.update(state.userDoc,{cash:(ud.cash||0)-amount}); tx.update(state.bankDoc,{funds:(bd.funds||0)+amount}); }); }
    async function payoutCash(amount){ if (!state.userDoc) return openSheet(); await txUpdate(async (tx)=>{ const u=await tx.get(state.userDoc); const b=await tx.get(state.bankDoc); const ud=u.data(); const bd=b.data(); tx.update(state.userDoc,{cash:(ud.cash||0)+amount}); tx.update(state.bankDoc,{funds:(bd.funds||0)-amount}); }); }

    let hlBusy=false;
    $("#btnHigher").onclick = ()=> playHL("higher");
    $("#btnLower").onclick  = ()=> playHL("lower");
    async function playHL(choice){
      if (hlBusy || !state.userDoc) { if (!state.userDoc) openSheet(); return; } hlBusy = true;
      const stake = parseStake("#stakeHL");
      try{
        await spendCash(stake);
        const dealer = 1+Math.floor(Math.random()*13);
        const you    = 1+Math.floor(Math.random()*13);
        $("#hlDealer").textContent = cardEmoji(dealer);
        $("#hlYou").textContent = cardEmoji(you);
        const win = choice==="higher" ? you>dealer : you<dealer;
        if (win){ await payoutCash(stake*2); $("#hlStatus").innerHTML = `<span style="color:var(--win)">Gewinn ${EUR(stake*2)}</span>`; await logFeed(`High/Lower Gewinn: ${EUR(stake)}`); }
        else    { $("#hlStatus").innerHTML = `<span style="color:var(--loss)">Verlust ${EUR(stake)}</span>`; await logFeed(`High/Lower Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#hlStatus").textContent="", 1500);
      }catch(e){ showToast(e.message||"Fehler"); }
      hlBusy=false;
    }
    function cardEmoji(v){ const faces = {1:"A",11:"J",12:"Q",13:"K"}; return "üÇ†"+(faces[v]||String(v)); }

    let cfBusy=false;
    $("#btnCF").onclick = async ()=>{
      if (cfBusy){ return; }
      if (!state.userDoc){ openSheet(); return; }
      cfBusy=true;
      const stake = parseStake("#stakeCF");
      try{
        await spendCash(stake);
        const pick = $("#cfPick").value;
        const res = Math.random()<.5?"kopf":"zahl";
        $("#cfResult").textContent = res==="kopf"?"üôÇ":"ü™ô";
        if (pick===res){ await payoutCash(stake*2); $("#cfStatus").innerHTML = `<span style="color:var(--win)">Gewinn ${EUR(stake*2)}</span>`; await logFeed(`Kopf/Zahl Gewinn: ${EUR(stake)}`); }
        else            { $("#cfStatus").innerHTML = `<span style="color:var(--loss)">Verlust ${EUR(stake)}</span>`; await logFeed(`Kopf/Zahl Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#cfStatus").textContent="", 1500);
      }catch(e){ showToast(e.message||"Fehler"); }
      cfBusy=false;
    };

    let tcBusy=false, tcLock=false;
    $("#btnSpin").onclick = ()=> spinOnce();
    $("#btnAuto10").onclick = async ()=>{
      if (tcBusy) return; if (!state.userDoc){ openSheet(); return; }
      tcBusy=true;
      for (let i=0;i<10;i++){ await spinOnce(true); await sleep(160); }
      tcBusy=false;
    };
    async function spinOnce(){
      if (!state.userDoc){ openSheet(); return; }
      if (tcLock) return; tcLock=true;
      const stake = parseStake("#stakeTC");
      try{
        await spendCash(stake);
        const grid = $("#slotGrid").children;
        const picks=[];
        for (let i=0;i<9;i++){ const sym = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]; picks.push(sym); }
        for (let i=0;i<9;i++){ grid[i].classList.add("spin"); grid[i].textContent = picks[i]; await sleep(45); grid[i].classList.remove("spin"); }
        const lines=[[0,1,2],[3,4,5],[6,7,8],[0,4,8],[6,4,2]];
        let wins=0; lines.forEach(L=>{ if (picks[L[0]]===picks[L[1]] && picks[L[1]]===picks[L[2]]) wins++; });
        if (wins>0){ const payout = stake*3*wins; await payoutCash(payout); $("#tcStatus").textContent = `Gewinn ${EUR(payout)} (${wins} Linie${wins>1?"n":""})`; await logFeed(`TripleChance Gewinn: ${EUR(payout)} (${wins} Linien)`); }
        else { $("#tcStatus").textContent = `Verlust ${EUR(stake)}`; await logFeed(`TripleChance Verlust: ${EUR(stake)}`); }
        setTimeout(()=>$("#tcStatus").textContent="", 1400);
      }catch(e){ showToast(e.message||"Fehler"); }
      tcLock=false;
    }

    function attachChat(){
      const qg = query(collection(db,"messages"), where("bank","==",state.bank), where("type","==","global"), orderBy("at","desc"), limit(50));
      onSnapshot(qg, (qs)=>{
        const box = $("#globalList"); box.innerHTML="";
        qs.forEach(d=>{ const m=d.data(); const div=document.createElement("div"); div.className="chat-bubble "+(m.from===state.user?.name?"mine":""); div.innerHTML=`<b>${m.from}</b><br>${m.text||""}`; box.appendChild(div); });
      });
      if (state.user){
        const qp = query(collection(db,"messages"), where("bank","==",state.bank), where("type","==","private"), orderBy("at","desc"), limit(50));
        onSnapshot(qp, (qs)=>{
          const box = $("#privateList"); box.innerHTML="";
          qs.forEach(d=>{ const m=d.data(); if (m.from===state.user.name || m.to===state.user.name){ const div=document.createElement("div"); div.className="chat-bubble "+(m.from===state.user?.name?"mine":""); div.innerHTML=`<b>${m.from} ‚ûú ${m.to}</b><br>${m.text||""}`; box.appendChild(div); } });
        });
      }
    }

    $("#sendGlobal").onclick = async ()=>{ const text=$("#globalMsg").value.trim(); if (!text) return; try{ if (!state.userDoc) return openSheet(); await ensureAuth(); await addDoc(collection(db,"messages"), { bank: state.bank, type:"global", text, from: state.user?.name||"?", at: serverTimestamp() }); $("#globalMsg").value=""; }catch(e){ showToast(e.message||"Fehler"); } };
    $("#sendPrivate").onclick = async ()=>{ const to=$("#pmTo").value.trim(); const text=$("#privateMsg").value.trim(); if (!to||!text) return; try{ if (!state.userDoc) return openSheet(); await ensureAuth(); await addDoc(collection(db,"messages"), { bank: state.bank, type:"private", to, text, from: state.user?.name||"?", at: serverTimestamp() }); $("#privateMsg").value=""; }catch(e){ showToast(e.message||"Fehler"); } };

    $("#tabGlobal").onclick = ()=>{ $("#tabGlobal").classList.add("active"); $("#tabPrivate").classList.remove("active"); $("#chatGlobal").classList.remove("hidden"); $("#chatPrivate").classList.add("hidden"); };
    $("#tabPrivate").onclick = ()=>{ $("#tabPrivate").classList.add("active"); $("#tabGlobal").classList.remove("active"); $("#chatPrivate").classList.remove("hidden"); $("#chatGlobal").classList.add("hidden"); };

    // ----------- FIX: area switch helper -----------
    function showArea(id){
      ["bankArea","slotsArea","houseArea","chatArea"].forEach(x=> $("#"+x).classList.add("hidden"));
      $("#"+id).classList.remove("hidden");
    }
    function requireLoginThen(areaId){
      if (!state.userDoc){ openSheet(); showToast("Bitte zuerst einloggen."); return; }
      showArea(areaId);
    }
    // footer nav
    $("#navBank").onclick  = ()=> showArea("bankArea");
    $("#navSlots").onclick = ()=> requireLoginThen("slotsArea");
    $("#navHouse").onclick = ()=> requireLoginThen("houseArea");
    $("#navChat").onclick  = ()=> requireLoginThen("chatArea");
    // topbar circles
    $("#btnSlots").onclick = ()=> requireLoginThen("slotsArea");
    $("#btnHouse").onclick = ()=> requireLoginThen("houseArea");
    $("#btnChat").onclick  = ()=> requireLoginThen("chatArea");

    renderHouses({});

    /* ===================== CSGO CASE (Kaufen & √ñffnen) ===================== */

    // Konstanten & Tabelle
    const CSGO_CASE_ID   = "case_csg_001";
    const CSGO_CASE_NAME = "CS:GO Kiste";
    const CSGO_CASE_PRICE = 50; // Einsatz aus Bargeld -> flie√üt in die Bank

    // Drop-Tabelle (Gewinn = Auszahlung an User aus der Bank)
    const CSGO_CASE_REWARDS = [
      { label: "Common",    payout: 10,  weight: 520 },  // 52.0%
      { label: "Uncommon",  payout: 25,  weight: 290 },  // 29.0%
      { label: "Rare",      payout: 60,  weight: 140 },  // 14.0%
      { label: "Epic",      payout: 150, weight: 45  },  // 4.5%
      { label: "Legendary", payout: 400, weight: 5   },  // 0.5%
    ];

    // Hilfen
    function weightedPick(items){
      const total = items.reduce((s,i)=>s+i.weight, 0);
      const r = Math.random()*total;
      let acc = 0;
      for (const it of items){ acc += it.weight; if (r <= acc) return it; }
      return items[items.length-1];
    }

    // UI initialisieren
    (function initCaseUI(){
      const priceEl = document.querySelector("#casePrice");
      const tableEl = document.querySelector("#caseTable");
      if (priceEl) priceEl.textContent = String(CSGO_CASE_PRICE);
      if (tableEl){
        tableEl.innerHTML = "";
        const denom = CSGO_CASE_REWARDS.reduce((s,i)=>s+i.weight,0);
        CSGO_CASE_REWARDS.forEach(r=>{
          const li = document.createElement("li");
          const pct = (r.weight / denom * 100).toFixed(2);
          li.textContent = `${r.label}: ${EUR(r.payout)} (${pct}%)`;
          tableEl.appendChild(li);
        });
      }
      const idEl = document.querySelector("#caseId");
      if (idEl) idEl.textContent = CSGO_CASE_ID;
    })();

    // Bestand spiegeln
    function updateCaseOwned(u){
      const ownedEl = document.querySelector("#caseOwned");
      if (!ownedEl) return;
      ownedEl.textContent = String(u?.["inv_"+CSGO_CASE_ID] || 0);
    }

    // Kiste kaufen: Bargeld -> Bank (spendCash), dann inv_case_xxx++
    async function buyCase(){
      if (!state.userDoc){ openSheet(); return; }
      try{
        await spendCash(CSGO_CASE_PRICE);
        await runTransaction(db, async (tx)=>{
          const u = await tx.get(state.userDoc);
          const ud = u.data() || {};
          const key = "inv_"+CSGO_CASE_ID;
          tx.update(state.userDoc, { [key]: (ud[key]||0) + 1 });
        });
        const u2 = (await getDoc(state.userDoc)).data();
        updateCaseOwned(u2);
        await logFeed(`Kiste gekauft (${CSGO_CASE_ID}) f√ºr ${EUR(CSGO_CASE_PRICE)}.`);
        showToast(`Gekauft: 1√ó ${CSGO_CASE_NAME}`);
      }catch(e){
        showToast(e?.message || "Fehler beim Kauf");
      }
    }

    // Kiste √∂ffnen: inv--, Drop ziehen, Gewinn an User aus Bank (payoutCash)
    async function openCase(){
      if (!state.userDoc){ openSheet(); return; }
      const resEl = document.querySelector("#caseResult");
      try{
        await runTransaction(db, async (tx)=>{
          const u = await tx.get(state.userDoc);
          const ud = u.data() || {};
          const key = "inv_"+CSGO_CASE_ID;
          const owned = ud[key]||0;
          if (owned <= 0) throw new Error("Keine Kiste vorhanden.");
          const patch = {}; patch[key] = owned - 1;
          tx.update(state.userDoc, patch);
        });

        const drop = weightedPick(CSGO_CASE_REWARDS);
        const payout = drop.payout;

        if (payout > 0){
          await payoutCash(payout);
          await logFeed(`CS:GO Kiste Gewinn: ${drop.label} (${EUR(payout)})`);
          if (resEl) resEl.innerHTML = `<b>Gewinn:</b> ${drop.label} ‚Ä¢ ${EUR(payout)}`;
          showToast(`Gewinn: ${drop.label} ‚Ä¢ ${EUR(payout)}`);
        }else{
          await logFeed(`CS:GO Kiste: kein Gewinn`);
          if (resEl) resEl.textContent = `Kein Gewinn`;
          showToast(`Kein Gewinn`);
        }

        const u2 = (await getDoc(state.userDoc)).data();
        updateCaseOwned(u2);
      }catch(e){
        showToast(e?.message || "Fehler beim √ñffnen");
      }
    }

    // Buttons binden
    const btnBuyCase  = document.querySelector("#btnBuyCase");
    const btnOpenCase = document.querySelector("#btnOpenCase");
    if (btnBuyCase)  btnBuyCase.onclick  = buyCase;
    if (btnOpenCase) btnOpenCase.onclick = openCase;

  </script>
</body>
</html>
